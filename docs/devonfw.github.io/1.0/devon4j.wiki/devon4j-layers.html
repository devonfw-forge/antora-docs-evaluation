<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Devonfw.github.io Docs</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">Devonfw.github.io Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="devonfw.github.io" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">devonfw.github.io</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../architecture-guidelines/1.0/index.html">Architecture-guidelines</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../architecture-guidelines/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../cicdgen/1.0/index.html">Cicdgen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../cicdgen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../cobigen/1.0/index.html">Cobigen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../cobigen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../dashboard/1.0/index.html">Dashboard</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../dashboard/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4j/1.0/index.html">Devon4j</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4j/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4net/1.0/index.html">Devon4net</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4net/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4ng/1.0/index.html">Devon4ng</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4ng/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4node/1.0/index.html">Devon4node</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4node/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4quarkus/1.0/index.html">Devon4quarkus</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4quarkus/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4ts/1.0/index.html">Devon4ts</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4ts/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">devonfw.github.io</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../getting-started/1.0/index.html">Getting-started</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../getting-started/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../github/1.0/index.html">Github</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../github/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../hangar/1.0/index.html">Hangar</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../hangar/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../ide/1.0/index.html">IDE</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../ide/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../jump-the-queue/1.0/index.html">Jump-the-queue</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../jump-the-queue/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../mrchecker/1.0/index.html">Mrchecker</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../mrchecker/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../my-thai-star/1.0/index.html">My-thai-star</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../my-thai-star/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../production-line/1.0/index.html">Production-line</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../production-line/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../shop-floor/1.0/index.html">Shop-floor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../shop-floor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../solicitor/1.0/index.html">Solicitor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../solicitor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../sonar-devon4j-plugin/1.0/index.html">Sonar-devon4j-plugin</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../sonar-devon4j-plugin/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/marvdan/devonfw.github.io/edit/developAntoraGhPage/docs/modules/ROOT/pages/devon4j.wiki/devon4j-layers.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="paragraph">
<p>==Layers</p>
</div>
<!-- toc disabled -->
<div class="paragraph">
<p>==Client Layer</p>
</div>
<div class="paragraph">
<p>There are various technical approaches to building GUI clients. The devonfw proposes rich clients that connect to the server via data-oriented services (e.g. using REST with JSON).
In general, we have to distinguish among the following types of clients:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>web clients</p>
</li>
<li>
<p>native desktop clients</p>
</li>
<li>
<p>(native) mobile clients</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Our main focus is on web-clients. In our sample application <a href="https://github.com/devonfw/my-thai-star/">my-thai-star</a> we offer a responsive web-client based on Angular following <a href="https://github.com/devonfw/devon4ng/">devon4ng</a> that integrates seamlessly with the back ends of my-thai-star available for Java using devon4j as well as .NET/C# using <a href="https://github.com/devonfw/devon4net/">devon4net</a>. For building angular clients read the separate <a href="https://github.com/devonfw/devon4ng/wiki">devon4ng guide</a>.</p>
</div>
<div class="sect3">
<h4 id="_javascript_for_java_developers"><a class="anchor" href="#_javascript_for_java_developers"></a>JavaScript for Java Developers</h4>
<div class="paragraph">
<p>In order to get started with client development as a Java developer we give you some hints to get started. Also if you are an experienced JavaScript developer and want to learn Java this can be helpful. First, you need to understand that the JavaScript ecosystem is as large as the Java ecosystem and developing a modern web client requires a lot of knowledge. The following table helps you as experienced developer to get an overview of the tools, configuration-files, and other related aspects from the new world to learn. Also it helps you to map concepts between the ecosystems. Please note that we list the tools recommended by devonfw here (and we know that there are alternatives not listed here such as gradle, grunt, bower, etc.).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Aspects in JavaScript and Java ecosystem</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Topic</strong></th>
<th class="tableblock halign-left valign-top"><strong>Aspect</strong></th>
<th class="tableblock halign-left valign-top"><strong>JavaScript</strong></th>
<th class="tableblock halign-left valign-top"><strong>Java</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Programming</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Language</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.typescriptlang.org/">TypeScript</a> (extends <a href="https://www.javascript.com/">JavaScript</a>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.oracle.com/javase/tutorial/">Java</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Runtime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://nodejs.org/">nodejs</a> (or web-browser)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.oracle.com/technetwork/java/javase/">jvm</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="5"><p class="tableblock">Build- &amp; Dependency-Management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/npm/npm">npm</a> or <a href="http://yarnpkg.com/">yarn</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://maven.apache.org/">maven</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Config</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.npmjs.com/files/package.json">package.json</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://maven.apache.org/pom.html">pom.xml</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repository</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.npmjs.com/">npm repo</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://repo.maven.apache.org/maven2">maven central</a> (<a href="https://mvnrepository.com/">repo search</a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Build cmd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="https://angular.io/cli">ng</a> build</code> or <code>npm run build</code> (goals are not standardized in npm)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mvn <a href="https://maven.apache.org/plugins/maven-install-plugin/usage.html">install</a> (see <a href="https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html">lifecycle</a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test cmd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="https://angular.io/cli">ng</a> test</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mvn <a href="http://maven.apache.org/components/surefire/maven-surefire-plugin/">test</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock"><a href="guide-testing">Testing</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test-Tool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://jasmine.github.io/">jasmine</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://junit.org/">junit</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test-Runner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://karma-runner.github.io/">karma</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://junit.org/">junit</a> / <a href="http://maven.apache.org/components/surefire/maven-surefire-plugin/">surefire</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">E2E Testing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.protractortest.org/">Protractor</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.seleniumhq.org/">Selenium</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Code Analysis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Code Coverage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="https://angular.io/guide/testing-code-coverage">ng test --no-watch --code-coverage</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.eclemma.org/jacoco/">JaCoCo</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock">Development</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IDE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://code.visualstudio.com/">MS VS Code</a> or <a href="https://www.jetbrains.com/idea/">IntelliJ</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://eclipse.org/downloads/">Eclipse</a> or <a href="https://www.jetbrains.com/idea/">IntelliJ</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Framework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://angularjs.org/">Angular</a> (etc.)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="spring">Spring</a> or <a href="quarkus">Quarkus</a></p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
<div class="paragraph">
<p>==Service Layer</p>
</div>
<div class="paragraph">
<p>The service layer is responsible for exposing functionality made available by the <a href="guide-logic-layer">logical layer</a> to external consumers over a network via <a href="#protocol">technical protocols</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_types_of_services"><a class="anchor" href="#_types_of_services"></a>Types of Services</h4>
<div class="paragraph">
<p>Before you start creating your services you should consider some general design aspects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do you want to create a <a href="https://en.wikipedia.org/wiki/Remote_procedure_call">RPC</a> service?</p>
</li>
<li>
<p>Or is your problem better addressed by messaging or eventing?</p>
</li>
<li>
<p>Who will consume your service?</p>
<div class="ulist">
<ul>
<li>
<p>Do you have one or multiple consumers?</p>
</li>
<li>
<p>Do web-browsers have to use your service?</p>
</li>
<li>
<p>Will apps from other vendors or parties have to consume your service that you can not influence if the service may have to change or be extended?</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For RPC a common choice is <a href="guide-rest">REST</a> but there are also interesting alternatives like <a href="https://grpc.io/">gRPC</a>. We also have a guide for <a href="guide-soap">SOAP</a> but this technology should rather be considered as legacy and is not recommended for new services.</p>
</div>
<div class="paragraph">
<p>When it comes to messaging in Java the typical answer will be <a href="guide-jms">JMS</a>. However, a very promising alternative is <a href="guide-kafka">Kafka</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_versioning"><a class="anchor" href="#_versioning"></a>Versioning</h4>
<div class="paragraph">
<p>For RPC services consumed by other applications we use versioning to prevent incompatibilities between applications when deploying updates. This is done by the following conventions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We define a version number and prefix it with <code>v</code> (e.g. <code>v1</code>).</p>
</li>
<li>
<p>If we support previous versions we use that version numbers as part of the Java package defining the service API (e.g. <code>com.foo.application.component.service.api.v1</code>)</p>
</li>
<li>
<p>We use the version number as part of the service name in the remote URL (e.g. <code><a href="https://application.foo.com/services/rest/component/v1/resource" class="bare">https://application.foo.com/services/rest/component/v1/resource</a></code>)</p>
</li>
<li>
<p>Whenever breaking changes are made to the API, create a separate version of the service and increment the version (e.g. <code>v1</code> &#8594; <code>v2</code>) . The implementations of the different versions of the service contain compatibility code and delegate to the same unversioned use-case of the logic layer whenever possible.</p>
</li>
<li>
<p>For maintenance and simplicity, avoid keeping more than one previous version.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_interoperability"><a class="anchor" href="#_interoperability"></a>Interoperability</h4>
<div class="paragraph">
<p>For services that are consumed by clients with different technology, <em>interoperability</em> is required. This is addressed by selecting the right protocol, following protocol-specific best practices and following our considerations especially <em>simplicity</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_service_considerations"><a class="anchor" href="#_service_considerations"></a>Service Considerations</h4>
<div class="paragraph">
<p>The term <em>service</em> is quite generic and therefore easily misunderstood. It is a unit exposing coherent functionality via a well-defined interface over a network. For the design of a service, we consider the following aspects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>self-contained</strong><br>
The entire API of the service shall be self-contained and have no dependencies on other parts of the application (other services, implementations, etc.).</p>
</li>
<li>
<p><strong>idempotence</strong><br>
E.g. creation of the same master-data entity has no effect (no error)</p>
</li>
<li>
<p><strong>loosely coupled</strong><br>
Service consumers have minimum knowledge and dependencies on the service provider.</p>
</li>
<li>
<p><strong>normalized</strong><br>
Complete, no redundancy, minimal</p>
</li>
<li>
<p><strong>coarse-grained</strong><br>
Service provides rather large operations (save entire entity or set of entities rather than individual attributes)</p>
</li>
<li>
<p><strong>atomic</strong><br>
Process individual entities (for processing large sets of data, use a <a href="guide-batch-layer">batch</a> instead of a service)</p>
</li>
<li>
<p><strong>simplicity</strong><br>
Avoid polymorphism, RPC methods with unique name per signature and no overloading, avoid attachments (consider separate download service), etc.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_security"><a class="anchor" href="#_security"></a>Security</h4>
<div class="paragraph">
<p>Your services are the major entry point to your application. Hence, security considerations are important here.</p>
</div>
<div class="paragraph">
<p>See <a href="guide-rest#security">REST Security</a>.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
<div class="paragraph">
<p>==Logic Layer</p>
</div>
<div class="paragraph">
<p>The logic layer is the heart of the application and contains the main business logic.
According to our <a href="architecture#business-architecture">business architecture</a>, we divide an application into <a href="guide-component">components</a>.
For each component, the logic layer defines different <a href="guide-usecase">use-cases</a>. Another approach is to define a <a href="guide-component-facade">component-facade</a>, which we do not recommend for future application. Especially for quarkus application, we want to simplify things and highly suggest omitting component-facade completely and using use-cases only.
It is very important that you follow the links to understand the concept of use-case in order to properly implement your business logic.</p>
</div>
</div>
<div class="sect3">
<h4 id="_responsibility"><a class="anchor" href="#_responsibility"></a>Responsibility</h4>
<div class="paragraph">
<p>The logic layer is responsible to implement the business logic according to the specified functional demands and requirements.
Therefore, it creates the actual value of the application. The logic layer is responsible for invoking business logic in external systems.
The following additional aspects are also included in its responsibility:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="guide-validation">validation</a></p>
</li>
<li>
<p><a href="guide-access-control#authorization">authorization</a></p>
</li>
<li>
<p><a href="guide-transactions">transaction-handling</a> (in addition to <a href="guide-service-layer">service layer</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_security_2"><a class="anchor" href="#_security_2"></a>Security</h4>
<div class="paragraph">
<p>The logic layer is the heart of the application. It is also responsible for authorization and hence security is important in this current case. Every method exposed in an interface needs to be annotated with an authorization check, stating what role(s) a caller must provide in order to be allowed to make the call. The authorization concept is described <a href="guide-access-control#authorization">here</a>.</p>
</div>
<div class="sect4">
<h5 id="_direct_object_references"><a class="anchor" href="#_direct_object_references"></a>Direct Object References</h5>
<div class="paragraph">
<p>A security threat are <a href="https://www.owasp.org/index.php/Top_10_2013-A4-Insecure_Direct_Object_References">Insecure Direct Object References</a>. This simply gives you two options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>avoid direct object references</p>
</li>
<li>
<p>ensure that direct object references are secure</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Especially when using REST, direct object references via technical IDs are common sense. This implies that you have a proper <a href="#authorization">authorization</a> in place. This is especially tricky when your authorization does not only rely on the type of the data and according to static permissions but also on the data itself. Vulnerabilities for this threat can easily happen by design flaws and inadvertence. Here is an example from our sample application:</p>
</div>
<div class="paragraph">
<p>We have a generic use-case to manage BLOBs. In the first place, it makes sense to write a generic REST service to load and save these BLOBs. However, the permission to read or even update such BLOB depends on the business object hosting the BLOB. Therefore, such a generic REST service would open the door for this OWASP A4 vulnerability. To solve this in a secure way, you need individual services for each hosting business object to manage the linked BLOB and have to check permissions based on the parent business object. In this example the ID of the BLOB would be the direct object reference and the ID of the business object (and a BLOB property indicator) would be the indirect object reference.</p>
</div>
<!-- toc disabled -->
<div class="paragraph">
<p>==Component Facade</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Our recommended approach for implementing the logic layer is <a href="guide-usecase">use-cases</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For each component of the application, the <a href="guide-logic-layer">logic layer</a> defines a component facade.
This is an interface defining all business operations of the component.
It carries the name of the component (<code>«Component»</code>) and has an implementation named <code>«Component»Impl</code> (see <a href="#implementation">implementation</a>).</p>
</div>
</div>
<div class="sect4">
<h5 id="_api"><a class="anchor" href="#_api"></a>API</h5>
<div class="paragraph">
<p>The component facade interface defines the logic API of the component and has to be business oriented.
This means that all parameters and return types of all methods from this API have to be business <a href="guide-transferobject">transfer-objects</a>, <a href="guide-datatype">datatypes</a> (<code>String</code>, <code>Integer</code>, <code>MyCustomerNumber</code>, etc.), or collections of these.
The API may also only access objects of other business components listed in the (transitive) dependencies of the <a href="architecture#business-architecture">business-architecture</a>.</p>
</div>
<div class="paragraph">
<p>Here is an example how such an API may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface Bookingmanagement {

  BookingEto findBooking(Long id);

  BookingCto findBookingCto(Long id);

  Page&lt;BookingEto&gt; findBookingEtos(BookingSearchCriteriaTo criteria);

  void approveBooking(BookingEto booking);

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_implementation"><a class="anchor" href="#_implementation"></a>Implementation</h5>
<div class="paragraph">
<p>The implementation of an interface from the <a href="guide-logic-layer">logic layer</a> (a component facade or a <a href="guide-usecase">use-case</a>) carries the name of that interface with the suffix <code>Impl</code> and is annotated with <code>@Named</code>.
An implementation typically needs access to the persistent data.
This is done by <a href="guide-dependency-injection">injecting</a> the corresponding <a href="guide-repository">repository</a> (or <a href="guide-dao">DAO</a>).
According to <a href="architecture#architecture-principles">data-sovereignty</a>, only repositories of the same business component may be accessed directly.
For accessing data from other components the implementation has to use the corresponding API of the logic layer (the component facade). Further, it shall not expose persistent entities from the <a href="guide-domain-layer">domain layer</a> and has to map them to <a href="guide-transferobject">transfer objects</a> using the <a href="guide-beanmapping">bean-mapper</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Named
@Transactional
public class BookingmanagementImpl extends AbstractComponentFacade implements Bookingmanagement {

  @Inject
  private BookingRepository bookingRepository;

  @Override
  public BookingEto findBooking(Long id) {

    LOG.debug("Get Booking with id {} from database.", id);
    BookingEntity entity = this.bookingRepository.findOne(id);
    return getBeanMapper().map(entity, BookingEto.class));
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, <a href="guide-jpa#entity">entities</a> (<code>BookingEntity</code>) are mapped to corresponding <a href="guide-transferobject#eto">ETOs</a> (<code>BookingEto</code>).
Further details about this can be found in <a href="guide-beanmapping">bean-mapping</a>.</p>
</div>
<!-- toc disabled -->
<div class="paragraph">
<p>==UseCase
A use-case is a small unit of the <a href="guide-logic-layer">logic layer</a> responsible for an operation on a particular <a href="guide-jpa#entity">entity</a> (business object).
We leave it up to you to decide whether you want to define an interface (API) for each use-case or provide an implementation directly.</p>
</div>
<div class="paragraph">
<p>Following our architecture-mapping (for <a href="guide-structure-classic#architecture-mapping">classic</a> and <a href="guide-structure-modern#architecture-mapping">modern</a> project), use-cases are named <code>Uc«Operation»«BusinessObject»[Impl]</code>. The prefix <code>Uc</code> stands for use-case and allows to easily find and identify them in your IDE. The <code>«Operation»</code> stands for a verb that is operated on the entity identified by <code>«BusinessObject»</code>.
For <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> we use the standard operations <code>Find</code> and <code>Manage</code> that can be generated by <a href="https://github.com/devonfw/cobigen">CobiGen</a>. This also separates read and write operations (e.g. if you want to do CQSR, or to configure read-only transactions for read operations).</p>
</div>
<div class="paragraph">
<p>In our example, we choose to define an interface for each use-case. We also use <code>*To</code> to refer to any type of transfer object. Please follow our <a href="guide-transferobject">guide</a> to understand more about different types of transfer object e.g. Eto, Dto, Cto</p>
</div>
</div>
<div class="sect4">
<h5 id="_find"><a class="anchor" href="#_find"></a>Find</h5>
<div class="paragraph">
<p>The <code>UcFind«BusinessObject»</code> defines all read operations to retrieve and search the <code>«BusinessObject»</code>.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface UcFindBooking {
  //*To = Eto, Dto or Cto
  Booking*To findBooking(Long id);
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_manage"><a class="anchor" href="#_manage"></a>Manage</h5>
<div class="paragraph">
<p>The <code>UcManage«BusinessObject»</code> defines all CRUD write operations (create, update and delete) for the <code>«BusinessObject»</code>.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface UcManageBooking {

  //*To = Eto, Dto or Cto
  Booking*To saveBooking(Booking*To booking);

  void deleteBooking(Long id);

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_custom"><a class="anchor" href="#_custom"></a>Custom</h5>
<div class="paragraph">
<p>Any other non CRUD operation <code>Uc«Operation»«BusinessObject»</code> uses any other custom verb for <code>«Operation»</code>.
Typically, such custom use-cases only define a single method.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface UcApproveBooking {

  //*To = Eto, Dto or Cto
  void approveBooking(Booking*To booking);

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_implementation_2"><a class="anchor" href="#_implementation_2"></a>Implementation</h5>
<div class="paragraph">
<p>The implementation should carry its own name and the suffix <code>Impl</code> and is annotated with <code>@Named</code> and <code>@ApplicationScoped</code>. It will need access to the persistent data which is done by injecting the corresponding repository (or DAO). Furthermore, it shall not expose persistent entities from the data access layer and has to map them to transfer objects using the bean-mapper. Please refer to our <a href="guide-beanmapping">bean mapping</a>, <a href="guide-transferobject">transfer object</a> and <a href="guide-dependency-injection">dependency injection</a> documentation for more information.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
@Named
public class UcManageBookingImpl implements UcManageBooking {

  @Inject
  private BookingRepository bookingRepository;

  @Override
  public void deleteBooking(Long id) {

    LOG.debug("Delete Booking with id {} from database.", id);
    this.bookingRepository.deleteById(id);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The use-cases can then be injected directly into the service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Named("BookingmanagementRestService")
@Validated
public class BookingmanagementRestServiceImpl implements BookingmanagementRestService {

  @Inject
  private UcFindBooking ucFindBooking;

  @Inject
  private UcManageBooking ucManageBooking;

  @Inject
  private UcApproveBooking ucApproveBooking;
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_internal_use_case"><a class="anchor" href="#_internal_use_case"></a>Internal use case</h5>
<div class="paragraph">
<p>Sometimes, a component with multiple related entities and many use-cases needs to reuse business logic internally.
Of course, this can be exposed as an official use-case API but this will imply using transfer-objects (ETOs) instead of entities. In some cases, this is undesired e.g. for better performance to prevent unnecessary mapping of entire collections of entities.
In the first place, you should try to use abstract base implementations providing reusable methods the actual use-case implementations can inherit from.
If your business logic is even more complex and you have multiple aspects of business logic to share and reuse but also run into multi-inheritance issues, you may also just create use-cases that have their interface located in the <code>impl</code> scope package right next to the implementation (or you may just skip the interface). In such a case, you may define methods that directly take or return entity objects.
To avoid confusion with regular use-cases, we recommend to add the <code>Internal</code> suffix to the type name leading to <code>Uc«Operation»«BusinessObject»Internal[Impl]</code>.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
<div class="paragraph">
<p>==Data-Access Layer</p>
</div>
<div class="paragraph">
<p>The data-access layer is responsible for all outgoing connections to access and process data. This is mainly about accessing data from a persistent data-store. External system could also be accessed from the data-access layer if they match this definition, e.g. a mongo-db via rest services.</p>
</div>
<div class="paragraph">
<p>Note: In the <a href="guide-structure-modern">modern project structure</a>, this layer is replaced by the <a href="guide-domain-layer">domain layer</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_database"><a class="anchor" href="#_database"></a>Database</h4>
<div class="paragraph">
<p>You need to make your choice for a database. Options are documented <a href="https://github.com/devonfw/devonfw-guide/blob/master/general/db/guide-database.adoc">here</a>.</p>
</div>
<div class="paragraph">
<p>The classical approach is to use a Relational Database Management System (RDMS). In such a case, we strongly recommend to follow our <a href="guide-jpa">JPA Guide</a>. Some NoSQL databases are supported by <a href="https://spring.io/projects/spring-data">spring-data</a> so you can consider the <a href="guide-repository">repository guide</a>.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
<div class="paragraph">
<p>==Batch Layer</p>
</div>
<div class="paragraph">
<p>We understand batch processing as a bulk-oriented, non-interactive, typically long running execution of tasks. For simplicity, we use the term "batch" or "batch job" for such tasks in the following documentation.</p>
</div>
<div class="paragraph">
<p>devonfw uses <a href="http://projects.spring.io/spring-batch/">Spring Batch</a> as a batch framework.</p>
</div>
<div class="paragraph">
<p>This guide explains how Spring Batch is used in devonfw applications. It focuses on aspects which are special to devonfw. If you want to learn about spring-batch you should adhere to springs references documentation.</p>
</div>
<div class="paragraph">
<p>There is an example of a simple batch implementation in the <a href="https://github.com/devonfw/my-thai-star/tree/develop/java/mtsj/batch">my-thai-star batch module</a>.</p>
</div>
<div class="paragraph">
<p>In this chapter, we will describe the overall architecture (especially concerning layering) and how to administer batches.</p>
</div>
</div>
<div class="sect3">
<h4 id="_layering"><a class="anchor" href="#_layering"></a>Layering</h4>
<div class="paragraph">
<p>Batches are implemented in the batch layer. The batch layer is responsible for batch processes, whereas the business logic is implemented in the logic layer. Compared to the <a href="guide-service-layer">service layer</a>, you may understand the batch layer just as a different way of accessing the business logic.
From a component point of view, each batch is implemented as a subcomponent in the corresponding business component.
The business component is defined by the <a href="architecture">business architecture</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s make an example for that. The sample application implements a batch for exporting ingredients. This ingredientExportJob belongs to the dishmanagement business component.
So the ingredientExportJob is implemented in the following package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&lt;basepackage&gt;.dishmanagement.batch.impl.*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Batches should invoke use cases in the logic layer for doing their work.
Only "batch specific" technical aspects should be implemented in the batch layer.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Example:
For a batch, which imports product data from a CSV file, this means that all code for actually reading and parsing the CSV input file is implemented in the batch layer.
The batch calls the use case "create product" in the logic layer for actually creating the products for each line read from the CSV input file.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_directly_accessing_data_access_layer"><a class="anchor" href="#_directly_accessing_data_access_layer"></a>Directly accessing data access layer</h5>
<div class="paragraph">
<p>In practice, it is not always appropriate to create use cases for every bit of work a batch should do. Instead, the data access layer can be used directly.
An example for that is a typical batch for data retention which deletes out-of-time data.
Often deleting, out-dated data is done by invoking a single SQL statement. It is appropriate to implement that SQL in a <a href="guide-repository">Repository</a> or <a href="guide-dao">DAO</a> method and call this method directly from the batch.
But be careful: this pattern is a simplification which could lead to business logic cluttered in different layers, which reduces the maintainability of your application.
It is a typical design decision you have to make when designing your specific batches.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_project_structure_and_packaging"><a class="anchor" href="#_project_structure_and_packaging"></a>Project structure and packaging</h4>
<div class="paragraph">
<p>Batches will be implemented in a separate Maven module to keep the application core free of batch dependencies. The batch module includes a dependency on the application core-module to allow the reuse of the use cases, DAOs etc.
Additionally the batch module has dependencies on the required spring batch jars:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">  &lt;dependencies&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;${project.groupId}&lt;/groupId&gt;
      &lt;artifactId&gt;mtsj-core&lt;/artifactId&gt;
      &lt;version&gt;${project.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-batch&lt;/artifactId&gt;
    &lt;/dependency&gt;

  &lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To allow an easy <a href="#start-batch">start of the batches</a> from the command line it is advised to create a bootified jar for the batch module by adding the following to the <code>pom.xml</code> of the batch module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">  &lt;build&gt;
    &lt;resources&gt;
      &lt;resource&gt;
        &lt;directory&gt;src/main/resources&lt;/directory&gt;
        &lt;filtering&gt;true&lt;/filtering&gt;
      &lt;/resource&gt;
    &lt;/resources&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
        &lt;configuration&gt;
          &lt;excludes&gt;
            &lt;exclude&gt;config/application.properties&lt;/exclude&gt;
          &lt;/excludes&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;
      &lt;!-- Create bootified jar for batch execution via command line.
           Your applications spring boot app is used as main-class.
       --&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
        &lt;configuration&gt;
          &lt;mainClass&gt;com.devonfw.application.mtsj.SpringBootApp&lt;/mainClass&gt;
          &lt;classifier&gt;bootified&lt;/classifier&gt;
        &lt;/configuration&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;repackage&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implementation_3"><a class="anchor" href="#_implementation_3"></a>Implementation</h4>
<div class="paragraph">
<p>Most of the details about implementation of batches is described in the <a href="https://spring.io/projects/spring-batch">spring batch documentation</a>.
There is nothing special about implementing batches in devonfw. You will find an easy <a href="https://github.com/devonfw/my-thai-star/tree/develop/java/mtsj/batch">example in my-thai-star</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="start-batch"><a class="anchor" href="#start-batch"></a>Starting from command line</h4>
<div class="paragraph">
<p>Devonfw advises to start batches via command line. This is most common to many ops teams and allows easy integration in existing <a href="#scheduling">schedulers</a>. In general batches are started with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java -jar &lt;app&gt;-batch-&lt;version&gt;-bootified.jar --spring.main.web-application-type=none --spring.batch.job.enabled=true --spring.batch.job.names=&lt;myJob&gt; &lt;params&gt;</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--spring.main.web-application-type=none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This disables the web app (e.g. Tomcat)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--spring.batch.job.names=&lt;myJob&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This specifies the name of the job to run. If you leave this out ALL jobs will be executed. Which probably does not make to much sense.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;params&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(Optional) additional parameters which are passed to your job</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This will launch your normal spring boot app, disables the web application part and runs the designated job via Spring Boots <code>org.springframework.boot.autoconfigure.batch.JobLauncherCommandLineRunner</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_scheduling"><a class="anchor" href="#_scheduling"></a>Scheduling</h4>
<div class="paragraph">
<p>In real world scheduling of batches is not as simple as it first might look like.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Multiple batches have to be executed in order to achieve complex tasks. If one of those batches fails the further execution has to be stopped and operations should be notified for example.</p>
</li>
<li>
<p>Input files or those created by batches have to be copied from one node to another.</p>
</li>
<li>
<p>Scheduling batch executing could get complex easily (quarterly jobs, run job on first workday of a month, &#8230;&#8203;)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For devonfw we propose the batches themselves should not mess around with details of scheduling.
Likewise your application should not do so. This complexity should be externalized to a dedicated batch administration service or scheduler.
This service could be a complex product or a simple tool like cron. We propose <a href="http://rundeck.org">Rundeck</a> as an open source job scheduler.</p>
</div>
<div class="paragraph">
<p>This gives full control to operations to choose the solution which fits best into existing administration procedures.</p>
</div>
</div>
<div class="sect3">
<h4 id="_handling_restarts"><a class="anchor" href="#_handling_restarts"></a>Handling restarts</h4>
<div class="paragraph">
<p>If you start a job with the same parameters set after a failed run (BatchStatus.FAILED) a restart will occur.
In many cases your batch should then not reprocess all items it processed in the previous runs.
For that you need some logic to start at the desired offset. There different ways to implement such logic:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Marking processed items in the database in a dedicated column</p>
</li>
<li>
<p>Write all IDs of items to process in a separate table as an initialization step of your batch. You can then delete IDs of already processed items from that table during the batch execution.</p>
</li>
<li>
<p>Storing restart information in springs ExecutionContext (see below)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_using_spring_batch_executioncontext_for_restarts"><a class="anchor" href="#_using_spring_batch_executioncontext_for_restarts"></a>Using spring batch ExecutionContext for restarts</h5>
<div class="paragraph">
<p>By implementing the <code>ItemStream</code> interface in your <code>ItemReader</code> or <code>ItemWriter</code> you may store information about the batch progress in the <code>ExecutionContext</code>. You will find an example for that in the CountJob in My Thai Star.</p>
</div>
<div class="paragraph">
<p>Additional hint: It is important that bean definition method of your <code>ItemReader</code>/<code>ItemWriter</code> return types implementing <code>ItemStream</code>(and not just <code>ItemReader</code> or <code>ItemWriter</code> alone). For that the <code>ItemStreamReader</code> and <code>ItemStreamWriter</code> interfaces are provided.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exit_codes"><a class="anchor" href="#_exit_codes"></a>Exit codes</h4>
<div class="paragraph">
<p>Your batches should create a meaningful exit code to allow reaction to batch errors e.g. in a <a href="#scheduling">scheduler</a>.
For that spring batch automatically registers an <code>org.springframework.boot.autoconfigure.batch.JobExecutionExitCodeGenerator</code>. To make this mechanism work your spring boot app main class as to populate this exit code to the JVM:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@SpringBootApplication
public class SpringBootApp {

  public static void main(String[] args) {
    if (Arrays.stream(args).anyMatch((String e) -&gt; e.contains("--spring.batch.job.names"))) {
      // if executing batch job, explicitly exit jvm to report error code from batch
      System.exit(SpringApplication.exit(SpringApplication.run(SpringBootApp.class, args)));
    } else {
      // normal web application start
      SpringApplication.run(SpringBootApp.class, args);
    }
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_stop_batches_and_manage_batch_status"><a class="anchor" href="#_stop_batches_and_manage_batch_status"></a>Stop batches and manage batch status</h4>
<div class="paragraph">
<p>Spring batch uses several database tables to store the status of batch executions.
Each execution may have <a href="https://docs.spring.io/spring-batch/docs/current/reference/html/index-single.html#jobexecution">different status</a>.
You may use this mechanism to <a href="https://docs.spring.io/spring-batch/docs/current/reference/html/index-single.html#stoppingAJob">gracefully stop batches</a>.
Additionally in some edge cases (batch process crashed) the execution status may be in an undesired state.
E.g. the state will be running, despite the process crashed sometime ago.
For that cases you have to change the status of the execution in the database.</p>
</div>
<div class="sect4">
<h5 id="_cli_tool"><a class="anchor" href="#_cli_tool"></a>CLI-Tool</h5>
<div class="paragraph">
<p>Devonfw provides a easy to use cli-tool to manage the executing status of your jobs.
The tool is implemented in the devonfw module <code>devon4j-batch-tool</code>. It will provide a runnable jar, which may be used as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">List names of all previous executed jobs</dt>
<dd>
<p><code>java -D'spring.datasource.url=jdbc:h2:~/mts;AUTO_SERVER=TRUE' -jar devon4j-batch-tool.jar jobs list</code></p>
</dd>
<dt class="hdlist1">Stop job named 'countJob'</dt>
<dd>
<p><code>java -D'spring.datasource.url=jdbc:h2:~/mts;AUTO_SERVER=TRUE' -jar devon4j-batch-tool.jar jobs stop countJob</code></p>
</dd>
<dt class="hdlist1">Show help</dt>
<dd>
<p><code>java -D'spring.datasource.url=jdbc:h2:~/mts;AUTO_SERVER=TRUE' -jar devon4j-batch-tool.jar</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>As you can the each invocation includes the JDBC connection string to your database.
This means that you have to make sure that the corresponding DB driver is in the classpath (the prepared jar only contains H2).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_authentication"><a class="anchor" href="#_authentication"></a>Authentication</h4>
<div class="paragraph">
<p>Most business application incorporate authentication and authorization.
Your spring boot application will implement some kind of security, e.g. integrated login with username+password or in many cases authentication via an existing IAM.
For security reasons your batch should also implement an authentication mechanism and obey the authorization implemented in your application (e.g. via @RolesAllowed).</p>
</div>
<div class="paragraph">
<p>Since there are many different authentication mechanism we cannot provide an out-of-the-box solution in devonfw, but we describe a pattern how this can be implemented in devonfw batches.</p>
</div>
<div class="paragraph">
<p>We suggest to implement the authentication in a Spring Batch tasklet, which runs as the first step in your batch. This tasklet will do all of the work which is required to authenticate the batch. A simple example which authenticates the batch "locally" via username and password could be implemented like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Named
public class SimpleAuthenticationTasklet implements Tasklet {

  @Override
  public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception {

    String username = chunkContext.getStepContext().getStepExecution().getJobParameters().getString("username");
    String password = chunkContext.getStepContext().getStepExecution().getJobParameters().getString("password");
    Authentication authentication = new UsernamePasswordAuthenticationToken(username, password);

    SecurityContextHolder.getContext().setAuthentication(authentication);
    return RepeatStatus.FINISHED;
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The username and password have to be supplied via two cli parameters <code>-username</code> and <code>-password</code>. This implementation creates an "authenticated" <code>Authentication</code> and sets in the Spring Security context. This is just for demonstration normally you should not provide passwords via command line. The actual authentication will be done automatically via Spring Security as in your "normal" application.
If you have a more complex authentication mechanism in your application e.g. via OpenID connect just call this in the tasklet. Naturally you may read authentication parameters (e.g. secrets) from the command line or more securely from a configuration file.</p>
</div>
<div class="paragraph">
<p>In your Job Configuration set this tasklet as the first step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@EnableBatchProcessing
public class BookingsExportBatchConfig {
  @Inject
  private JobBuilderFactory jobBuilderFactory;

  @Inject
  private StepBuilderFactory stepBuilderFactory;

  @Bean
  public Job myBatchJob() {
    return this.jobBuilderFactory.get("myJob").start(myAuthenticationStep()).next(...).build();
  }

  @Bean
  public Step myAuthenticationStep() {
    return this.stepBuilderFactory.get("myAuthenticationStep").tasklet(myAuthenticatonTasklet()).build();
  }

  @Bean
  public Tasklet myAuthenticatonTasklet() {
    return new SimpleAuthenticationTasklet();
  }
...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tipps_tricks"><a class="anchor" href="#_tipps_tricks"></a>Tipps &amp; tricks</h4>
<div class="sect4">
<h5 id="_identifying_job_parameters"><a class="anchor" href="#_identifying_job_parameters"></a>Identifying job parameters</h5>
<div class="paragraph">
<p>Spring uses a jobs parameters to identify <a href="https://docs.spring.io/spring-batch/docs/current/reference/html/domain.html#jobexecution">job executions</a>. Parameters starting with "-" are not considered for identifying a job execution.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
