<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Devonfw.github.io Docs</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">Devonfw.github.io Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="devonfw.github.io" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">devonfw.github.io</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../architecture-guidelines/1.0/index.html">Architecture-guidelines</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../architecture-guidelines/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../cicdgen/1.0/index.html">Cicdgen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../cicdgen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../cobigen/1.0/index.html">Cobigen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../cobigen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../dashboard/1.0/index.html">Dashboard</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../dashboard/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4j/1.0/index.html">Devon4j</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4j/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4net/1.0/index.html">Devon4net</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4net/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4ng/1.0/index.html">Devon4ng</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4ng/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4node/1.0/index.html">Devon4node</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4node/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4quarkus/1.0/index.html">Devon4quarkus</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4quarkus/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4ts/1.0/index.html">Devon4ts</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4ts/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">devonfw.github.io</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../getting-started/1.0/index.html">Getting-started</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../getting-started/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../github/1.0/index.html">Github</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../github/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../hangar/1.0/index.html">Hangar</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../hangar/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../ide/1.0/index.html">IDE</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../ide/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../jump-the-queue/1.0/index.html">Jump-the-queue</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../jump-the-queue/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../mrchecker/1.0/index.html">Mrchecker</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../mrchecker/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../my-thai-star/1.0/index.html">My-thai-star</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../my-thai-star/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../production-line/1.0/index.html">Production-line</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../production-line/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../shop-floor/1.0/index.html">Shop-floor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../shop-floor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../solicitor/1.0/index.html">Solicitor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../solicitor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../sonar-devon4j-plugin/1.0/index.html">Sonar-devon4j-plugin</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../sonar-devon4j-plugin/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/marvdan/devonfw.github.io/edit/developAntoraGhPage/docs/modules/ROOT/pages/shop-floor.wiki/dsf-configure-jenkins.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_jenkinsfile">Jenkinsfile</a></li>
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_environment_values">Environment values</a></li>
<li><a href="#_stages">Stages</a></li>
<li><a href="#_setup_jenkins_tools">Setup Jenkins tools</a></li>
<li><a href="#_code_lint_analysis">Code lint analysis</a></li>
<li><a href="#_execute_tests">Execute tests</a></li>
<li><a href="#_sonarqube_analisys">SonarQube Analisys</a></li>
<li><a href="#_build">Build</a></li>
<li><a href="#_store_in_nexus">Store in Nexus</a></li>
<li><a href="#_create_docker_image">Create docker image</a></li>
<li><a href="#_deploy_docker_image">Deploy docker image</a></li>
<li><a href="#_check_status">Check status</a></li>
<li><a href="#_post_operations">Post operations</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="_jenkinsfile"><a class="anchor" href="#_jenkinsfile"></a>Jenkinsfile</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="../_images/images/configuration/jenkinsfile-cicd-activity-diagram.jpg" alt="jenkinsfile cicd activity diagram">
</div>
</div>
<div class="paragraph">
<p>Here you are going to learn how you should configure the jenkinsfile of your project to apply CI/CD operations and enables automated application deployment.</p>
</div>
<div class="paragraph">
<p>Here you can find examples of the Jenkinsfile generated by cicdgen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://raw.githubusercontent.com/devonfw/cicdgen/develop/schematics/src/devon4j/files/Jenkinsfile">devon4j</a></p>
</li>
<li>
<p><a href="https://raw.githubusercontent.com/devonfw/cicdgen/develop/schematics/src/devon4ng/files/Jenkinsfile">devon4ng</a></p>
</li>
<li>
<p><a href="https://raw.githubusercontent.com/devonfw/cicdgen/develop/schematics/src/devon4node/files/Jenkinsfile">devon4node</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Next you could find an explanation about what is done in these Jenkinsfiles.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_environment_values"><a class="anchor" href="#_environment_values"></a>Environment values</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the top of the pipeline you should add the environment variables. in this tutorial you need the next variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    // sonarQube
    // Name of the sonarQube tool
    sonarTool = 'SonarQube'
    // Name of the sonarQube environment
    sonarEnv = "SonarQube"

    // Nexus
    // Artifact groupId
    groupId = '&lt;%= groupid %&gt;'
    // Nexus repository ID
    repositoryId = 'pl-nexus'
    // Nexus internal URL
    repositoryUrl = 'http://nexus3-core:8081/nexus3/repository/'
    // Maven global settings configuration ID
    globalSettingsId = 'MavenSettings'
    // Maven tool id
    mavenInstallation = 'Maven3'

    // Docker registry
    dockerRegistry = 'docker-registry-&lt;%= plurl %&gt;'
    dockerRegistryCredentials = 'nexus-docker'
    dockerTool = 'docker-global'

    // OpenShift
    openshiftUrl = '&lt;%= ocurl %&gt;'
    openShiftCredentials = 'openshift'
    openShiftNamespace = '&lt;%= ocn %&gt;'</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stages"><a class="anchor" href="#_stages"></a>Stages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The pipeline consists of stages, and at the beginning of each stage it is declared for which branches the step will be executed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/images/configuration/jenkinsfile-stages.jpg" alt="jenkinsfile stages">
</div>
</div>
<div class="paragraph">
<p>Now it is time to create the stages.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_jenkins_tools"><a class="anchor" href="#_setup_jenkins_tools"></a>Setup Jenkins tools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first stage is one of the most dangerous, because in it on one hand the tools are added to the pipeline and to the path and on other hand the values are tagged depending on the branch that is being executed. If you are going to create a ci/cd for a new branch or you are going to modify something, be very careful with everything that this first step declares.</p>
</div>
<div class="paragraph">
<p>This is an example of this stage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>script {
    tool yarn
    tool Chrome-stable
    tool dockerTool

    if (env.BRANCH_NAME.startsWith('release')) {
        dockerTag = "release"
        repositoryName = 'maven-releases'
        dockerEnvironment = "_uat"
        openShiftNamespace += "-uat"
        sonarProjectKey = '-release'
    }

    if (env.BRANCH_NAME ==  'develop') {
        dockerTag = "latest"
        repositoryName = 'maven-snapshots'
        dockerEnvironment = "_dev"
        openShiftNamespace += "-dev"
        sonarProjectKey = '-develop'
    }

    if (env.BRANCH_NAME ==  'master') {
        dockerTag = "production"
        repositoryName = 'maven-releases'
        dockerEnvironment = '_prod'
        openShiftNamespace += "-prod"
        sonarProjectKey = ''
    }

    sh "yarn"
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_code_lint_analysis"><a class="anchor" href="#_code_lint_analysis"></a>Code lint analysis</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next stage is to analyze the code making a lint analysis. To do it your project should have a tslint file with the configuration (<em>tslint.json</em>).</p>
</div>
<div class="paragraph">
<p>analyzing the code in your pipeline is as simple as executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sh """yarn lint"""</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Your project need to have an script with tslint configuration (<em>tslint.json</em>).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_execute_tests"><a class="anchor" href="#_execute_tests"></a>Execute tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To test you application first of all your application should have created the tests and you should use one of the next two options:</p>
</div>
<div class="paragraph">
<p><strong>Execute test with maven</strong> (It should be used by devon4j).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>withMaven(globalMavenSettingsConfig: globalSettingsId, maven: mavenInstallation) {
    sh "mvn clean test"
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Execute test with yarn</strong> (It should be used by devon4ng or devon4node).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sh """yarn test:ci"""</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Remeber that your project should have the tests created and in case of do it with yarn or npm, you package.json should have the script declared. This is an example <code>"test:ci": "ng test --browsers ChromeHeadless --watch=false"</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sonarqube_analisys"><a class="anchor" href="#_sonarqube_analisys"></a>SonarQube Analisys</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is time to see if your application complies the requirements of the sonar analysis.</p>
</div>
<div class="paragraph">
<p>To do it you could use one of the next two options:</p>
</div>
<div class="paragraph">
<p><strong>Execute Sonar with sonarTool</strong> (It should be used by devon4ng or devon4node).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>script {
    def scannerHome = tool sonarTool
    def props = readJSON file: 'package.json'
    withSonarQubeEnv(sonarEnv) {
        sh """
            ${scannerHome}/bin/sonar-scanner \
                -Dsonar.projectKey=${props.name}${sonarProjectKey} \
                -Dsonar.projectName=${props.name}${sonarProjectKey} \
                -Dsonar.projectVersion=${props.version} \
                -Dsonar.sources=${srcDir} \
                -Dsonar.typescript.lcov.reportPaths=coverage/lcov.info
        """
    }
    timeout(time: 1, unit: 'HOURS') {
        def qg = waitForQualityGate()
        if (qg.status != 'OK') {
            error "Pipeline aborted due to quality gate failure: ${qg.status}"
        }
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Execute Sonar with maven</strong> (It should be used by devon4j).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>script {
    withMaven(globalMavenSettingsConfig: globalSettingsId, maven: mavenInstallation) {
        withSonarQubeEnv(sonarEnv) {
            // Change the project name (in order to simulate branches with the free version)
            sh "cp pom.xml pom.xml.bak"
            sh "cp api/pom.xml api/pom.xml.bak"
            sh "cp core/pom.xml core/pom.xml.bak"
            sh "cp server/pom.xml server/pom.xml.bak"

            def pom = readMavenPom file: './pom.xml';
            pom.artifactId = "${pom.artifactId}${sonarProjectKey}"
            writeMavenPom model: pom, file: 'pom.xml'

            def apiPom = readMavenPom file: 'api/pom.xml'
            apiPom.parent.artifactId = pom.artifactId
            apiPom.artifactId = "${pom.artifactId}-api"
            writeMavenPom model: apiPom, file: 'api/pom.xml'

            def corePom = readMavenPom file: 'core/pom.xml'
            corePom.parent.artifactId = pom.artifactId
            corePom.artifactId = "${pom.artifactId}-core"
            writeMavenPom model: corePom, file: 'core/pom.xml'

            def serverPom = readMavenPom file: 'server/pom.xml'
            serverPom.parent.artifactId = pom.artifactId
            serverPom.artifactId = "${pom.artifactId}-server"
            writeMavenPom model: serverPom, file: 'server/pom.xml'

            sh "mvn sonar:sonar"

            sh "mv pom.xml.bak pom.xml"
            sh "mv api/pom.xml.bak api/pom.xml"
            sh "mv core/pom.xml.bak core/pom.xml"
            sh "mv server/pom.xml.bak server/pom.xml"
        }
    }
    timeout(time: 1, unit: 'HOURS') {
        def qg = waitForQualityGate()
        if (qg.status != 'OK') {
            error "Pipeline aborted due to quality gate failure: ${qg.status}"
        }
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build"><a class="anchor" href="#_build"></a>Build</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If SonarQube is passed, you could build your application. To do it, if you are using devon4ng or devon4node you only need to add the next command:</p>
</div>
<div class="paragraph">
<p>sh """yarn build"""</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are using devon4j this and the next step <em>Store in Nexus</em> are making together using <code>mvn deploy</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_store_in_nexus"><a class="anchor" href="#_store_in_nexus"></a>Store in Nexus</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One time the application has been built the code of the application you could find the the artifacts stored in the dist folder. You should push these artifacts to store them in Nexus.</p>
</div>
<div class="paragraph">
<p>You can do it following one of the next options:</p>
</div>
<div class="paragraph">
<p><strong>Use maven deploy config of your project</strong> (It should be used by devon4j).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>withMaven(globalMavenSettingsConfig: globalSettingsId, maven: mavenInstallation) {
    sh "mvn deploy -Dmaven.test.skip=true"
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Configure maven deploy in your pipeline</strong> (It should be used by devon4ng and devon4node).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>script {
    def props = readJSON file: 'package.json'
    zip dir: 'dist/', zipFile: """${props.name}.zip"""
    version = props.version
    if (!version.endsWith("-SNAPSHOT") &amp;&amp; env.BRANCH_NAME ==  'develop') {
        version = "${version}-SNAPSHOT"
        version = version.replace("-RC", "")
    }

    if (!version.endsWith("-RC") &amp;&amp; env.BRANCH_NAME.startsWith('release')) {
        version = "${version}-RC"
        version = version.replace("-SNAPSHOT", "")
    }

    if (env.BRANCH_NAME ==  'master' &amp;&amp; (version.endsWith("-RC") || version.endsWith("-SNAPSHOT"))){
        version = version.replace("-RC", "")
        version = version.replace("-SNAPSHOT", "")
    }

    withMaven(globalMavenSettingsConfig: globalSettingsId, maven: mavenInstallation) {
        sh """
            mvn deploy:deploy-file \
                -DgroupId=${groupId} \
                -DartifactId=${props.name} \
                -Dversion=${version} \
                -Dpackaging=zip \
                -Dfile=${props.name}.zip \
                -DrepositoryId=${repositoryId} \
                -Durl=${repositoryUrl}${repositoryName}
        """
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_docker_image"><a class="anchor" href="#_create_docker_image"></a>Create docker image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we need to use this artifacts to create a Docker image. To create the docker image you need an external server to do it. You could do it using one of the next:</p>
</div>
<div class="paragraph">
<p><strong>Create docker image using OpenShift cluster</strong></p>
</div>
<div class="paragraph">
<p>To create the docker image with this option you need to configure your OpenShift. You could read how to configure it <a href="dsf-deployment-dsf4openshift#configure-builds-to-create-docker-image-using-OpenShift.adoc">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>props = readJSON file: 'package.json'
withCredentials([usernamePassword(credentialsId: "${openShiftCredentials}", passwordVariable: 'pass', usernameVariable: 'user')]) {
    sh "oc login -u ${user} -p ${pass} ${openshiftUrl} --insecure-skip-tls-verify"
    try {
        sh "oc start-build ${props.name} --namespace=${openShiftNamespace} --from-dir=dist --wait"
        sh "oc import-image ${props.name} --namespace=${openShiftNamespace} --from=${dockerRegistry}/${props.name}:${dockerTag} --confirm"
    } catch (e) {
        sh """
            oc logs \$(oc get builds -l build=${props.name} --namespace=${openShiftNamespace} --sort-by=.metadata.creationTimestamp -o name | tail -n 1) --namespace=${namespace}
            throw e
        """
    }
}</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
if your project is a maven project you should read the <em>pom.xml</em> file instead of the <em>package.json</em>, you could do it with the next command <code>def pom = readMavenPom file: 'pom.xml'</code>. Due to the fact that there are different variable names between those two files, remember to modify <strong>${props.name}</strong> for <strong>${pom.artifactId}</strong> in the code.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Create docker image using docker server</strong></p>
</div>
<div class="paragraph">
<p>To create the docker image with this option you need to install docker and configure where is the docker host in your jenkins.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker.withRegistry("""${dockerRegistryProtocol}${dockerRegistry}""", dockerRegistryCredentials) {
    def props = readJSON file: 'package.json'
    def customImage = docker.build("${props.name}:${props.version}", "-f ${dockerFileName} .")
    customImage.push()
    customImage.push(dockerTag);
}</pre>
</div>
</div>
<div class="paragraph">
<p><a href="dsf-deployment-dsf4openshift#configure-builds-to-create-docker-image-using-OpenShift.adoc">here</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
if your project is a maven project you should read the <em>pom.xml</em> file instead of the <em>package.json</em>, you could do it with the next command <code>def pom = readMavenPom file: 'pom.xml'</code>. Due to the fact that there are different variable names between those two files, remember to modify <strong>${props.name}</strong> for <strong>${pom.artifactId}</strong> and <strong>${props.version}</strong> for <strong>${pom.version}</strong> in the code.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_docker_image"><a class="anchor" href="#_deploy_docker_image"></a>Deploy docker image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you have the docker image in the registry we only need to import it into your deployment environment. We can do it executing one of the next commands:</p>
</div>
<div class="paragraph">
<p><strong>Deploy docker image in OpenShift cluster</strong></p>
</div>
<div class="paragraph">
<p>To deploy the docker image with this option you need to configure your OpenShift. You could read how to configure it <a href="dsf-deployment-dsf4openshift#configure-new-environment.adoc">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>script {
    props = readJSON file: 'package.json'
    withCredentials([usernamePassword(credentialsId: "${openShiftCredentials}", passwordVariable: 'pass', usernameVariable: 'user')]) {
        sh "oc login -u ${user} -p ${pass} ${openshiftUrl} --insecure-skip-tls-verify"
        try {
            sh "oc import-image ${props.name} --namespace=${openShiftNamespace} --from=${dockerRegistry}/${props.name}:${dockerTag} --confirm"
        } catch (e) {
            sh """
                oc logs \$(oc get builds -l build=${props.name} --namespace=${openShiftNamespace} --sort-by=.metadata.creationTimestamp -o name | tail -n 1) --namespace=${openShiftNamespace}
                throw e
            """
        }
    }
}</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
if your project is a maven project you should read the <em>pom.xml</em> file instead of the <em>package.json</em>, you could do it with the next command <code>def pom = readMavenPom file: 'pom.xml'</code>. Due to the fact that there are different variable names between those two files, remember to modify <strong>${props.name}</strong> for <strong>${pom.artifactId}</strong> in the code.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Deploy docker image using docker server</strong></p>
</div>
<div class="paragraph">
<p>To deploy the docker image with this option you need to install docker and configure your docker server and also integrate it with Jenkins.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>script {
    docker.withRegistry("""${dockerRegistryProtocol}${dockerRegistry}""", dockerRegistryCredentials) {
        def props = readJSON file: 'package.json'
        docker.image("${props.name}:${props.version}").pull()

        def containerId = sh returnStdout: true, script: """docker ps -aqf "name=${containerName}${dockerEnvironment}" """
        if (containerId?.trim()) {
            sh "docker rm -f ${containerId.trim()}"
        }

        println """docker run -d --name ${containerName}${dockerEnvironment} --network=${networkName} ${dockerRegistry}/${props.name}:${props.version}"""
        sh """docker run -d --name ${containerName}${dockerEnvironment} --network=${networkName} ${dockerRegistry}/${props.name}:${props.version}"""
    }
}</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
if your project is a maven project you should read the <em>pom.xml</em> file instead of the <em>package.json</em>, you could do it with the next command <code>def pom = readMavenPom file: 'pom.xml'</code>. Due to the fact that there are different variable names between those two files, remember to modify <strong>${props.name}</strong> for <strong>${pom.artifactId}</strong> and <strong>${props.version}</strong> for <strong>${pom.version}</strong> in the code.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_check_status"><a class="anchor" href="#_check_status"></a>Check status</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now is time to check if your pods are running ok.</p>
</div>
<div class="paragraph">
<p>To check if your pods are ok in OpenShift you should add the next code to your pipeline:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>script {
    props = readJSON file: 'package.json'
    sleep 30
    withCredentials([usernamePassword(credentialsId: "${openShiftCredentials}", passwordVariable: 'pass', usernameVariable: 'user')]) {
        sh "oc login -u ${user} -p ${pass} ${openshiftUrl} --insecure-skip-tls-verify"
        sh "oc project ${openShiftNamespace}"

        def oldRetry = -1;
        def oldState = "";

        sh "oc get pods -l app=${props.name} &gt; out"
        def status = sh (
            script: "sed 's/[\t ][\t ]*/ /g' &lt; out | sed '2q;d' | cut -d' ' -f3",
            returnStdout: true
        ).trim()

        def retry = sh (
            script: "sed 's/[\t ][\t ]*/ /g' &lt; out | sed '2q;d' | cut -d' ' -f4",
            returnStdout: true
        ).trim().toInteger();

        while (retry &lt; 5 &amp;&amp; (oldRetry != retry || oldState != status)) {
            sleep 30
            oldRetry = retry
            oldState = status

            sh """oc get pods -l app=${props.name} &gt; out"""
            status = sh (
                script: "sed 's/[\t ][\t ]*/ /g' &lt; out | sed '2q;d' | cut -d' ' -f3",
                returnStdout: true
            ).trim()

            retry = sh (
                script: "sed 's/[\t ][\t ]*/ /g' &lt; out | sed '2q;d' | cut -d' ' -f4",
                returnStdout: true
            ).trim().toInteger();
        }

        if(status != "Running"){
            try {
                sh """oc logs \$(oc get pods -l app=${props.name} --sort-by=.metadata.creationTimestamp -o name | tail -n 1)"""
            } catch (e) {
                sh "echo error reading logs"
            }
            error("The pod is not running, cause: " + status)
        }
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_post_operations"><a class="anchor" href="#_post_operations"></a>Post operations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When all its finish, remember to clean your workspace.</p>
</div>
<div class="paragraph">
<p>post {
    cleanup {
        cleanWs()
    }
}</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You could also delete your dir adding the next command <code>deleteDir()</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
