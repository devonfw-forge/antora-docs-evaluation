<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Devonfw.github.io Docs</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">Devonfw.github.io Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="devonfw.github.io" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">devonfw.github.io</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../architecture-guidelines/1.0/index.html">Architecture-guidelines</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../architecture-guidelines/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../cicdgen/1.0/index.html">Cicdgen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../cicdgen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../cobigen/1.0/index.html">Cobigen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../cobigen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../dashboard/1.0/index.html">Dashboard</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../dashboard/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4j/1.0/index.html">Devon4j</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4j/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4net/1.0/index.html">Devon4net</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4net/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4ng/1.0/index.html">Devon4ng</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4ng/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4node/1.0/index.html">Devon4node</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4node/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4quarkus/1.0/index.html">Devon4quarkus</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4quarkus/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4ts/1.0/index.html">Devon4ts</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4ts/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">devonfw.github.io</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../getting-started/1.0/index.html">Getting-started</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../getting-started/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../github/1.0/index.html">Github</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../github/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../hangar/1.0/index.html">Hangar</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../hangar/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../ide/1.0/index.html">IDE</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../ide/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../jump-the-queue/1.0/index.html">Jump-the-queue</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../jump-the-queue/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../mrchecker/1.0/index.html">Mrchecker</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../mrchecker/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../my-thai-star/1.0/index.html">My-thai-star</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../my-thai-star/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../production-line/1.0/index.html">Production-line</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../production-line/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../shop-floor/1.0/index.html">Shop-floor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../shop-floor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../solicitor/1.0/index.html">Solicitor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../solicitor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../sonar-devon4j-plugin/1.0/index.html">Sonar-devon4j-plugin</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../sonar-devon4j-plugin/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/marvdan/devonfw.github.io/edit/developAntoraGhPage/docs/modules/ROOT/pages/devon4ng.wiki/guide-app-initializer.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#app_initializer"><code>APP_INITIALIZER</code></a></li>
<li><a href="#what-is-the-app_initializer-pattern">What is the <code>APP_INITIALIZER</code> pattern</a></li>
<li><a href="#what-is-app_initializer">What is <code>APP_INITIALIZER</code></a></li>
<li><a href="#">==</a></li>
<li><a href="#creating-a-app_initializer-configuration">Creating a <code>APP_INITIALIZER</code> configuration</a></li>
<li><a href="#setting-up-the-config-files">Setting up the config files</a></li>
<li><a href="#docker-external-configuration-optional">Docker external configuration (Optional)</a></li>
<li><a href="#external-json-configuration">External json configuration</a></li>
<li><a href="#setting-up-the-proxies">Setting up the proxies</a></li>
<li><a href="#docker-optional">Docker (Optional)</a></li>
<li><a href="#external-configuration">External Configuration</a></li>
<li><a href="#adding-the-loadexternalconfig-boolean-to-the-environments">Adding the <code>loadExternalConfig</code> Boolean to the environments</a></li>
<li><a href="#creating-core-configuration-service">Creating core configuration service</a></li>
<li><a href="#using-the-config-service">Using the Config Service</a></li>
<li><a href="#final-steps">Final steps</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="app_initializer"><a class="anchor" href="#app_initializer"></a><code>APP_INITIALIZER</code></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="what-is-the-app_initializer-pattern"><a class="anchor" href="#what-is-the-app_initializer-pattern"></a>What is the <code>APP_INITIALIZER</code> pattern</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>APP_INITIALIZER</code> pattern allows an application to choose which configuration is going to be used in the start of the application, this is useful because it allows to setup different configurations, for example, for docker or a remote configuration. This provides benefits since this is done on <code>runtime</code>, so there&#8217;s no need to recompile the whole application to switch from configuration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-app_initializer"><a class="anchor" href="#what-is-app_initializer"></a>What is <code>APP_INITIALIZER</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>APP_INITIALIZER</code> allows to provide a service in the initialization of the application in a <code>@NgModule</code>. It also allows to use a factory, allowing to create a singleton in the same service. An example can be found in <code>MyThaiStar</code> <code>/core/config/config.module.ts</code>:</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id=""><a class="anchor" href="#"></a>==</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The provider expects the return of a <code>Promise</code>, if it is using Observables, a change with the method <code>toPromise()</code> will allow a switch from <code>Observable</code> to <code>Promise</code>
== ==</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-TypeScript hljs" data-lang="TypeScript">import { NgModule, APP_INITIALIZER } from '@angular/core';
import { HttpClientModule } from '@angular/common/http';

import { ConfigService } from './config.service';

@NgModule({
  imports: [HttpClientModule],
  providers: [
    ConfigService,
    {
      provide: APP_INITIALIZER,
      useFactory: ConfigService.factory,
      deps: [ConfigService],
      multi: true,
    },
  ],
})
export class ConfigModule {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is going to allow the creation of a <code>ConfigService</code> where, using a singleton, the service is going to load an external config depending on a route. This dependence with a route, allows to setup different configuration for docker etc. This is seen in the <code>ConfigService</code> of <code>MyThaiStar</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-TypeScript hljs" data-lang="TypeScript">import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Config, config } from './config';

@Injectable()
export class ConfigService {
  constructor(private httpClient: HttpClient) {}

  static factory(appLoadService: ConfigService) {
    return () =&gt; appLoadService.loadExternalConfig();
  }

  // this method gets external configuration calling /config endpoint
  //and merges into config object
  loadExternalConfig(): Promise&lt;any&gt; {
    if (!environment.loadExternalConfig) {
      return Promise.resolve({});
    }

    const promise = this.httpClient
      .get('/config')
      .toPromise()
      .then((settings) =&gt; {
        Object.keys(settings || {}).forEach((k) =&gt; {
          config[k] = settings[k];
        });
        return settings;
      })
      .catch((error) =&gt; {
        return 'ok, no external configuration';
      });

    return promise;
  }

  getValues(): Config {
    return config;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As it is mentioned earlier, you can see the use of a factory to create a singleton at the start. After that, <code>loadExternalConfig</code> is going to look for a Boolean inside the corresponding environment file inside the path <code>src/environments/</code>, this Boolean <code>loadExternalConfig</code> is going to easily allow to switch to a external config. If it is true, it generates a promise that overwrites the parameters of the local config, allowing to load the external config. Finally, the last method <code>getValues()</code> is going to allow to return the file config with the values (overwritten or not). The local <code>config</code> file from <code>MyThaiStar</code> can be seen here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-TypeScript hljs" data-lang="TypeScript">export enum BackendType {
  IN_MEMORY,
  REST,
  GRAPHQL,
}

interface Role {
  name: string;
  permission: number;
}

interface Lang {
  label: string;
  value: string;
}

export interface Config {
  version: string;
  backendType: BackendType;
  restPathRoot: string;
  restServiceRoot: string;
  pageSizes: number[];
  pageSizesDialog: number[];
  roles: Role[];
  langs: Lang[];
}

export const config: Config = {
  version: 'dev',
  backendType: BackendType.REST,
  restPathRoot: 'http://localhost:8081/mythaistar/',
  restServiceRoot: 'http://localhost:8081/mythaistar/services/rest/',
  pageSizes: [8, 16, 24],
  pageSizesDialog: [4, 8, 12],
  roles: [
    { name: 'CUSTOMER', permission: 0 },
    { name: 'WAITER', permission: 1 },
  ],
  langs: [
    { label: 'English', value: 'en' },
    { label: 'Deutsch', value: 'de' },
    { label: 'Español', value: 'es' },
    { label: 'Català', value: 'ca' },
    { label: 'Français', value: 'fr' },
    { label: 'Nederlands', value: 'nl' },
    { label: 'हिन्दी', value: 'hi' },
    { label: 'Polski', value: 'pl' },
    { label: 'Русский', value: 'ru' },
    { label: 'български', value: 'bg' },
  ],
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, inside a environment file <code>src/environments/environment.ts</code> the use of the Boolean <code>loadExternalConfig</code> is seen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-TypeScript hljs" data-lang="TypeScript">// The file contents for the current environment will overwrite these during build.
// The build system defaults to the dev environment which uses `environment.ts`, but if you do
// `ng build --env=prod` then `environment.prod.ts` will be used instead.
// The list of which env maps to which file can be found in `.angular-cli.json`.

export const environment: {
  production: boolean;
  loadExternalConfig: boolean;
} = { production: false, loadExternalConfig: false };</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-a-app_initializer-configuration"><a class="anchor" href="#creating-a-app_initializer-configuration"></a>Creating a <code>APP_INITIALIZER</code> configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section is going to be used to create a new <code>APP_INITIALIZER</code> basic example. For this, a basic app with angular is going to be generated using <code>ng new "appname"</code> substituting <code>appname</code> for the name of the app opted.
If you are using Nx, the command would be <code>nx generate @nrwl/angular:app "appname"</code> in your Nx workspace. <a href="https://github.com/devonfw/devon4ng/wiki/guide-creating-angular-app-with-nx-cli">Click here</a> to get started with using Nx.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up-the-config-files"><a class="anchor" href="#setting-up-the-config-files"></a>Setting up the config files</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="docker-external-configuration-optional"><a class="anchor" href="#docker-external-configuration-optional"></a>Docker external configuration (Optional)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section is only done if there is a docker configuration in the app you are setting up this type of configuration.</p>
</div>
<div class="paragraph">
<p>1.- Create in the root folder <code>/docker-external-config.json</code>. This external config is going to be used when the application is loaded with docker (if the Boolean to load the external configuration is set to true). Here you need to add all the config parameter you want to load with docker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "version": "docker-version"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>2.- In the root, in the file <code>/Dockerfile</code> angular is going to copy the <code>docker-external-config.json</code> that was created before into the Nginx html route:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>....
COPY docker-external-config.json /usr/share/nginx/html/docker-external-config.json
....</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="external-json-configuration"><a class="anchor" href="#external-json-configuration"></a>External json configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>1.- Create a json file in the route <code>/src/external-config.json</code>. This external config is going to be used when the application is loaded with the start script (if the Boolean to load the external configuration is set to true). Here you need to add all the config parameter you want to load:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "version": "external-config"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>2.- The file named <code>/angular.json</code> (<code>/workspace.json</code> if using Nx) located at the root is going to be modified to add the file <code>external-config.json</code> that was just created to both <code>"assets"</code> inside <code>Build</code> and <code>Test</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">	....
	"build": {
          ....
            "assets": [
              "src/assets",
              "src/data",
              "src/favicon.ico",
              "src/manifest.json",
              "src/external-config.json"
            ]
	        ....
        "test": {
	  ....
	   "assets": [
              "src/assets",
              "src/data",
              "src/favicon.ico",
              "src/manifest.json",
              "src/external-config.json"
            ]
	  ....</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up-the-proxies"><a class="anchor" href="#setting-up-the-proxies"></a>Setting up the proxies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This step is going to setup two proxies. This is going to allow to load the config desired by the context, in case that it is using docker to load the app or in case it loads the app with angular. Loading different files is made possible by the fact that the <code>ConfigService</code> method <code>loadExternalConfig()</code> looks for the path <code>/config</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="docker-optional"><a class="anchor" href="#docker-optional"></a>Docker (Optional)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>1.- This step is going to be for docker. Add <code>docker-external-config.json</code> to Nginx configuration (<code>/nginx.conf</code>) that is in the root of the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>....
  location  ~ ^/config {
        alias /usr/share/nginx/html/docker-external-config.json;
  }
....</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="external-configuration"><a class="anchor" href="#external-configuration"></a>External Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>1.- Now the file <code>/proxy.conf.json</code>, needs to be created/modified this file can be found in the root of the application. In this file you can add the route of the external configuration in <code>target</code> and the name of the file in <code>^/config:</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">....
  "/config": {
    "target": "http://localhost:4200",
    "secure": false,
    "pathRewrite": {
      "^/config": "/external-config.json"
    }
  }
....</code></pre>
</div>
</div>
<div class="paragraph">
<p>2.- The file <code>package.json</code> found in the root of the application is gonna use the start script to load the proxy config that was just created :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">  "scripts": {
....
    "start": "ng serve --proxy-config proxy.conf.json -o",
....</code></pre>
</div>
</div>
<div class="paragraph">
<p>If using Nx, you need to run the command manually:</p>
</div>
<div class="paragraph">
<p><code>nx run angular-app-initializer:serve:development --proxyConfig=proxy.conf.json --o</code></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adding-the-loadexternalconfig-boolean-to-the-environments"><a class="anchor" href="#adding-the-loadexternalconfig-boolean-to-the-environments"></a>Adding the <code>loadExternalConfig</code> Boolean to the environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to load an external config we need to add the <code>loadExternalConfig</code> Boolean to the environments. To do so, inside the folder <code>environments/</code> the files are going to get modified adding this Boolean to each environment that is going to be used. In this case, only two environments are going to be modified (<code>environment.ts</code> and <code>environment.prod.ts</code>). Down below there is an example of the modification being done in the <code>environment.prod.ts</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-TypeScript hljs" data-lang="TypeScript">export const environment: {
  production: boolean;
  loadExternalConfig: boolean;
} = { production: false, loadExternalConfig: false };</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the file in first instance there is the declaration of the types of the variables. After that, there is the definition of those variables. This variable <code>loadExternalConfig</code> is going to be used by the service, allowing to setup a external config just by switching the <code>loadExternalConfig</code> to true.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-core-configuration-service"><a class="anchor" href="#creating-core-configuration-service"></a>Creating core configuration service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to create the whole configuration module three are going to be created:</p>
</div>
<div class="paragraph">
<p>1.- Create in the core <code>app/core/config/</code> a <code>config.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-TypeScript hljs" data-lang="TypeScript">  export interface Config {
    version: string;
  }

  export const config: Config = {
    version: 'dev'
  };</code></pre>
</div>
</div>
<div class="paragraph">
<p>Taking a look to this file, it creates a interface (<code>Config</code>) that is going to be used by the variable that exports (<code>export const config: Config</code>). This variable <code>config</code> is going to be used by the service that is going to be created.</p>
</div>
<div class="paragraph">
<p>2.- Create in the core <code>app/core/config/</code> a <code>config.service.ts</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-TypeScript hljs" data-lang="TypeScript">import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Config, config } from './config';

@Injectable()
export class ConfigService {
  constructor(private httpClient: HttpClient) {}

  static factory(appLoadService: ConfigService) {
    return () =&gt; appLoadService.loadExternalConfig();
  }

  // this method gets external configuration calling /config endpoint
  // and merges into config object
  loadExternalConfig(): Promise&lt;any&gt; {
    if (!environment.loadExternalConfig) {
      return Promise.resolve({});
    }

    const promise = this.httpClient
      .get('/config')
      .toPromise()
      .then((settings) =&gt; {
        Object.keys(settings || {}).forEach((k) =&gt; {
          config[k] = settings[k];
        });
        return settings;
      })
      .catch((error) =&gt; {
        return 'ok, no external configuration';
      });

    return promise;
  }

  getValues(): Config {
    return config;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As it was explained in previous steps, at first, there is a factory that uses the method <code>loadExternalConfig()</code>, this factory is going to be used in later steps in the module. After that, the <code>loadExternalConfig()</code> method checks if the Boolean in the environment is false. If it is false it will return the promise resolved with the normal config. Else, it is going to load the external config in the path (<code>/config</code>), and overwrite the values from the external config to the config that&#8217;s going to be used by the app, this is all returned in a promise.</p>
</div>
<div class="paragraph">
<p>3.- Create in the core a module for the config <code>app/core/config/</code> a <code>config.module.ts</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-TypeScript hljs" data-lang="TypeScript">import { NgModule, APP_INITIALIZER } from '@angular/core';
import { HttpClientModule } from '@angular/common/http';

import { ConfigService } from './config.service';

@NgModule({
  imports: [HttpClientModule],
  providers: [
    ConfigService,
    {
      provide: APP_INITIALIZER,
      useFactory: ConfigService.factory,
      deps: [ConfigService],
      multi: true,
    },
  ],
})
export class ConfigModule {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As seen earlier, the <code>ConfigService</code> is added to the module. In this addition, the app is initialized(<code>provide</code>) and it uses the factory that was created in the <code>ConfigService</code> loading the config with or without the external values depending on the Boolean in the <code>config</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-the-config-service"><a class="anchor" href="#using-the-config-service"></a>Using the Config Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a first step, in the file <code>/app/app.module.ts</code> the <code>ConfigModule</code> created earlier in the other step is going to be imported:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-TypeScript hljs" data-lang="TypeScript">  imports: [
    ....
    ConfigModule,
    ....
  ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that, the <code>ConfigService</code> is going to be injected into the <code>app.component.ts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-TypeScript hljs" data-lang="TypeScript">....
import { ConfigService } from './core/config/config.service';
....
export class AppComponent {
....
  constructor(public configService: ConfigService) { }
....</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, for this demonstration app, the component <code>app/app.component.html</code> is going to show the version of the config it is using at that moment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;div style="text-align:center"&gt;
  &lt;h1&gt;
    Welcome to {{ title }}!
  &lt;/h1&gt;
&lt;/div&gt;
&lt;h2&gt;Here is the configuration version that is using angular right now: {{configService.getValues().version}}&lt;/h2&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="final-steps"><a class="anchor" href="#final-steps"></a>Final steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The script <code>start</code> that was created earlier in the <code>package.json</code> (<code>npm start</code>) is going to be used to start the application. After that, modifying the Boolean <code>loadExternalConfig</code> inside the corresponding environment file inside <code>/app/environments/</code> should show the different config versions.</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="images/loadExternalConfigFalse.png"><img src="../_images/images/app-initializer/loadExternalConfigFalse.png" alt="loadExternalConfigFalse"></a>
</div>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="images/loadExternalConfigTrue.png"><img src="../_images/images/app-initializer/loadExternalConfigTrue.png" alt="loadExternalConfigTrue"></a>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
