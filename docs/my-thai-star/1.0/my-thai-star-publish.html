<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Devonfw.github.io Docs</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">Devonfw.github.io Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="my-thai-star" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">My-thai-star</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../architecture-guidelines/1.0/index.html">Architecture-guidelines</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../architecture-guidelines/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../cicdgen/1.0/index.html">Cicdgen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../cicdgen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../cobigen/1.0/index.html">Cobigen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../cobigen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../dashboard/1.0/index.html">Dashboard</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../dashboard/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devon4j/1.0/index.html">Devon4j</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devon4j/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devon4net/1.0/index.html">Devon4net</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devon4net/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devon4ng/1.0/index.html">Devon4ng</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devon4ng/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devon4node/1.0/index.html">Devon4node</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devon4node/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devon4quarkus/1.0/index.html">Devon4quarkus</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devon4quarkus/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devon4ts/1.0/index.html">Devon4ts</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devon4ts/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devonfw.github.io/1.0/index.html">devonfw.github.io</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devonfw.github.io/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../getting-started/1.0/index.html">Getting-started</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../getting-started/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../github/1.0/index.html">Github</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../github/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../hangar/1.0/index.html">Hangar</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../hangar/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../ide/1.0/index.html">IDE</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../ide/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../jump-the-queue/1.0/index.html">Jump-the-queue</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../jump-the-queue/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../mrchecker/1.0/index.html">Mrchecker</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../mrchecker/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="index.html">My-thai-star</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../production-line/1.0/index.html">Production-line</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../production-line/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../shop-floor/1.0/index.html">Shop-floor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../shop-floor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../solicitor/1.0/index.html">Solicitor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../solicitor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../sonar-devon4j-plugin/1.0/index.html">Sonar-devon4j-plugin</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../sonar-devon4j-plugin/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../devonfw.github.io/1.0/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/MarvDan/my-thai-star/edit/develop/modules/ROOT/pages/my-thai-star-publish.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_publishing_the_mythaistar_application">Publishing the <code>MyThaiStar</code> Application</a></li>
<li><a href="#_production_line_instance">Production Line Instance</a></li>
<li><a href="#_pipeline_script">Pipeline Script</a></li>
<li><a href="#_complete_pipeline_script">Complete Pipeline Script:</a></li>
<li><a href="#_accessing_mythaistar">Accessing <code>MyThaiStar</code></a></li>
<li><a href="#_notes">Notes</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="_publishing_the_mythaistar_application"><a class="anchor" href="#_publishing_the_mythaistar_application"></a>Publishing the <code>MyThaiStar</code> Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This page will explain how to build and deploy the application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_production_line_instance"><a class="anchor" href="#_production_line_instance"></a>Production Line Instance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Production Line instance being used can be found <a href="https://devon.s2-eu.capgemini.com">here</a>. After logging in you&#8217;ll see a list of existing jobs and pipelines.
However, only a folder is relevant to this topic: <strong>MTS</strong></p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: A user account is required for authentication. Contact a devon team member to request a new account.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pipeline_script"><a class="anchor" href="#_pipeline_script"></a>Pipeline Script</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll have a closer look at the pipeline configuration script and its stages:</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: Have a look at this wiki over <code><a href="https://github.com/devonfw/devon-ci/wiki/guide-devonci-jenkins-pipeline">here</a></code> to get a basic idea on how to write pipeline scripts.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Checking out MyThaiStar form GitHub</p>
<div class="paragraph">
<p>This stage will check out the source code directly from GitHub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">git credentialsId:'github-devonfw-ci', url:'https://github.com/devonfw/my-thai-star/'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Credentials are required for authentication as we&#8217;re checking out a private repository. <code>'github-devonfw-ci'</code> is a pair of credentials that was created for this sole purpose.</p>
</div>
</li>
<li>
<p>Loading custom tools</p>
<div class="paragraph">
<p>To build the application, two tools are required: Node 6 and Angular CLI.</p>
</div>
<div class="paragraph">
<p>They just have to be referenced, as the Custom Tool Plugin will handle the installation process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">tool 'Node 6'
tool 'Angular CLI'</code></pre>
</div>
</div>
</li>
<li>
<p>Fresh Dependency installation
To ensure that we get fresh dependencies, we&#8217;ll have to make sure that our dependencies folder <em>node_modules</em> is removed and the installation process is run again.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">find . -name "node_modules" -exec rm -rf '{}' +
npm i</code></pre>
</div>
</div>
</li>
<li>
<p>Code Linting</p>
<div class="paragraph">
<p>By "linting" our Angular code we check the quality of the code. TypeScript provides a useful tool for that. It is call <strong>TSLint</strong>. This process is triggered via Angular CLI.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">ng lint --format checkstyle</code></pre>
</div>
</div>
</li>
<li>
<p>Execute Unit Tests</p>
<div class="paragraph">
<p>By default, Angular tests are executed using the Chrome browser. That can be a problem when they need to be executed in a CI environment, such as Jenkins (which is the case) or Travis. Angular projects can be prepared to deal with it, using the PhantomJS browser instead of chrome.</p>
</div>
<div class="paragraph">
<p>We can prepare a script for that in our <code>package.json</code> file, or we can directly write it in the command line. Also, it is necessary to make sure that those test will just executed once, because by default it will be watching for changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">ng test --browsers PhantomJS --single-run</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">yarn test:ci</code></pre>
</div>
</div>
</li>
<li>
<p>Build application</p>
<div class="paragraph">
<p>The building process needs to be sufficiently flexible to be adapted for different deployments. As long as the My Thai Star Angular client needs (or <em>will need</em>) to point to different servers (devon4j, Node and .NET), it is mandatory to have the chance to separately "prepare" the artifact for all of them.</p>
</div>
<div class="paragraph">
<p>What does that mean? There are some files dedicated to those situations. They&#8217;re called <em>environment</em>. They&#8217;ll define some data to be used under different circumstances.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">ng build --aot --environment=prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">yarn build:prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>ng build</em> command creates a <em>dist</em> folder which contains the application.</p>
</div>
</li>
<li>
<p>Deployment</p>
<div class="paragraph">
<p>The deployment step has to be approved by a human. Otherwise it won&#8217;t proceed.</p>
</div>
<div class="paragraph">
<p>The user can decide on whether to proceed and deploy the application or to abort and just keep the generated files inside the <em>dist</em> directory.</p>
</div>
<div class="paragraph">
<p>After clicking on proceed, the following lines will be executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">##Change to Angular directory
cd angular

##Copy "dist" folder from workspace to deployment server
scp -o StrictHostKeyChecking=no -r dist root@10.40.235.244:/root/mythaistar/

##Launch application in Docker container
ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker rm -f mythaistar
ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker run -itd --name=mythaistar -p 8090:80 nginx
ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker exec mythaistar bash -c \\"rm /usr/share/nginx/html/*\\"
ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker cp mythaistar/dist/. mythaistar:/usr/share/nginx/html/</code></pre>
</div>
</div>
<div class="paragraph">
<p>After deploying the application will be available at <a href="http://de-mucdevondepl01:8090">http://de-mucdevondepl01:8090</a></p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_complete_pipeline_script"><a class="anchor" href="#_complete_pipeline_script"></a>Complete Pipeline Script:</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The complete Groovy script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">node {
    stage 'Checking out my-thai-star from GitHub'
        node {
            git branch: 'develop', credentialsId: 'github-devonfw-ci', url: 'https://github.com/devonfw/my-thai-star/'
        }

    stage 'Loading Custom Tools'
        node {
            tool 'Node 6'
            tool 'Angular CLI'
        }

    stage 'Fresh Dependency Installation'
        node {
            sh """
                cd angular
                find . -name "node_modules" -exec rm -rf '{}' +
                npm i
            """
        }

    stage 'Code Linting'
        node {
            sh """
                cd angular
                ng lint --format checkstyle
            """
        }

    stage 'Execute Angular tests'
        node {
            sh """
                cd angular
                ng test --browsers PhantomJS --single-run
            """
        }

    stage 'Build Application'
        node {
            sh """
                cd angular
                ng build --aot --prod
            """
        }

    stage 'Deployment'
        input 'Should this build be deployed?'
            node {
                sshagent (credentials: ['3d0fa2a4-5cf0-4cf5-a3fd-23655eb33c11']) {
                    sh """
                        cd angular
                        # Copy resulting "dist" folder from workspace to deployment server
                        scp -o StrictHostKeyChecking=no -r dist root@10.40.235.244:/root/mythaistar/

                        # Launch application in Docker container
                        ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker rm -f mythaistar
                        ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker run -itd --name=mythaistar -p 8090:80 nginx
                        ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker exec mythaistar bash -c \\"rm /usr/share/nginx/html/*\\"
                        ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker cp mythaistar/dist/. mythaistar:/usr/share/nginx/html/

                    """
                }
                sh 'echo \\"Application available at http://de-mucdevondepl01:8090\\"'
            }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_accessing_mythaistar"><a class="anchor" href="#_accessing_mythaistar"></a>Accessing <code>MyThaiStar</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Finally, the application will be available at this URL: <a href="http://de-mucdevondepl01:8090">http://de-mucdevondepl01:8090</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_notes"><a class="anchor" href="#_notes"></a>Notes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure not to launch multiple instances of this pipeline in parallel. While a pipeline is waiting for approval it&#8217;ll still be blocking a build executor.
This PL instance is set up to have <strong>two</strong> build executors.</p>
</div>
<div class="paragraph">
<p>This means: When launching this pipeline two times in parallel without approving the build, other jobs/pipeline won&#8217;t be able
to run properly.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
