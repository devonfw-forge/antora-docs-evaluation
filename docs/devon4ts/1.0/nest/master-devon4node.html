<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Devonfw.github.io Docs</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">Devonfw.github.io Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="devon4ts" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">Devon4ts</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../architecture-guidelines/1.0/index.html">Architecture-guidelines</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../architecture-guidelines/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../cicdgen/1.0/index.html">Cicdgen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../cicdgen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../cobigen/1.0/index.html">Cobigen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../cobigen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../dashboard/1.0/index.html">Dashboard</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../dashboard/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4j/1.0/index.html">Devon4j</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4j/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4net/1.0/index.html">Devon4net</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4net/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4ng/1.0/index.html">Devon4ng</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4ng/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4node/1.0/index.html">Devon4node</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4node/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devon4quarkus/1.0/index.html">Devon4quarkus</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devon4quarkus/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">Devon4ts</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../devonfw.github.io/1.0/index.html">devonfw.github.io</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../devonfw.github.io/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../getting-started/1.0/index.html">Getting-started</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../getting-started/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../github/1.0/index.html">Github</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../github/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../hangar/1.0/index.html">Hangar</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../hangar/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../ide/1.0/index.html">IDE</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../ide/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../jump-the-queue/1.0/index.html">Jump-the-queue</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../jump-the-queue/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../mrchecker/1.0/index.html">Mrchecker</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../mrchecker/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../my-thai-star/1.0/index.html">My-thai-star</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../my-thai-star/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../production-line/1.0/index.html">Production-line</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../production-line/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../shop-floor/1.0/index.html">Shop-floor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../shop-floor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../solicitor/1.0/index.html">Solicitor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../solicitor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../sonar-devon4j-plugin/1.0/index.html">Sonar-devon4j-plugin</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../sonar-devon4j-plugin/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../devonfw.github.io/1.0/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/MarvDan/devon4ts/edit/master/modules/ROOT/pages/nest/master-devon4node.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="sect1">
<h2 id="_nodejs"><a class="anchor" href="#_nodejs"></a>NodeJS</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.devonfw.com/">devonfw</a> is a platform which provides solutions to building business applications which combine best-in-class frameworks and libraries as well as industry proven practices and code conventions. devonfw is 100% Open Source (Apache License version 2.0) since the beginning of 2018.</p>
</div>
<div class="paragraph">
<p>devon4node is the NodeJS stack of devonfw. It allows you to build business applications (backends) using NodeJS technology in standardized way based on established best-practices.</p>
</div>
<div class="paragraph">
<p>devon4node is based on <a href="https://nestjs.com/">NestJS</a>. Nest (NestJS) is a framework for building efficient, scalable Node.js server-side applications. It uses progressive TypeScript and combines elements of OOP (Object Oriented Programming), FP (Functional Programming), and FRP (Functional Reactive Programming).</p>
</div>
<!-- toc disabled -->
<div class="sect2">
<h3 id="devon4node-architecture"><a class="anchor" href="#devon4node-architecture"></a>devon4node Architecture</h3>
<div class="paragraph">
<p>As we have mentioned in the introduction, devon4node is based on <a href="https://nestjs.com/">NestJS</a>. Nest (NestJS) is a framework for building efficient, scalable Node.js server-side applications.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-layer"><a class="anchor" href="#http-layer"></a>HTTP layer</h3>
<div class="paragraph">
<p>By using <a href="https://nestjs.com/">NestJS</a>, devon4node is a platform-agnostic framework. NestJS focuses only on the logical layer, and delegates the transport layer to another framework, such as ExpressJS. You can see it in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/images/devon4node-architecture.png" alt="devon4node architecture">
</div>
</div>
<div class="paragraph">
<p>As you can see, NestJS do not listen directly for incoming request. It has an adapter to communicate with ExpressJS and ExpressJS is the responsible for that. ExpressJS is only one of the frameworks that NestJS can work with. We have also another adapter available out-of-the-box: the <a href="https://www.fastify.io/">Fastify</a> adapter. With that, you can replace ExpressJS for Fastify But you can still use all your NestJS components. You can also create your own adapter to make NestJS work with other HTTP framework.</p>
</div>
<div class="paragraph">
<p>At this point, you may think: why is NestJS (and devon4node) using ExpressJS by default instead of Fastify? Because, as you can see in the previous diagram, there is a component that is dependent on the HTTP framework: the middleware. As ExpressJS is the most widely used framework, there exists a lot of middleware for it, so, in order to reuse them in our NestJS applications, NestJS use ExpressJS by default. Anyway, you may think which HTTP framework best fits your requirements.</p>
</div>
</div>
<div class="sect2">
<h3 id="devon4node-layers"><a class="anchor" href="#devon4node-layers"></a>devon4node layers</h3>
<div class="paragraph">
<p>As other devonfw technologies, devon4node separates the application into layers.</p>
</div>
<div class="paragraph">
<p>Those layers are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="layer-controller">Controller layer</a></p>
</li>
<li>
<p><a href="layer-service">Service layer</a></p>
</li>
<li>
<p><a href="layer-dataaccess">Data Access layer</a></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/images/plantuml/layers.png" alt="layers">
</div>
</div>
</div>
<div class="sect2">
<h3 id="devon4node-application-structure"><a class="anchor" href="#devon4node-application-structure"></a>devon4node application structure</h3>
<div class="paragraph">
<p>Although there are many frameworks to create backend applications in NodeJS, none of them effectively solve the main problem of - Architecture. This is the main reason we have chosen NestJS for the devon4node applications. Besides, NestJS is highly inspired by <a href="https://angular.io/">Angular</a>, therefore a developer who knows Angular can use his already acquired knowledge to write devon4node applications.</p>
</div>
<div class="paragraph">
<p>NestJS adopts various Angular concepts, such as dependency injection, piping, interceptors and modularity, among others. By using modularity we can reuse some of our modules between applications. One example that devon4node provide is the <a href="guides-mailer">mailer module</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="modules"><a class="anchor" href="#modules"></a>Modules</h3>
<div class="paragraph">
<p>Create a application module is simple, you only need to create an empty class with the decorator <code>Module</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Module({})
export class AppModule {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the module you can define:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Imports: the list of imported modules that export the providers which are required in this module</p>
</li>
<li>
<p>Controllers: the set of controllers defined in this module which have to be instantiated</p>
</li>
<li>
<p>Providers: the providers that will be instantiated by the Nest injector and that may be shared at least across this module</p>
</li>
<li>
<p>Exports: the subset of providers that are provided by this module and should be available in other modules which import this module</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The main difference between Angular and NestJS is NestJS modules encapsulates providers by default. This means that it&#8217;s impossible to inject providers that are neither directly part of the current module nor exported from the imported modules. Thus, you may consider the exported providers from a module as the module&#8217;s public interface, or API. Example of modules graph:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/images/plantuml/modules.png" alt="modules">
</div>
</div>
<div class="paragraph">
<p>In devon4node we three different kind of modules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AppModule</code>: this is the root module. Everything that our application need must be imported here.</p>
</li>
<li>
<p>Global Modules: this is a special kind of modules. When you make a module global, it&#8217;s accessible for every module in your application. Your can see it in the next diagram. It&#8217;s the same as the previous one, but now the <code>CoreModule</code> is global:</p>
<div class="imageblock">
<div class="content">
<img src="../_images/images/plantuml/module2.png" alt="module2">
</div>
</div>
<div class="paragraph">
<p>One example of global module is the <code>CoreModule</code>. In the <code>CoreModule</code> you must import every module which have providers that needs to be accessible in all modules of you application</p>
</div>
</li>
<li>
<p>Feature (or application) modules: modules which contains the logic of our application. We must import it in the <code>AppModule</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about modules, see <a href="https://docs.nestjs.com/modules">NestJS documentation page</a></p>
</div>
</div>
<div class="sect2">
<h3 id="folder-structure"><a class="anchor" href="#folder-structure"></a>Folder structure</h3>
<div class="paragraph">
<p>devon4node defines a folder structure that every devon4node application must follow. The folder structure is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>├───src
│   ├───app
│   │   ├───core
│   │   │   ├───auth
│   │   │   ├───configuration
│   │   │   ├───user
│   │   │   └───core.module.ts
│   │   ├───shared
│   │   └───feature
│   │       ├───sub-module
│   │       │   ├───controllers
│   │       │   ├───...
│   │       │   ├───services
│   │       │   └───sub-module.module.ts
│   │       ├───controllers
│   │       ├───interceptors
│   │       ├───pipes
│   │       ├───guards
│   │       ├───filters
│   │       ├───middlewares
│   │       ├───model
│   │       │   ├───dto
│   │       │   └───entities
│   │       ├───services
│   │       └───feature.module.ts
│   ├───config
│   └───migration
├───test
└───package.json</pre>
</div>
</div>
<div class="paragraph">
<p><a href="guides-code-generation">devon4node schematics</a> ensures this folder structure so, please, do not create files by your own, use the <a href="guides-code-generation">devon4node schematics</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="nestjs-components"><a class="anchor" href="#nestjs-components"></a>NestJS components</h3>
<div class="paragraph">
<p>NestJS provides several components that you can use in your application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.nestjs.com/controllers">Controllers</a></p>
</li>
<li>
<p><a href="https://docs.nestjs.com/providers">Providers</a></p>
</li>
<li>
<p><a href="https://docs.nestjs.com/middleware">Middleware</a></p>
</li>
<li>
<p><a href="https://docs.nestjs.com/guards">Guards</a></p>
</li>
<li>
<p><a href="https://docs.nestjs.com/interceptors">Interceptors</a></p>
</li>
<li>
<p><a href="https://docs.nestjs.com/pipes">Pipes</a></p>
</li>
<li>
<p><a href="https://docs.nestjs.com/exception-filters">Exception filters</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the <a href="https://docs.nestjs.com">NestJS documentation</a> you can find all information about each component. But, something that is missing in the documentation is the execution order. Every component can be defined in different levels: globally, in the controller or in the handler. As middleware is part of the HTTP server we can define it in a different way: globally or in the module.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/images/plantuml/components.png" alt="components">
</div>
</div>
<div class="paragraph">
<p>It is not necessary to have defined components in every level. For example, you can have defined a interceptor globally but you do not have any other in the controller or handler level. If nothing is defined in some level, the request will continue to the next component.</p>
</div>
<div class="paragraph">
<p>As you can see in the previous image, the first component which receive the request is the global defined middleware. Then, it send the request to the module middleware. Each of them can return a response to the client, without passing the request to the next level.</p>
</div>
<div class="paragraph">
<p>Then, the request continue to the guards: first the global guard, next to controller guard and finally to the handler guard. At this point, we can throw an exception in all components and the exception filter will catch it and send a proper error message to the client. We do not paint the filters in the graphic in order to simplify it.</p>
</div>
<div class="paragraph">
<p>After the guards, is time to interceptors: global interceptors, controller interceptors and handler interceptors. And last, before arrive to the handler inside the controller, the request pass through the pipes.</p>
</div>
<div class="paragraph">
<p>When the handler has the response ready to send to the client, it does not go directly to the client. It come again to the interceptors, so we can also intercept the response. The order this time is the reverse: handler interceptors, controller interceptors and global interceptors. After that, we can finally send the response to the client.</p>
</div>
<div class="paragraph">
<p>Now, with this in mind, you are able to create the components in a better way.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="layers"><a class="anchor" href="#layers"></a>Layers</h2>
<div class="sectionbody">
<!-- toc disabled -->
<div class="sect3">
<h4 id="controller-layer"><a class="anchor" href="#controller-layer"></a>Controller Layer</h4>
<div class="paragraph">
<p>The controller layer is responsible for handling the requests/responses to the client. This layer knows everything about the endpoints exposed, the expected input (and also <a href="guides-validation">validate</a> it), the response schema, the HTTP codes for the response and the HTTP errors that every endpoint can send.</p>
</div>
</div>
<div class="sect3">
<h4 id="how-to-implement-the-controller-layer"><a class="anchor" href="#how-to-implement-the-controller-layer"></a>How to implement the controller layer</h4>
<div class="paragraph">
<p>This layer is implemented by the <a href="https://docs.nestjs.com/controllers">NestJS controllers</a>. Let&#8217;s see how it works with an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Controller('coffee/coffees')
export class CoffeeController {
  constructor(private readonly coffeeService: CoffeeService) {}

  @Post('search')
  @HttpCode(200)
  async searchCoffees(@Body() search: CoffeeSearch): Promise&lt;Array&lt;Coffee&gt;&gt; {
    try {
      return await this.coffeeService.searchCoffees(search);
    } catch (error) {
      throw new BadRequestException(error.message, error);
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see in the example, to create a controller you only need to decorate a class with the <code>Controller</code> decorator. This example is handling all request to <code>coffee/coffees</code>.</p>
</div>
<div class="paragraph">
<p>Also, you have defined one handler. This handler is listening to POST request for the route <code>coffee/coffees/search</code>. In addition, this handler is waiting for a <code>CoffeeSearch</code> object and returns an array of Coffee. In order to keep it simple, that&#8217;s all that you need in order to define one route.</p>
</div>
<div class="paragraph">
<p>One important thing that can be observed in this example is that there is no business logic. It delegates to the service layer and return the response to the client. At this point, transformations from the value that you receive from the service layer to the desired return type are also allowed.</p>
</div>
<div class="paragraph">
<p>By default, every POST handler return an HTTP 204 response with the returned value as body, but you can change it in a easy way by using decorators. As you can see in the example, the handler will return a HTTP 200 response (<code>@HttpCode(200)</code>).</p>
</div>
<div class="paragraph">
<p>Finally, if the service layer throws an error, this handler will catch it and return a HTTP 400 Bad Request response. The controller layer is the only one that knows about the answers to the client, therefore it is the only one that knows which error codes should be sent.</p>
</div>
</div>
<div class="sect3">
<h4 id="validation"><a class="anchor" href="#validation"></a>Validation</h4>
<div class="paragraph">
<p>In order to do not propagate errors in the incoming payload, we need to validate all data in the controller layer. See the <a href="guides-validation">validation guide</a> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="error-handling"><a class="anchor" href="#error-handling"></a>Error handling</h4>
<div class="paragraph">
<p>In the previous example, we catch all errors using the try/catch statement. This is not the usual implementation. In order to catch properly the errors you must use the <a href="https://docs.nestjs.com/exception-filters">exception filters</a>. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Controller('coffee/coffees')
export class CoffeeController {
  constructor(private readonly coffeeService: CoffeeService) {}

  @Post('search')
  @HttpCode(200)
  @UseFilters(CaffeExceptionFilter)
  async searchCoffees(@Body() search: CoffeeSearch): Promise&lt;Array&lt;Coffee&gt;&gt; {
    return await this.coffeeService.searchCoffees(search);
  }
}</code></pre>
</div>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="service-layer"><a class="anchor" href="#service-layer"></a>Service Layer</h4>
<div class="paragraph">
<p>The logic layer is the heart of the application and contains the main business logic. It knows everything about the business logic, but it does not know about the response to the client and the HTTP errors. That&#8217;s why this layer is separated from the controller layer.</p>
</div>
</div>
<div class="sect3">
<h4 id="how-to-implement-the-service-layer"><a class="anchor" href="#how-to-implement-the-service-layer"></a>How to implement the service layer</h4>
<div class="paragraph">
<p>This layer is implemented by services, a specific kind of <a href="https://docs.nestjs.com/providers">providers</a>. Let&#8217;s see one example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Injectable()
export class CoffeeService {
  constructor(private readonly coffeeService: CoffeeService) {}

  async searchCoffees(@InjectRepository(Coffee) coffeeRepository: Repository&lt;Coffee&gt;): Promise&lt;Array&lt;Coffee&gt;&gt; {
    const coffees = this.coffeeRepository.find();

    return doSomeBusinessLogic(coffees);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the <code>CoffeeService</code> that we inject in the example of <a href="layer-controller">controller layer</a>. As you can see, a service is a regular class with the <code>Injectable</code> decorator. Also, it inject as dependency the data access layer (in this specific case, the Repository&lt;Coffee&gt;).</p>
</div>
<div class="paragraph">
<p>The services expose methods in order to transform the input from the controllers by applying some business logic. They can also request data from the data access layer. And that&#8217;s all.</p>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="data-access-layer"><a class="anchor" href="#data-access-layer"></a>Data Access Layer</h4>
<div class="paragraph">
<p>The data access layer is responsible for all outgoing connections to access and process data. This is mainly about accessing data from a persistent data-store but also about invoking external services.</p>
</div>
<div class="paragraph">
<p>This layer is implemented using providers. Those providers could be: services, repositories and others. Although services can be used for this layer, they should not be confused with the service layer. Services in this layer are responsible for data access, while services in the service layer are responsible for business logic.</p>
</div>
</div>
<div class="sect3">
<h4 id="database"><a class="anchor" href="#database"></a>Database</h4>
<div class="paragraph">
<p>We strongly recommend <a href="https://typeorm.io">TypeORM</a> for database management in devon4node applications. Although services can be used for this layer, they should not be confused with the service layer. Services in this layer are responsible for data access, while services in the service layer are responsible for business logic. TypeORM supports the most commonly used relational databases, link Oracle, MySQL, MariaDB, PostgreSQL, SQLite, MSSQL and others. Also, it supports no-relational databases like MongoDB.</p>
</div>
<div class="paragraph">
<p>TypeORM supports <a href="https://en.wikipedia.org/wiki/Active_record_pattern">Active Record</a> and Repository patterns. We recommend to use the Repository pattern. This pattern allows you to separate the data objects from the methods to manipulate the database.</p>
</div>
</div>
<div class="sect3">
<h4 id="external-apis"><a class="anchor" href="#external-apis"></a>External APIs</h4>
<div class="paragraph">
<p>In order to manage the data in a external API, you need to create a service for that purpose. In order to manage the connections with the external API, we strongly recommend the <a href="https://docs.nestjs.com/techniques/http-module">NestJS HTTP module</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="guides"><a class="anchor" href="#guides"></a>Guides</h2>
<div class="sectionbody">
<!-- toc disabled -->
<div class="sect3">
<h4 id="key-principles"><a class="anchor" href="#key-principles"></a>Key Principles</h4>
<div class="paragraph">
<p>devon4node is built following some basic principles like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://en.wikipedia.org/wiki/SOLID">SOLID</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Software_design_pattern">Patterns</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Open-source_model">Open</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>But key principles that best define devon4node (and are inherited from NestJS) are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Simplicity (aka <a href="https://en.wikipedia.org/wiki/KISS_principle">KISS</a>)</p>
</li>
<li>
<p>Reusability</p>
</li>
<li>
<p>Productivity</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="simplicity"><a class="anchor" href="#simplicity"></a>Simplicity</h4>
<div class="paragraph">
<p>In devon4node we tried to do everything as simple as possible. Following this principle we will be able to do easy to maintain applications.</p>
</div>
<div class="paragraph">
<p>For example, in order to expose all CRUD operations for an entity, you only need to create a controller like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Crud({
  model: {
    type: Employee,
  },
})
@CrudType(Employee)
@Controller('employee/employees')
export class EmployeeCrudController {
  constructor(public service: EmployeeCrudService) {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can find this code in the <a href="samples">employee example</a>. Only with this code your exposing the full CRUD operations for the employee entity. As you can see, it&#8217;s an empty class with some decorators and the <code>EmployeeCrudService</code> injected as dependency. Simple, isn&#8217;t it? The <code>EmployeeCrudService</code> is also simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Injectable()
export class EmployeeCrudService extends TypeOrmCrudService&lt;Employee&gt; {
  constructor(@InjectRepository(Employee) repo: Repository&lt;Employee&gt;) {
    super(repo);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another empty class which extends from <code>TypeOrmCrudService&lt;Employee&gt;</code> and injects the Employee Repository as dependency. Nothing else.</p>
</div>
<div class="paragraph">
<p>With these examples you can get an idea of how simple it can be to code a devon4node application .</p>
</div>
</div>
<div class="sect3">
<h4 id="reusability"><a class="anchor" href="#reusability"></a>Reusability</h4>
<div class="paragraph">
<p>NestJS (and devon4node) applications are designed in a modular way. This allows you to isolate some functionality in a module, and then reuse it in every application that you need. This is the same behaviour that Angular has. You can see it in the NestJS modules like <a href="https://github.com/nestjs/typeorm">TypeORM</a>, <a href="https://github.com/nestjs/swagger">Swagger</a> and others. Also, in devon4node we have the <a href="https://www.npmjs.com/package/@devon4node/mailer">Mailer module</a>.</p>
</div>
<div class="paragraph">
<p>In your applications, you only need to import those modules and then you will be able to use the functionality that they implement. Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Module({
  imports: [ AuthModule, ConfigurationModule ],
})
export class SomeModule {}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="productivity"><a class="anchor" href="#productivity"></a>Productivity</h4>
<div class="paragraph">
<p>devon4node is designed to create secure enterprise applications. But also, it allow you to do it in a fast way. To increase the productivity devon4node, devon4node provide schematics in order to generate some boilerplate code.</p>
</div>
<div class="paragraph">
<p>For example, to create a module you need to create a new file for a module (or copy it) and write the code, then you need to import it in the <code>AppModule</code>. This is a easy example, but you can introduce some errors: forget to import it in the <code>AppModule</code>, introduce errors with the copy/paste and so on. By using the command <code>nest g module --name &lt;module-name&gt;</code> it will do everything for you. Just a simple command. In this specific case probably you do not see any advantage, but there are other complex cases where you can generate more complex code with nest and devon4node schematics command.</p>
</div>
<div class="paragraph">
<p>See <a href="guides-code-generation">code generation</a> in order to know how to increase your productivity creating devon4node applications.</p>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="code-generation"><a class="anchor" href="#code-generation"></a>Code Generation</h4>
<div class="paragraph">
<p>As we mention in the page <a href="guide-key-principles">key principles</a>, one of our key principles is Productivity. In order to provide that productivity, we have some tools to generate code. These tools will help you generate the common parts of the application so that you can focus only on the specific functionality.</p>
</div>
<div class="paragraph">
<p>Those tools are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.npmjs.com/package/@devon4node/schematics">devon4node schematics through Nest CLI</a></p>
</li>
<li>
<p><a href="https://github.com/devonfw/cobigen">CobiGen</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="nest-cli-and-devon4node-schematics"><a class="anchor" href="#nest-cli-and-devon4node-schematics"></a>Nest CLI and Devon4node schematics</h4>
<div class="paragraph">
<p>We are going to use the Nest CLI to generate code of our application, you can know more about NodeJs CLI in the official <a href="https://docs.nestjs.com/cli/overview:">documentation</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="install-devon4node-schematics"><a class="anchor" href="#install-devon4node-schematics"></a>Install devon4node schematics</h4>
<div class="paragraph">
<p>First of all, you need to install Nest CLI</p>
</div>
<div class="paragraph">
<p>Execute the command <code>yarn global add @nestjs/cli</code>.
You can also use npm: <code>npm install -g @nestjs/cli</code></p>
</div>
<div class="paragraph">
<p>And then Devon4node schematics globally with the following command:</p>
</div>
<div class="paragraph">
<p><code>yarn global add @devon4node/schematics</code> or <code>npm install -g @devon4node/schematics</code></p>
</div>
</div>
<div class="sect3">
<h4 id=""><a class="anchor" href="#"></a>==</h4>
<div class="paragraph">
<p>If you get an error trying execute any devon4node schematic related to collection not found, try to reinstall devon4node/schematics on the project folder or be sure that schematics folder is inside @devon4node in node_modules.
<code>yarn add @devon4node/schematics</code>
== ==</p>
</div>
</div>
<div class="sect3">
<h4 id="generate-new-devon4node-application"><a class="anchor" href="#generate-new-devon4node-application"></a>Generate new devon4node application</h4>
<div class="paragraph">
<p>To start creating a devon4node application, execute the command:</p>
</div>
<div class="paragraph">
<p><code>nest g -c @devon4node/schematics application [application-name]</code></p>
</div>
<div class="paragraph">
<p>If you do not put a name, the command line will ask you for one.</p>
</div>
</div>
<div class="sect3">
<h4 id="generate-code-for-typeorm"><a class="anchor" href="#generate-code-for-typeorm"></a>Generate code for TypeORM</h4>
<div class="paragraph">
<p>Initialize TypeORM into your current project in a correct way.</p>
</div>
<div class="paragraph">
<p><code>nest g -c @devon4node/schematics typeorm</code></p>
</div>
<div class="paragraph">
<p>Then, you will be asked about which DB you want to use.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/images/typeorm-schematic.PNG" alt="typeorm schematic"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="generate-crud"><a class="anchor" href="#generate-crud"></a>Generate CRUD</h4>
<div class="paragraph">
<p>Generate CRUD methods for a entity. Requires TypeORM installed in the project.</p>
</div>
<div class="paragraph">
<p>It will add the @nestjsx/crud module as a project dependency. Then, generates an entity, a CRUD controller and a CRUD service. It also register the entity, controller and service in the module.</p>
</div>
<div class="paragraph">
<p>Execute <code>nest g -c @devon4node/schematics crud</code> and then you will need to write a name for the crud.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/images/crud-schematic.PNG" alt="crud schematic">
</div>
</div>
</div>
<div class="sect3">
<h4 id="generate-typeorm-entity"><a class="anchor" href="#generate-typeorm-entity"></a>Generate TypeORM entity</h4>
<div class="paragraph">
<p>Add a TypeORM entity to your project. Requires TypeORM installed in the project.</p>
</div>
<div class="paragraph">
<p>Execute <code>nest g -c @devon4node/schematics entity</code> and you will be asked for an entity name.</p>
</div>
</div>
<div class="sect3">
<h4 id="add-config-module"><a class="anchor" href="#add-config-module"></a>Add config-module</h4>
<div class="paragraph">
<p>Add the config module to the project.</p>
</div>
<div class="paragraph">
<p>It will add the @devon4node/common module as a project dependency. Then, it will generate the configuration module into your project and add it in the core module. Also, it generates the config files for the most common environments.</p>
</div>
<div class="paragraph">
<p>The command to execute will be <code>nest g -c @devon4node/schematics config-module</code></p>
</div>
</div>
<div class="sect3">
<h4 id="add-mailer-module"><a class="anchor" href="#add-mailer-module"></a>Add mailer module</h4>
<div class="paragraph">
<p>Add @devon4node/mailer module to project.</p>
</div>
<div class="paragraph">
<p>It will add the @devon4node/mailer module as a project dependency. Also, it will add it to the core module and it will generate some email template examples.</p>
</div>
<div class="paragraph">
<p>Write the command <code>nest g -c @devon4node/schematics mailer</code></p>
</div>
</div>
<div class="sect3">
<h4 id="add-swagger-module"><a class="anchor" href="#add-swagger-module"></a>Add swagger module</h4>
<div class="paragraph">
<p>Add swagger module to project.</p>
</div>
<div class="paragraph">
<p>It will add the @nestjs/swagger module as a project dependency. Also, it will update the main.ts file in order to expose the endpoint for swagger. The default endpoint is: /v1/api</p>
</div>
<div class="paragraph">
<p>Execute the command <code>nest g -c @devon4node/schematics swagger</code></p>
</div>
</div>
<div class="sect3">
<h4 id="add-auth-jwt-module"><a class="anchor" href="#add-auth-jwt-module"></a>Add auth-jwt module</h4>
<div class="paragraph">
<p>Add the auth JWT module to the project.</p>
</div>
<div class="paragraph">
<p>It will add to your project the auth-jwt and user module. Also, it will import those modules into the core module.</p>
</div>
<div class="paragraph">
<p>Execute <code>nest g -c @devon4node/schematics auth-jwt</code></p>
</div>
</div>
<div class="sect3">
<h4 id="add-security"><a class="anchor" href="#add-security"></a>Add security</h4>
<div class="paragraph">
<p>Add cors and helmet to your project.</p>
</div>
<div class="paragraph">
<p>It will add helmet package as project dependency and update the main.ts file in order to enable the cors and helmet in your application.</p>
</div>
<div class="paragraph">
<p>Execute <code>nest g -c @devon4node/schematics security</code></p>
</div>
</div>
<div class="sect3">
<h4 id="generate-database-migrations"><a class="anchor" href="#generate-database-migrations"></a>Generate database migrations</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Generate database migrations</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In order to create migration scripts with TypeORM, you need to install ts-node: <code>yarn global add ts-node</code> or <code>npm i -g ts-node</code></p>
</li>
<li>
<p>Generate the tables creation migration: <code>yarn run typeorm migration:generate -n CreateTables</code></p>
<div class="imageblock">
<div class="content">
<img src="../_images/images/insert-data.PNG" alt="insert data">
</div>
</div>
<div class="paragraph">
<p>It will connect to the database, read all entities and then it will generate a migration file with all sql queries need to transform the current status of the database to the status defined by the entities. If the database is empty, it will generate all sql queries need to create all tables defined in the entities. You can find a example in the todo example</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>As TypeORM is the tool used for DB. You can check official documentation for more information.
See <a href="https://typeorm.io/#/using-cli">TypeORM CLI documentation</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="cobigen"><a class="anchor" href="#cobigen"></a>CobiGen</h4>
<div class="paragraph">
<p>Currently, we do not have templates to generate devon4node code (we have planned to do that in the future). Instead, we have templates that read the code of a devon4node application and generate a devon4ng application. Visit the <a href="https://github.com/devonfw/cobigen">CobiGen</a> page for more information.</p>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="coding-conventions"><a class="anchor" href="#coding-conventions"></a>Coding Conventions</h4>
<div class="paragraph">
<p>devon4node defines some coding conventions in order to improve the readability, reduce the merge conflicts and be able to develop applications in an industrialized way.</p>
</div>
<div class="paragraph">
<p>In order to ensure that you are following the devon4node coding conventions, you can use the following tools:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ESLint</code>: <a href="https://eslint.org/">ESLint</a> ESLint is a tool for identifying and reporting on patterns found in ECMAScript/JavaScript code, with the goal of making code more consistent and avoiding bugs. We recommend to use the <a href="https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint">ESLint VSCode extension</a> (included in the devonfw Platform Extension Pack) in order to be able to see the linting errors while you are developing.</p>
</li>
<li>
<p><code>Prettier</code>: <a href="https://prettier.io/">Prettier</a> is a code formatter. We recommend to use the Prettier VSCode extension (included in the devonfw Platform Extension Pack) and enable the <code>editor.formatOnSave</code> option.</p>
</li>
<li>
<p><code>devon4node application schematic</code>: this tool will generate code following the devon4node coding conventions. Also, when you generate a new project using the devon4node application schematic, it generates the configuration files for TSLint and Prettier that satisfy the devon4node coding conventions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you combine all tools, you can be sure that you follow the devon4node coding conventions.</p>
</div>
</div>
<div class="sect3">
<h4 id="detailed-devon4node-coding-conventions"><a class="anchor" href="#detailed-devon4node-coding-conventions"></a>Detailed devon4node Coding Conventions</h4>
<div class="paragraph">
<p>Here we will detail some of most important devon4node coding conventions. To be sure that you follows all devon4node coding conventions use the tools described before.</p>
</div>
</div>
<div class="sect3">
<h4 id="indentation"><a class="anchor" href="#indentation"></a>Indentation</h4>
<div class="paragraph">
<p>All devon4node code files must be indented using spaces. The indentation with must be 2 spaces.</p>
</div>
</div>
<div class="sect3">
<h4 id="white-space"><a class="anchor" href="#white-space"></a>White space</h4>
<div class="paragraph">
<p>In order to improve the readability of your code, you must introduce whitespaces. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">if(condition){</code></pre>
</div>
</div>
<div class="paragraph">
<p>must be</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">if (condition) {</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="naming-conventions"><a class="anchor" href="#naming-conventions"></a>Naming conventions</h4>

</div>
<div class="sect3">
<h4 id="file-naming"><a class="anchor" href="#file-naming"></a>==  File naming</h4>
<div class="paragraph">
<p>The file name must follow the pattern: (name in kebab case).(kind of component).(extension)
The test file name must follow the pattern: (name in kebab case).(kind of component).spec.(extension)</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>auth-jwt.service.ts
auth-jwt.service.spec.ts</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="interface-naming"><a class="anchor" href="#interface-naming"></a>==  Interface naming</h4>
<div class="paragraph">
<p>The interface names must be in pascal case, and must start with I. There is some controversy in starting the interface names with an I, but we decided to do it because is most of cases you will have an interface and a class with the same name, so, to differentiate them, we decided to start the interfaces with I. Other devonfw stacks solves it by adding the suffix <code>Impl</code> in the class implementations.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>interface ICoffee {}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="class-naming"><a class="anchor" href="#class-naming"></a>==  Class naming</h4>
<div class="paragraph">
<p>The class names must be in pascal case.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>class Coffee {}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="variable-naming"><a class="anchor" href="#variable-naming"></a>==  Variable naming</h4>
<div class="paragraph">
<p>All variable names must be in camel case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>const coffeeList: Coffe[];</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="declarations"><a class="anchor" href="#declarations"></a>Declarations</h4>
<div class="paragraph">
<p>For all variable declarations we must use <code>const</code> or <code>let</code>. <code>var</code> is forbidden. We prefer to use  <code>const</code> when possible.</p>
</div>
</div>
<div class="sect3">
<h4 id="programming-practices"><a class="anchor" href="#programming-practices"></a>Programming practices</h4>

</div>
<div class="sect3">
<h4 id="trailing-comma"><a class="anchor" href="#trailing-comma"></a>==  Trailing comma</h4>
<div class="paragraph">
<p>All statements must end with a trailing comma. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">{
  one: 'one',
  two: 'two'  // bad
}
{
  one: 'one',
  two: 'two', // good
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="arrow-functions"><a class="anchor" href="#arrow-functions"></a>==  Arrow functions</h4>
<div class="paragraph">
<p>All anonymous functions must be defined with the arrow function notation. In most of cases it&#8217;s not a problem, but sometimes, when you do not want to bind <code>this</code> when you define the function, you can use the other function definition. In this special cases you must disable the linter for those sentence.</p>
</div>
</div>
<div class="sect3">
<h4 id="comments"><a class="anchor" href="#comments"></a>==  Comments</h4>
<div class="paragraph">
<p>Comments must start with a whitespace. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">//This is a bad comment
// This is OK</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="quotemarks"><a class="anchor" href="#quotemarks"></a>==  Quotemarks</h4>
<div class="paragraph">
<p>For string definitions, we must use single quotes.</p>
</div>
</div>
<div class="sect3">
<h4 id="if-statements"><a class="anchor" href="#if-statements"></a>==  if statements</h4>
<div class="paragraph">
<p>In all if statements you always must use brackets. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">// Bad if statement
if (condition)
  return true;

// Good if statement
if (condition) {
  return true;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pre-commit-hooks"><a class="anchor" href="#pre-commit-hooks"></a>Pre-commit hooks</h4>
<div class="paragraph">
<p>In order to ensure that your new code follows the coding conventions, devon4node uses by default husky. Husky is a tool that allows you to configure git hooks easily in your project. When you make a <code>git commit</code> in your devon4node project, it will execute two actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Prettify the staged files</p>
</li>
<li>
<p>Execute the linter in the staged files</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If any action fails, you won&#8217;t be able to commit your new changes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to skip the git hooks, you can do a commit passing the <code>--no-verify</code> flag.
</td>
</tr>
</table>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="dependency-injection"><a class="anchor" href="#dependency-injection"></a>Dependency Injection</h4>
<div class="paragraph">
<p>The <a href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> is a well-known common design pattern applied by frameworks in all languages, like <a href="https://spring.io/">Spring</a> in Java, <a href="https://angular.io/">Angular</a> and others. The intention of this page is not to explain how dependency injection works, but instead how it is addressed by NestJS.</p>
</div>
<div class="paragraph">
<p>NestJS resolve the dependency injection in their modules. When you define a provider in a module, it can be injected in all components of the module. By default, those providers are only available in the module where it is defined. The only way to export a module provider to other modules which import it is adding those provider to the export array. You can also reexport modules.</p>
</div>
</div>
<div class="sect3">
<h4 id="inject-dependencies-in-nestjs"><a class="anchor" href="#inject-dependencies-in-nestjs"></a>Inject dependencies in NestJS</h4>
<div class="paragraph">
<p>In order to inject a dependency in a NestJS component, you need to declare it in the component constructor. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">export class CoffeeController {
  constructor(public readonly conffeeService: CoffeeService) {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>NestJS can resolve all dependencies that are defined in the module as provider, and also the dependencies exported by the modules imported. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Module({
  controllers: [CoffeeController],
  providers: [CoffeeService],
})
export class CoffeeModule {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inject dependencies in the constructor is the is the preferred choice, but, sometimes it is not possible. For example, when you are extending another class and want to keep the constructor definition. In this specific cases we can inject dependencies in the class properties. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">export class CoffeeController {
  @Inject(CoffeeService)
  private readonly conffeeService: CoffeeService;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dependency-graph"><a class="anchor" href="#dependency-graph"></a>Dependency Graph</h4>
<div class="imageblock">
<div class="content">
<img src="../_images/images/plantuml/dependency-injection1.png" alt="dependency injection1">
</div>
</div>
<div class="paragraph">
<p>In the previous image, the Module A can inject dependencies exported by Module B, Module E and Module F. If module B reexport Module C and Module D, they are also accessible by Module A.</p>
</div>
<div class="paragraph">
<p>If there is a conflict with the injection token, it resolves the provider with less distance with the module. For example: if the modules C and F exports a <code>UserService</code> provider, the Module A will resolve the <code>UserService</code> exported by the Module F, because the distance from Module A to Module F is 1, and the distance from Module A to Module C is 2.</p>
</div>
<div class="paragraph">
<p>When you define a module as global, the dependency injection system is the same. The only difference is now all modules as a link to the global module. For example, if we make the Module C as global the dependency graph will be:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/images/plantuml/dependency-injection2.png" alt="dependency injection2">
</div>
</div>
</div>
<div class="sect3">
<h4 id="custom-providers"><a class="anchor" href="#custom-providers"></a>Custom providers</h4>
<div class="paragraph">
<p>When you want to change the provider name, you can use a NestJS feature called <a href="https://docs.nestjs.com/fundamentals/custom-providers">custom providers</a>. For example, if you want to define a provider called <code>MockUserService</code> with the provider token <code>UserService</code> you can define it like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Module({
  providers: [{
    provide: UserService,
    useValue: MockUserService,
  }],
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this, when you inject want to inject <code>UserService</code> as dependency, the <code>MockUserService</code> will be injected.</p>
</div>
<div class="paragraph">
<p>Custom provider token can be also a string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Module({
  providers: [{
    provide: 'USER_SERVICE',
    useValue: MockUserService,
  }],
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>but now, when you want to inject it as dependency you need to use the @Inject decorator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">constructor(@Inject('USER_SERVICE') userService: any) {}</code></pre>
</div>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="configuration-module"><a class="anchor" href="#configuration-module"></a>Configuration Module</h4>
<div class="paragraph">
<p>devon4node provides a way to generate a configuration module inside your application. To generate it you only need to execute the command <code>nest g -c @devon4node/schematics config-module</code>. This command will generate inside your application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configuration module inside the core module.</p>
</li>
<li>
<p>config folder where all environment configuration are stored.</p>
<div class="ulist">
<ul>
<li>
<p>default configuration: configuration for your local development environment.</p>
</li>
<li>
<p>develop environment configuration for the develop environment.</p>
</li>
<li>
<p>uat environment configuration for the uat environment.</p>
</li>
<li>
<p>production environment configuration for the production environment.</p>
</li>
<li>
<p>production environment configuration for the production environment.</p>
</li>
<li>
<p>test environment configuration used by test.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
some code generators will add some properties to this module, so, be sure that the config module is the first module that you generate in your application.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="use-the-configuration-service"><a class="anchor" href="#use-the-configuration-service"></a>Use the configuration service</h4>
<div class="paragraph">
<p>To use the configuration service, you only need to inject it as dependency. As configuration module is defined in the core module, it will be available everywhere in your application. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">export class MyProvider {
  constructor(public readonly configService: ConfigurationService) {}

  myMethod() {
    return this.confiService.isDev;
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="choose-an-environment-file"><a class="anchor" href="#choose-an-environment-file"></a>Choose an environment file</h4>
<div class="paragraph">
<p>By default, when you use the configuration service it will take the properties defined in the default.ts file. If you want to change the configuration file, you only need to set the NODE_ENV environment property with the name of the desired environment. Examples: in windows execute <code>set NODE_ENV=develop</code> before executing the application, in linux execute <code>NODE_ENV=develop</code> before executing the application or <code>NODE_ENV=develop yarn start</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="override-configuration-properties"><a class="anchor" href="#override-configuration-properties"></a>Override configuration properties</h4>
<div class="paragraph">
<p>Sometimes, you want to keep some configuration property secure, and you do not want to publish it to the repository, or you want to reuse some configuration file but you need to change some properties. For those scenarios, you can override configuration properties by defining a environment variable with the same name. For example, if you want to override the property host, you can do: <code>set host="newhost"</code>. It also works with objects. For example, if you want to change the value of secret in the property <code>jwtConfig</code> for <a href="https://github.com/devonfw/devon4node/blob/develop/samples/employee/src/config/develop.ts">this example</a>, you can set a environment variable like this: <code>set jwtConfig="{"secret": "newsecret"}"</code>. As you can see, this environment variable has a JSON value. It will take object and merge the <code>jwtConfig</code> property with the properties defined inside the environment variable. It other properties maintain their value. The behaviour is the same for the nested objects.</p>
</div>
</div>
<div class="sect3">
<h4 id="add-a-configuration-property"><a class="anchor" href="#add-a-configuration-property"></a>Add a configuration property</h4>
<div class="paragraph">
<p>In order to add a new property to the configuration module, you need to follow some steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the property to IConfig interface in <code>src/app/core/configuration/types.ts</code> file. With this, we can ensure that the <code>ConfigurationService</code> and the environment files has those property at compiling time.</p>
</li>
<li>
<p>Add the new property getter to <code>ConfigurationService</code>. You must use the <code>get</code> method of <code>ConfigurationService</code> to ensure that the property will be loaded from the desired config file. You can also add extra logic if needed.</p>
</li>
<li>
<p>Add the property to all config files inside the <code>src/config</code> folder.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="paragraph">
<p>We want to add the property <code>devonfwUrl</code> to our ConfigurationService, so:</p>
</div>
<div class="paragraph">
<p>We add the following code in IConfig interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">devonfwUrl: string;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, we add the getter in the <code>ConfigurationService</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">get devonfwUrl(): string {
  return this.get('devonfwUrl')!;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we add the definition in all config files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">devonfwUrl: 'https://devonfw.com',</code></pre>
</div>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="auth-jwt-module"><a class="anchor" href="#auth-jwt-module"></a>Auth JWT module</h4>
<div class="paragraph">
<p>devon4node provides a way to generate a default authentication module using JWT (JSON Web Token). It uses the <code>@nestjs/passport</code> library describe <a href="https://docs.nestjs.com/techniques/authentication">here</a>.</p>
</div>
<div class="paragraph">
<p>To generate the devon4node auth-jwt module you only need to execute the command: <code>nest generate -c @devon4node/schematics auth-jwt</code>. We generate this module inside the applications instead of distributing a npm package because this module is prone to be modified depending on the requirements. It also generate a basic user module.</p>
</div>
<div class="paragraph">
<p>In this page we will explain the default implementation provided by devon4node. For more information about authentication, JWT, passport and other you can see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://jwt.io/introduction/">JWT</a></p>
</li>
<li>
<p><a href="https://docs.nestjs.com/techniques/authentication">NestJS authentication</a></p>
</li>
<li>
<p><a href="https://www.npmjs.com/package/passport">Passport</a></p>
</li>
<li>
<p><a href="https://www.npmjs.com/package/passport-jwt">Passport JWT</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="auth-jwt-endpoints"><a class="anchor" href="#auth-jwt-endpoints"></a>Auth JWT endpoints</h4>
<div class="paragraph">
<p>In order to execute authentication operations, the auth-jwt module exposes the following endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>POST /auth/login</code>: receive an username and a password and return the token in the header if the combination of username and password is correct.</p>
</li>
<li>
<p><code>POST /auth/register</code>: register a new user.</p>
</li>
<li>
<p><code>GET /auth/currentuser</code>: return the user data if he is authenticated.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="protect-endpoints-with-auth-jwt"><a class="anchor" href="#protect-endpoints-with-auth-jwt"></a>Protect endpoints with auth-jwt</h4>
<div class="paragraph">
<p>In order to protect your endpoints with auth-jwt module you only need to add the <code>AuthGuard()</code> in the <code>UseGuards</code> decorator. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Get('currentuser')
@UseGuards(AuthGuard())
currentUser(@Request() req: UserRequest) {
  return req.user;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, all request to currentuser are protected by the <code>AuthGuard</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="role-based-access-control"><a class="anchor" href="#role-based-access-control"></a>Role based Access Control</h4>
<div class="paragraph">
<p>The auth-jwt module provides also a way to control the access to some endpoints by using roles. For example, if you want to grant access to a endpoint only to admins, you only need to add the <code>Roles</code> decorator to those endpoints with the roles allowed. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Get('currentuser')
@UseGuards(AuthGuard())
@Roles(roles.ADMIN)
currentUser(@Request() req: UserRequest) {
  return req.user;
}</code></pre>
</div>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="swagger"><a class="anchor" href="#swagger"></a>Swagger</h4>
<div class="paragraph">
<p>We can use swagger (OpenAPI) in order to describe the endpoints that our application exposes.</p>
</div>
<div class="paragraph">
<p>NestJS provides a module which will read the code of our application and will expose one endpoint where we can see the swagger.</p>
</div>
<div class="paragraph">
<p>Add swagger to a devon4node application is simple, you only need to execute the command <code>nest g -c @devon4node/schematics swagger</code> and it will do everything for you. The next time that you start your application, you will be able to see the swagger at <code>/v1/api</code> endpoint.</p>
</div>
<div class="paragraph">
<p>The swagger module can read your code in order to create the swagger definition, but sometimes you need to help him by decorating your handlers.</p>
</div>
<div class="paragraph">
<p>For more information about decorators and other behaviour about swagger module, you can see the <a href="https://docs.nestjs.com/recipes/swagger">NestJS swagger documentation page</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the OpenAPI specification that this module supports is v2.0. The OpenAPI v3.0 is not available yet by using this module.
</td>
</tr>
</table>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="typeorm"><a class="anchor" href="#typeorm"></a>TypeORM</h4>
<div class="paragraph">
<p>TypeORM is the default ORM provided by devon4node. It supports MySQL, MariaDB, Postgres, CockroachDB, SQLite, Microsoft SQL Server, Oracle, sql.js relational database and also supports MongoDB NoSQL database.</p>
</div>
<div class="paragraph">
<p>Add TypeORM support to a devon4node application is very easy: you only need to execute the command <code>nest g -c @devon4node/schematics typeorm</code> and it will add all required dependencies to the project and also imports the <code>@nestjs/typeorm</code> module.</p>
</div>
<div class="paragraph">
<p>For more information about TypeORM and the integration with NestJS you can visit <a href="https://typeorm.io">TypeORM webpage</a>, <a href="https://github.com/typeorm/typeorm">TypeORM GitHub repository</a> and <a href="https://docs.nestjs.com/recipes/sql-typeorm">NestJS TypeORM documentation page</a></p>
</div>
</div>
<div class="sect3">
<h4 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h4>
<div class="paragraph">
<p>When you have the configuration module, the TypeORM generator will add one property in order to be able to configure the database depending on the environment. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">database: {
  type: 'sqlite',
  database: ':memory:',
  synchronize: false,
  migrationsRun: true,
  logging: true,
  entities: ['dist/**/*.entity.js'],
  migrations: ['dist/migration/**/*.js'],
  subscribers: ['dist/subscriber/**/*.js'],
  cli: {
    entitiesDir: 'src/entity',
    migrationsDir: 'src/migration',
    subscribersDir: 'src/subscriber',
  },
},</code></pre>
</div>
</div>
<div class="paragraph">
<p>This object is a TypeORM <code>ConnectionOptions</code>. For fore information about it visit the <a href="https://typeorm.io/#/connection-options/">TypeORM Connection Options page</a>.</p>
</div>
<div class="paragraph">
<p>There is also a special case: the default configuration. As the devon4node CLI need the database configuration when you use the <code>devon4node db</code> command, we also provide the ormconfig.json file. In this file you must put the configuration for you local environment. In order to do not have duplicated the configuration for local environment, in the default config file the database property is set-up like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">database: require('../../ormconfig.json'),</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, you only need to maintain the ormconfig.json file for the local environment.</p>
</div>
</div>
<div class="sect3">
<h4 id="entity"><a class="anchor" href="#entity"></a>Entity</h4>
<div class="paragraph">
<p>Entity is a class that maps to a database table. The devon4node schematics has a generator to create new entities. You only need to execute the command <code>nest g -c @devon4node/schematics entity &lt;entity-name&gt;</code> and it generate the entity.</p>
</div>
<div class="paragraph">
<p>In the entity, you must define all columns, relations, primary keys of your database table. By default, devon4node provides a class named <code>BaseEntity</code>. All entities created with the devon4node schematics will extends the <code>BaseEntity</code>. This entity provides you some common columns:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code>: the primary key of you table</p>
</li>
<li>
<p><code>version</code>: the version of the entry (used for auditing purposes)</p>
</li>
<li>
<p><code>createdAt</code>: creation date of the entry (used for auditing purposes)</p>
</li>
<li>
<p><code>updatedAt</code>: last update date of the entry (used for auditing purposes)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about Entities, please visit the <a href="https://typeorm.io/#/entities">TypeORM entities page</a></p>
</div>
</div>
<div class="sect3">
<h4 id="repository"><a class="anchor" href="#repository"></a>Repository</h4>
<div class="paragraph">
<p>With repositories, you can manage (insert, update, delete, load, etc.) a concrete entity. Using this pattern, we have separated the data (Entities) from the methods to manage it (Repositories).</p>
</div>
<div class="paragraph">
<p>To use a repository you only need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Import it in the module as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Module({
  imports: [TypeOrmModule.forFeature([Employee])],
})</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
if you generate the entities with the devon4node schematic, this step is not necessary, devon4node schematic will do it for you.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Inject the repository as dependency in your service:</p>
<div class="listingblock">
<div class="content">
<pre>constructor(@InjectRepository(Employee) employeeRepository: Repository&lt;Employee&gt;) {}</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can see more details in the <a href="https://docs.nestjs.com/techniques/database">NestJS database</a> and <a href="https://docs.nestjs.com/recipes/sql-typeorm">NestJS TypeORM</a> documentation pages.</p>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="serializer"><a class="anchor" href="#serializer"></a>Serializer</h4>
<div class="paragraph">
<p>Serialization is the process of translating data structures or object state into a format that can be transmitted across network and reconstructed later.</p>
</div>
<div class="paragraph">
<p>NestJS by default serialize all data to JSON (JSON.stringify). Sometimes this is not enough. In some situations you need to exclude some property (e.g password). Instead doing it manually, devon4node provides an interceptor (<code>ClassSerializerInterceptor</code>) that will do it for you. You only need to return a class instance as always and the interceptor will transform those class to the expected data.</p>
</div>
<div class="paragraph">
<p>The <code>ClassSerializerInterceptor</code> takes the <a href="https://github.com/typestack/class-transformer">class-transformer</a> decorators in order to know how to transform the class and then send the result to the client.</p>
</div>
<div class="paragraph">
<p>Some of class-transformer decorators are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Expose</p>
</li>
<li>
<p>Exclude</p>
</li>
<li>
<p>Type</p>
</li>
<li>
<p>Transform</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And methods to transform data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>plainToClass</p>
</li>
<li>
<p>plainToClassFromExist</p>
</li>
<li>
<p>classToPlain</p>
</li>
<li>
<p>classToClass</p>
</li>
<li>
<p>serialize</p>
</li>
<li>
<p>deserialize</p>
</li>
<li>
<p>deserializeArray</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the <a href="https://github.com/typestack/class-transformer">class-transformer</a> page for more information.</p>
</div>
<div class="paragraph">
<p>See <a href="https://docs.nestjs.com/techniques/serialization">NestJS serialization page</a> for more information about <code>ClassSerializerInterceptor</code>.</p>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="validation-2"><a class="anchor" href="#validation-2"></a>Validation</h4>
<div class="paragraph">
<p>To be sure that your application will works well, you must validate any input data. devon4node by default provides a <code>ValidationPipe</code>. This <code>ValidationPipe</code> is the responsible of validate the request input and, if the input do not pass the validation process, it returns a <code>400 Bad Request</code> error.</p>
</div>
</div>
<div class="sect3">
<h4 id="defining-validators"><a class="anchor" href="#defining-validators"></a>Defining Validators</h4>
<div class="paragraph">
<p>The <code>ValidationPipe</code> needs to know how to validate the input. For that purpose we use the <code>class-validator</code> package. This package allows you to define the validation of a class by using decorators.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">export class Coffee {
  @IsDefined()
  @IsString()
  @MaxLength(255)
  name: string;

  @IsDefined()
  @IsString()
  @MaxLength(25)
  type: string;

  @IsDefined()
  @IsNumber()
  quantity: number;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see in the previous example, we used some decorators in order to define the validators for every property of the Coffee class. You can find all decorators in the <a href="https://github.com/typestack/class-validator">class-validator github repository</a>.</p>
</div>
<div class="paragraph">
<p>Now, when you want to receive a Coffee as input in some endpoint, it will execute the validations before executing the handler function.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In order to be able to use the class-validator package, you must use classes instead of interfaces. As you know interfaces disappear at compiling time, and class-validator need to know the metadata of the properties in order to be able to validate.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>ValidationPipe</code> only works if you put a specific type in the handler definition. For example, if you define a handler like <code>getCoffee(@Body() coffee: any): Coffee {}</code> the ValidationPipe will not do anything. You must specify the type of the input: <code>getCoffee(@Body() coffee: Coffee): Coffee {}</code>
</td>
</tr>
</table>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="logger"><a class="anchor" href="#logger"></a>Logger</h4>
<div class="paragraph">
<p>When you create a new devon4node application, it already has a logger: <code>src/app/shared/logger/winston.logger.ts</code>. This logger provide the methods <code>log</code>, <code>error</code> and <code>warn</code>. All of those methods will write a log message, but with a different log level.</p>
</div>
<div class="paragraph">
<p>The winston logger has two transports: one to log everything inside the file logs/general.log and the other to log only the error logs inside the file logs/error.log. In addition, it uses the default NestJS logger in order to show the logs in the console.</p>
</div>
<div class="paragraph">
<p>As you can see it is a simple example about how to use logger in a devon4node application. It will be update to a complex one in the next versions.</p>
</div>
</div>
<div class="sect3">
<h4 id="how-to-use-logger"><a class="anchor" href="#how-to-use-logger"></a>How to use logger</h4>
<div class="paragraph">
<p>In order to use the logger you only need to inject the logger as a dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">constructor(logger: WinstonLogger){}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then use it</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">async getAll() {
  this.service.getAll();
  this.logger.log('Returning all data');
}</code></pre>
</div>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="mailer-module"><a class="anchor" href="#mailer-module"></a>Mailer Module</h4>
<div class="paragraph">
<p>This module enables you to send emails in devon4node. It also provides a template engine using Handlebars.</p>
</div>
<div class="paragraph">
<p>It is a NestJS module that inject into your application a <code>MailerService</code>, which is the responsible to send the emails using the nodemailer library.</p>
</div>
</div>
<div class="sect3">
<h4 id="installing"><a class="anchor" href="#installing"></a>Installing</h4>
<div class="paragraph">
<p>Execute the following command in a devon4node project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">yarn add @devon4node/mailer</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring"><a class="anchor" href="#configuring"></a>Configuring</h4>
<div class="paragraph">
<p>To configure the mailer module, you only need to import it in your application into another module. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Module({
  ...
  imports: [
    MailerModule.forRoot(),
  ],
  ...
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your must pass the configuration using the <code>forRoot</code> or <code>forRootAsync</code> methods.</p>
</div>
</div>
<div class="sect3">
<h4 id="forroot"><a class="anchor" href="#forroot"></a><code>forRoot()</code></h4>
<div class="paragraph">
<p>The <code>forRoot</code> method receives an <code>MailerModuleOptions</code> object as parameter. It configures the <code>MailerModule</code> using the input <code>MailerModuleOptions</code> object.</p>
</div>
<div class="paragraph">
<p>The structure of <code>MailerModuleOptions</code> is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">{
  hbsOptions?: {
    templatesDir: string;
    extension?: string;
    partialsDir?: string;
    helpers?: IHelperFunction[];
    compilerOptions?: ICompileOptions;
  },
  mailOptions?: nodemailerSmtpTransportOptions;
  emailFrom: string;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, you need to specify the <a href="https://handlebarsjs.com/api-reference/compilation.html#handlebars-compile-template-options">Handlebars compile options</a>, the <a href="https://nodemailer.com/smtp">nodemailer transport options</a> and the email address which will send the emails.
Then, you need to call to <code>forRoot</code> function in the module imports. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Module({
  ...
  imports: [
    MailerModule.forRoot({
      mailOptions: {
        host: 'localhost',
        port: 1025,
        secure: false,
        tls: {
          rejectUnauthorized: false,
        },
      },
      emailFrom: 'noreply@capgemini.com',
      hbsOptions: {
        templatesDir: join(__dirname, '../..', 'templates/views'),
        partialsDir: join(__dirname, '../..', 'templates/partials'),
        helpers: [{
          name: 'fullname',
          func: person =&gt; `${person.name} ${person.surname}`,s
        }],
      },
    }),
  ...
})</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="forrootasync"><a class="anchor" href="#forrootasync"></a><code>forRootAsync()</code></h4>
<div class="paragraph">
<p>The method <code>forRootAsync</code> enables you to get the mailer configuration in a asynchronous way. It is useful when you need to get the configuration using, for example, a service (e.g. <code>ConfigurationService</code>).</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Module({
  ...
  imports: [
    MailerModule.forRootAsync({
      imports: [ConfigurationModule],
      useFactory: (config: ConfigurationService) =&gt; {
        return config.mailerConfig;
      },
      inject: [ConfigurationService],
    }),
  ...
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we use the <code>ConfigurationService</code> in order to get the <code>MailerModuleOptions</code> (the same as <code>forRoot</code>)</p>
</div>
</div>
<div class="sect3">
<h4 id="usage"><a class="anchor" href="#usage"></a>Usage</h4>
<div class="paragraph">
<p>In order to use, you only need to inject using the dependency injection the <code>MailerService</code>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Injectable()
export class CatsService {
  constructor(private readonly mailer: MailerService) {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, you only need to use the methods provided by the <code>MailerService</code> in your service. Take into account that you can inject it in every place that support NestJS dependency injection.</p>
</div>
</div>
<div class="sect3">
<h4 id="mailerservice-methods"><a class="anchor" href="#mailerservice-methods"></a><code>MailerService</code> methods</h4>

</div>
<div class="sect3">
<h4 id="sendplainmail"><a class="anchor" href="#sendplainmail"></a>==  <code>sendPlainMail</code></h4>
<div class="paragraph">
<p>The method <code>sendPlainMail</code> receive a string sends a email.</p>
</div>
<div class="paragraph">
<p>The method signatures are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">sendPlainMail(emailOptions: SendMailOptions): Promise&lt;SentMessageInfo&gt;;
sendPlainMail(to: string, subject: string, mail: string): Promise&lt;SentMessageInfo&gt;;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">this.mailer.sendPlainMail({
  to: 'example@example.com',
  subject: 'This is a subject',
  html: '&lt;h1&gt;Hello world&lt;/h1&gt;'
});
this.mailer.sendPlainMail('example@example.com', 'This is a subject', '&lt;h1&gt;Hello world&lt;/h1&gt;');</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sendtemplatemail"><a class="anchor" href="#sendtemplatemail"></a>==  <code>sendTemplateMail</code></h4>
<div class="paragraph">
<p>The method <code>sendTemplateMail</code> sends a email based on a Handlebars template. The templates are registered using the <code>templatesDir</code> option or using the <code>addTemplate</code> method.
The template name is the name of the template (without extension) or the first parameter of the method <code>addTemplate</code>.</p>
</div>
<div class="paragraph">
<p>The method signatures are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">sendTemplateMail(emailOptions: SendMailOptions, templateName: string, emailData: any, hbsOptions?: RuntimeOptions): Promise&lt;SentMessageInfo&gt;;
sendTemplateMail(to: string, subject: string, templateName: string, emailData: any, hbsOptions?: RuntimeOptions): Promise&lt;SentMessageInfo&gt;;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">this.mailer.sendTemplateMail({
  to: 'example@example.com',
  subject: 'This is a subject',
  html: '&lt;h1&gt;Hello world&lt;/h1&gt;'
}, 'template1', { person: {name: 'Dario', surname: 'Rodriguez'}});
this.mailer.sendTemplateMail('example@example.com', 'This is a subject', 'template1', { person: {name: 'Dario', surname: 'Rodriguez'}});</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="addtemplate"><a class="anchor" href="#addtemplate"></a>==  <code>addTemplate</code></h4>
<div class="paragraph">
<p>Adds a new template to the <code>MailerService</code>.</p>
</div>
<div class="paragraph">
<p>Method signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">addTemplate(name: string, template: string, options?: CompileOptions): void;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">this.mailer.addTemplate('newTemplate', '&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;{{&gt;partial1}}&lt;/body&gt;&lt;/html&gt;')</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="registerpartial"><a class="anchor" href="#registerpartial"></a>==  <code>registerPartial</code></h4>
<div class="paragraph">
<p>Register a new partial in Handlebars.</p>
</div>
<div class="paragraph">
<p>Method signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">registerPartial(name: string, partial: Handlebars.Template&lt;any&gt;): void;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">this.mailer.registerPartial('partial', '&lt;h1&gt;Hello World&lt;/h1&gt;')</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="registerhelper"><a class="anchor" href="#registerhelper"></a>==  <code>registerHelper</code></h4>
<div class="paragraph">
<p>Register a new helper in Handlebars.</p>
</div>
<div class="paragraph">
<p>Method signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">registerHelper(name: string, helper: Handlebars.HelperDelegate): void;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">this.mailer.registerHelper('fullname', person =&gt; `${person.name} ${person.surname}`)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="handlebars-templates"><a class="anchor" href="#handlebars-templates"></a>Handlebars templates</h4>
<div class="paragraph">
<p>As mentioned above, this module allow you to use Handlebars as template engine, but it is optional. If you do not need the Handlebars, you just need to keep the <code>hbsOptions</code> undefined.</p>
</div>
<div class="paragraph">
<p>In order to get the templates form the file system, you can specify the template folder, the partials folder and the helpers.
At the moment of module initialization, it will read the content of the template folder, and will register every file with the name (without extension) and the content as Handlebars template. It will do the same for the partials.</p>
</div>
<div class="paragraph">
<p>You can specify the extension of template files using the <code>extension</code> parameter. The default value is <code>.handlebars</code></p>
</div>
</div>
<div class="sect3">
<h4 id="local-development"><a class="anchor" href="#local-development"></a>Local development</h4>
<div class="paragraph">
<p>If you want to work with this module but you don&#8217;t have a SMTP server, you can use the <code>streamTransport</code>. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">{
  mailOptions: {
    streamTransport: true,
    newline: 'windows',
  },
  emailFrom: ...
  hbsOptions: ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, you need to get the <code>sendPlainMail</code> or <code>sendTemplateMail</code> result, and print the email to the standard output (<code>STDOUT</code>). Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">const mail = await this.mailer.sendTemplateMail(...);

mail.message.pipe(process.stdout);</code></pre>
</div>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="importing-your-eslint-reports-into-sonarqube"><a class="anchor" href="#importing-your-eslint-reports-into-sonarqube"></a>Importing your ESLint reports into SonarQube</h4>
<div class="paragraph">
<p>This guide covers the import of ESLint reports into SonarQube instances in CI environments, as this is the recommended way of using ESLint and SonarQube for devon4node projects. The prerequisites for this process are a CI environment, preferably a <a href="https://github.com/devonfw/production-line">Production Line</a> instance, and the <a href="https://eslint.org/docs/user-guide/command-line-interface">ESLint CLI</a>, which is already included when generating a new devon4node project.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring-the-eslint-analysis"><a class="anchor" href="#configuring-the-eslint-analysis"></a>Configuring the ESLint analysis</h4>
<div class="paragraph">
<p>You can configure the ESLint analysis parameters in the <code>.eslintrc.js</code> file inside the top-level directory of your project. If you created your node project using the devon4node application schematic, this file will already exist. If you want to make further adjustments to it, have a look at the <a href="https://eslint.org/docs/user-guide/configuring">ESLint documentation</a>.</p>
</div>
<div class="paragraph">
<p>The ESLint analysis script <code>lint</code> is already configured in the <code>scripts</code> part of your <code>package.json</code>. Simply add <code>-f json &gt; report.json</code>, so that the output of the analysis is saved in a .json file. Additional information to customization options for the ESLint CLI can be found <a href="https://eslint.org/docs/user-guide/command-line-interface#options">here</a>.</p>
</div>
<div class="paragraph">
<p>To run the analysis, execute the script with <code>npm run lint</code> inside the base directory of your project.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring-sonarqube"><a class="anchor" href="#configuring-sonarqube"></a>Configuring SonarQube</h4>
<div class="paragraph">
<p>If you haven&#8217;t already generated your CICD-related files, follow the tutorial on the <a href="https://github.com/devonfw/cicdgen/wiki/devon4node-schematic">devon4node schematic</a> of our CICDGEN project, as you will need a Jenkinsfile configured in your project to proceed.</p>
</div>
<div class="paragraph">
<p>Inside the script for the SonarQube code analysis in your Jenkinsfile, add the parameter <code>-Dsonar.eslint.reportPaths=report.json</code>. Now, whenever a SonarQube analysis is triggered by your CI environment, the generated report will be loaded into your SonarQube instance.
To avoid duplicated issues, you can associate an empty TypeScript quality profile with your project in its server configurations.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="devon4node-applications"><a class="anchor" href="#devon4node-applications"></a>devon4node applications</h2>
<div class="sectionbody">
<!-- toc disabled -->
<div class="sect3">
<h4 id="devon4node-samples"><a class="anchor" href="#devon4node-samples"></a>devon4node Samples</h4>
<div class="paragraph">
<p>In the folder /samples, you can find some devon4node examples that could be useful for you in order to understand better the framework.</p>
</div>
<div class="paragraph">
<p>The samples are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/devonfw/devon4node/tree/develop/samples/employee">Employee</a></p>
</li>
<li>
<p><a href="https://github.com/devonfw/devon4node/tree/develop/samples/components-example">Components example</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, we have another realistic example in the <a href="https://github.com/devonfw/my-thai-star/tree/develop/node">My Thai Star repository</a>. This example is the implementation of My Thai Star backend, which is compatible with the frontend made with Angular. To do that, this node implementation exposes the same API as Java backend. Take care with this example, as we need to follow the Java API, some components do not follow the devon4node patterns and code conventions.</p>
</div>
</div>
<div class="sect3">
<h4 id="todo-example"><a class="anchor" href="#todo-example"></a>Todo example</h4>
<div class="paragraph">
<p>This example is the backend part of an TO-DO application. It exposes and API where you can create, read, update and delete a TO-DO list.</p>
</div>
<div class="paragraph">
<p>In order to start the application, run the following commands in the todo folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ yarn
$ yarn build
$ yarn start</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you can access to the application using the url <code><a href="http://localhost:3000/v1/todo/todos" class="bare">http://localhost:3000/v1/todo/todos</a></code>. If you want to now all endpoints exposed, you can see the swagger at: <code><a href="http://localhost:3000/v1/api" class="bare">http://localhost:3000/v1/api</a></code>.</p>
</div>
<div class="paragraph">
<p>Also, in this example we show you how to control the access to you application by implementing an authentication mechanism using JWT and rol based strategy. In order to access to the list of todos (<code><a href="http://localhost:3000/v1/todo/todos" class="bare">http://localhost:3000/v1/todo/todos</a></code>), first you need to call to <code>POST <a href="http://localhost:3000/v1/auth/login" class="bare">http://localhost:3000/v1/auth/login</a></code> and in the body you need to send the user information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "username": "user",
  "password": "password"
}</pre>
</div>
</div>
<div class="paragraph">
<p>It will return a JWT token for the user <code>user</code>. The rol of this user is USER, so you can only access to the methods GET, POST and DELETE of the endpoint <code><a href="http://localhost:3000/v1/todo/todos" class="bare">http://localhost:3000/v1/todo/todos</a></code>. If you login with the user admin/admin, you will be able to access to the methods UPDATE and PATCH.</p>
</div>
</div>
<div class="sect3">
<h4 id="employee-example"><a class="anchor" href="#employee-example"></a>Employee example</h4>
<div class="paragraph">
<p>This is an example of employee management application. With the application you can create, read, update and delete employees.</p>
</div>
<div class="paragraph">
<p>In order to start the application, run the following commands in the todo folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ yarn
$ yarn build
$ yarn start</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, you can access to the application using the url <code><a href="http://localhost:8081/v1/employee/employees" class="bare">http://localhost:8081/v1/employee/employees</a></code>. If you want to now all endpoints exposed, you can see the swagger at: <code><a href="http://localhost:8081/v1/api" class="bare">http://localhost:8081/v1/api</a></code>.</p>
</div>
<div class="paragraph">
<p>This is a simple example without authentication. With this example you can learn how to work with database migrations. You can find them in the folder /src/migrations. The TypeORM is configured in order to execute the migrations every time that you start this application at ormconfig.json with the following flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>"migrationsRun": true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also execute the migration manually by typing the command <code>devon4node db migration:run</code>, or revert executing <code>devon4node db migration:revert</code>. Take into account that the database that this application is using is an in-memory sqlite, so every time that you stop the application all data is lost.</p>
</div>
</div>
<div class="sect3">
<h4 id="components-example"><a class="anchor" href="#components-example"></a>Components example</h4>
<div class="paragraph">
<p>This example allow you to understand better the execution order of the components of a devon4node application (guards, pipes, interceptors, filters, middleware).</p>
</div>
<div class="paragraph">
<p>In order to start the application, run the following commands in the todo folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ yarn
$ yarn build
$ yarn start</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to see the execution order, you can call to <code><a href="http://localhost:3000/v1" class="bare">http://localhost:3000/v1</a></code>. It will show you the execution order of all components except the filters. If you want to know the execution order while a filter is applied, call to the endpoint with the following queries: <code>?hello=error</code>, <code>?hello=controller</code>, <code>?hello=global</code>.</p>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="create-the-employee-sample-step-by-step"><a class="anchor" href="#create-the-employee-sample-step-by-step"></a>Create the employee sample step by step</h4>

</div>
<div class="sect3">
<h4 id="application-requisites"><a class="anchor" href="#application-requisites"></a>Application requisites</h4>
<div class="paragraph">
<p>The employee application needs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A configuration module</p>
</li>
<li>
<p>A SQLite in memory database</p>
</li>
<li>
<p>Security: CORS</p>
</li>
<li>
<p>Swagger support</p>
</li>
<li>
<p>Authentication using JWT</p>
</li>
<li>
<p>CRUD for manage employees. The employees will have the following properties:</p>
<div class="ulist">
<ul>
<li>
<p>name</p>
</li>
<li>
<p>surname</p>
</li>
<li>
<p>email</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="create-the-application"><a class="anchor" href="#create-the-application"></a>Create the application</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install Nest CLI</p>
<div class="paragraph">
<p>Execute the command <code>yarn global add @nestjs/cli</code></p>
</div>
</li>
<li>
<p>Install devon4node schematics</p>
</li>
<li>
<p>Execute the command <code>yarn global add @devon4node/schematics</code></p>
</li>
<li>
<p>Create the new application</p>
<div class="paragraph">
<p>Execute the command <code>nest g -c @devon4node/schematics application employee</code></p>
</div>
</li>
<li>
<p>Then, we need to add some components, go inside the project folder and execute the following commands:</p>
<div class="paragraph">
<p>Go inside project folder: <code>cd employee</code>.</p>
</div>
<div class="paragraph">
<p>Config module: <code>nest g -c @devon4node/schematics config-module</code>.</p>
</div>
<div class="paragraph">
<p>TypeORM database, choose sqlite DB when asked <code>nest g -c @devon4node/schematics typeorm</code>.</p>
</div>
<div class="paragraph">
<p>Add security: <code>nest g -c @devon4node/schematics security</code>.</p>
</div>
<div class="paragraph">
<p>Swagger module: <code>nest g -c @devon4node/schematics swagger</code>.</p>
</div>
<div class="paragraph">
<p>Auth-jwt authentication: <code>nest g -c @devon4node/schematics auth-jwt</code>.</p>
</div>
<div class="paragraph">
<p>Add an application module: <code>nest g -c @devon4node/schematics module employee</code>.</p>
</div>
<div class="paragraph">
<p>Add CRUD component: <code>nest g -c @devon4node/schematics crud employee/employee</code>.</p>
</div>
<div class="paragraph">
<p>With this, you will generate the following files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/employee/.prettierrc
/employee/nest-cli.json
/employee/package.json
/employee/README.md
/employee/tsconfig.build.json
/employee/tsconfig.json
/employee/tslint.json
/employee/src/main.ts
/employee/test/app.e2e-spec.ts
/employee/test/jest-e2e.json
/employee/src/app/app.controller.spec.ts
/employee/src/app/app.controller.ts
/employee/src/app/app.module.ts
/employee/src/app/app.service.ts
/employee/src/app/core/core.module.ts
/employee/src/app/shared/logger/winston.logger.ts
/employee/src/app/core/configuration/configuration.module.ts
/employee/src/app/core/configuration/model/index.ts
/employee/src/app/core/configuration/model/types.ts
/employee/src/app/core/configuration/services/configuration.service.spec.ts
/employee/src/app/core/configuration/services/configuration.service.ts
/employee/src/app/core/configuration/services/index.ts
/employee/src/config/default.ts
/employee/src/config/develop.ts
/employee/src/config/production.ts
/employee/src/config/test.ts
/employee/src/config/uat.ts
/employee/docker-compose.yml
/employee/ormconfig.json
/employee/src/app/shared/model/entities/base-entity.entity.ts
/employee/src/app/core/auth/auth.module.ts
/employee/src/app/core/auth/controllers/auth.controller.spec.ts
/employee/src/app/core/auth/controllers/auth.controller.ts
/employee/src/app/core/auth/controllers/index.ts
/employee/src/app/core/auth/decorators/index.ts
/employee/src/app/core/auth/decorators/roles.decorator.spec.ts
/employee/src/app/core/auth/decorators/roles.decorator.ts
/employee/src/app/core/auth/guards/index.ts
/employee/src/app/core/auth/guards/roles.guard.spec.ts
/employee/src/app/core/auth/guards/roles.guard.ts
/employee/src/app/core/auth/model/index.ts
/employee/src/app/core/auth/model/roles.enum.ts
/employee/src/app/core/auth/model/user-request.interface.ts
/employee/src/app/core/auth/services/auth.service.spec.ts
/employee/src/app/core/auth/services/auth.service.ts
/employee/src/app/core/auth/services/index.ts
/employee/src/app/core/auth/strategies/index.ts
/employee/src/app/core/auth/strategies/jwt.strategy.spec.ts
/employee/src/app/core/auth/strategies/jwt.strategy.ts
/employee/src/app/core/user/user.module.ts
/employee/src/app/core/user/model/index.ts
/employee/src/app/core/user/model/dto/user-payload.dto.ts
/employee/src/app/core/user/model/entities/user.entity.ts
/employee/src/app/core/user/services/index.ts
/employee/src/app/core/user/services/user.service.spec.ts
/employee/src/app/core/user/services/user.service.ts
/employee/test/auth/auth.service.mock.ts
/employee/test/user/user.repository.mock.ts
/employee/src/app/employee/employee.module.ts
/employee/src/app/employee/model/entities/employee.entity.ts
/employee/src/app/employee/model/index.ts
/employee/src/app/employee/controllers/employee.crud.controller.ts
/employee/src/app/employee/services/employee.crud.service.ts
/employee/src/app/employee/services/index.ts
/employee/src/app/employee/controllers/index.ts</pre>
</div>
</div>
</li>
<li>
<p>Open the VSCode</p>
<div class="paragraph">
<p>Execute the commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>yarn install
code .</pre>
</div>
</div>
</li>
<li>
<p>Fill in the entity: src/app/employee/model/entities/employee.entity.ts</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add the columns</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Entity()
export class Employee extends BaseEntity {
  @Column('varchar', { length: 255, nullable: true })
  name?: string;

  @Column('varchar', { length: 255, nullable: true })
  surname?: string;

  @Column('varchar', { length: 255, nullable: true })
  email?: string;
}</code></pre>
</div>
</div>
</li>
<li>
<p>Add the validations</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Entity()
export class Employee extends BaseEntity {
  @IsDefined({ groups: [CrudValidationGroups.CREATE] })
  @IsOptional({ groups: [CrudValidationGroups.UPDATE] })
  @MaxLength(255)
  @Column('varchar', { length: 255, nullable: true })
  name?: string;

  @IsDefined({ groups: [CrudValidationGroups.CREATE] })
  @IsOptional({ groups: [CrudValidationGroups.UPDATE] })
  @MaxLength(255)
  @Column('varchar', { length: 255, nullable: true })
  surname?: string;

  @IsDefined({ groups: [CrudValidationGroups.CREATE] })
  @IsOptional({ groups: [CrudValidationGroups.UPDATE] })
  @MaxLength(255)
  @IsEmail()
  @Column('varchar', { length: 255, nullable: true })
  email?: string;
}</code></pre>
</div>
</div>
</li>
<li>
<p>Add the transformations</p>
<div class="paragraph">
<p>In this specific case, we will not transform any property, but you can see an example in the <code>src/app/shared/model/entities/base-entity.entity.ts</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">export abstract class BaseEntity {
  @PrimaryGeneratedColumn('increment')
  id!: number;

  @VersionColumn({ default: 1 })
  @Exclude({ toPlainOnly: true })
  version!: number;

  @CreateDateColumn()
  @Exclude({ toPlainOnly: true })
  createdAt!: string;

  @UpdateDateColumn()
  @Exclude({ toPlainOnly: true })
  updatedAt!: string;
}</code></pre>
</div>
</div>
</li>
<li>
<p>Add swagger metadata</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@Entity()
export class Employee extends BaseEntity {
  @ApiPropertyOptional()
  @IsDefined({ groups: [CrudValidationGroups.CREATE] })
  @IsOptional({ groups: [CrudValidationGroups.UPDATE] })
  @MaxLength(255)
  @Column('varchar', { length: 255, nullable: true })
  name?: string;

  @ApiPropertyOptional()
  @IsDefined({ groups: [CrudValidationGroups.CREATE] })
  @IsOptional({ groups: [CrudValidationGroups.UPDATE] })
  @MaxLength(255)
  @Column('varchar', { length: 255, nullable: true })
  surname?: string;

  @ApiPropertyOptional()
  @IsDefined({ groups: [CrudValidationGroups.CREATE] })
  @IsOptional({ groups: [CrudValidationGroups.UPDATE] })
  @MaxLength(255)
  @IsEmail()
  @Column('varchar', { length: 255, nullable: true })
  email?: string;
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Add swagger metadata to <code>src/app/employee/controllers/employee.crud.controller.ts</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">@ApiTags('employee')</code></pre>
</div>
</div>
</li>
<li>
<p>Generate database migrations</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Build the application: <code>yarn build</code></p>
</li>
<li>
<p>In order to create migration scripts with TypeORM, you need to install ts-node: <code>yarn global add ts-node</code></p>
</li>
<li>
<p>Generate the tables creation migration: <code>yarn run typeorm migration:generate -n CreateTables</code></p>
<div class="imageblock">
<div class="content">
<img src="../_images/images/generate-migrations.PNG" alt="generate migrations">
</div>
</div>
<div class="paragraph">
<p>The output will be something similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">export class CreateTables1572480273012 implements MigrationInterface {
  name = 'CreateTables1572480273012';

  public async up(queryRunner: QueryRunner): Promise&lt;any&gt; {
    await queryRunner.query(
      `CREATE TABLE "user" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "version" integer NOT NULL DEFAULT (1), "createdAt" datetime NOT NULL DEFAULT (datetime('now')), "updatedAt" datetime NOT NULL DEFAULT (datetime('now')), "username" varchar(255) NOT NULL, "password" varchar(255) NOT NULL, "role" integer NOT NULL DEFAULT (0))`,
      undefined,
    );
    await queryRunner.query(
      `CREATE TABLE "employee" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "version" integer NOT NULL DEFAULT (1), "createdAt" datetime NOT NULL DEFAULT (datetime('now')), "updatedAt" datetime NOT NULL DEFAULT (datetime('now')), "name" varchar(255), "surname" varchar(255), "email" varchar(255))`,
      undefined,
    );
  }

  public async down(queryRunner: QueryRunner): Promise&lt;any&gt; {
    await queryRunner.query(`DROP TABLE "employee"`, undefined);
    await queryRunner.query(`DROP TABLE "user"`, undefined);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The number in the name is a timestamp, so may change in your application.</p>
</div>
</li>
<li>
<p>Create a migration to insert data:`yarn run typeorm migration:generate -n InsertData`</p>
<div class="imageblock">
<div class="content">
<img src="../_images/images/insert-data.PNG" alt="insert data">
</div>
</div>
<div class="paragraph">
<p>and fill in with the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">export class InsertData1572480830290 implements MigrationInterface {
  public async up(queryRunner: QueryRunner): Promise&lt;any&gt; {
    await queryRunner.query(
      `INSERT INTO EMPLOYEE(id, name, surname, email) VALUES(1, 'Santiago', 'Fowler', 'Santiago.Fowler@example.com');`,
    );
    await queryRunner.query(
      `INSERT INTO EMPLOYEE(id, name, surname, email) VALUES(2, 'Clinton', 'Thornton', 'Clinton.Thornton@example.com');`,
    );
    await queryRunner.query(
      `INSERT INTO EMPLOYEE(id, name, surname, email) VALUES(3, 'Lisa', 'Rodriquez', 'Lisa.Rodriquez@example.com');`,
    );
    await queryRunner.query(
      `INSERT INTO EMPLOYEE(id, name, surname, email) VALUES(4, 'Calvin', 'Becker', 'Calvin.Becker@example.com');`,
    );
    await queryRunner.query(`INSERT INTO USER(id, username, password, role) VALUES(?, ?, ?, ?);`, [
      1,
      'user',
      await hash('password', await genSalt(12)),
      roles.USER,
    ]);
    await queryRunner.query(`INSERT INTO USER(id, username, password, role) VALUES(?, ?, ?, ?);`, [
      2,
      'admin',
      await hash('admin', await genSalt(12)),
      roles.ADMIN,
    ]);
  }

  public async down(queryRunner: QueryRunner): Promise&lt;any&gt; {
    await queryRunner.query(`DELETE FROM EMPLOYEE`);
    await queryRunner.query(`DELETE FROM USER`);
  }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Start the application: <code>yarn start:dev</code></p>
<div class="imageblock">
<div class="content">
<img src="../_images/images/start-app.png" alt="start app">
</div>
</div>
</li>
<li>
<p>Check the swagger endpoint: <code><a href="http://localhost:3000/v1/api" class="bare">http://localhost:3000/v1/api</a></code></p>
<div class="imageblock">
<div class="content">
<img src="../_images/images/swagger.png" alt="swagger">
</div>
</div>
</li>
<li>
<p>Make petitions to the employee CRUD: <code><a href="http://localhost:3000/v1/employee/employees" class="bare">http://localhost:3000/v1/employee/employees</a></code></p>
<div class="imageblock">
<div class="content">
<img src="../_images/images/employees.png" alt="employees">
</div>
</div>
</li>
<li>
<p>Write the tests</p>
<div class="paragraph">
<p>As we do not create any method, only add some properties to the entity, all application must be tested by the autogenerated code. As we add some modules, you need to uncomment some lines in the <code>src/app/core/configuration/services/configuration.service.spec.ts</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">describe('ConfigurationService', () =&gt; {
  const configService: ConfigurationService = new ConfigurationService();

  it('should return the values of test config file', () =&gt; {
    expect(configService.isDev).toStrictEqual(def.isDev);
    expect(configService.host).toStrictEqual(def.host);
    expect(configService.port).toStrictEqual(def.port);
    expect(configService.clientUrl).toStrictEqual(def.clientUrl);
    expect(configService.globalPrefix).toStrictEqual(def.globalPrefix);
    // Remove comments if you add those modules
    expect(configService.database).toStrictEqual(def.database);
    expect(configService.swaggerConfig).toStrictEqual(def.swaggerConfig);
    expect(configService.jwtConfig).toStrictEqual(def.jwtConfig);
    // expect(configService.mailerConfig).toStrictEqual(def.mailerConfig);
  });
  it('should take the value of environment varible if defined', () =&gt; {
    process.env.isDev = 'true';
    process.env.host = 'notlocalhost';
    process.env.port = '123456';
    process.env.clientUrl = 'http://theclienturl.net';
    process.env.globalPrefix = 'v2';
    process.env.swaggerConfig = JSON.stringify({
      swaggerTitle: 'Test Application',
    });
    process.env.database = JSON.stringify({
      type: 'oracle',
      cli: { entitiesDir: 'src/notentitiesdir' },
    });
    process.env.jwtConfig = JSON.stringify({ secret: 'NOTSECRET' });
    // process.env.mailerConfig = JSON.stringify({ mailOptions: { host: 'notlocalhost' }});

    expect(configService.isDev).toBe(true);
    expect(configService.host).toBe('notlocalhost');
    expect(configService.port).toBe(123456);
    expect(configService.clientUrl).toBe('http://theclienturl.net');
    expect(configService.globalPrefix).toBe('v2');
    const database: any = { ...def.database, type: 'oracle' };
    database.cli.entitiesDir = 'src/notentitiesdir';
    expect(configService.database).toStrictEqual(database);
    expect(configService.swaggerConfig).toStrictEqual({
      ...def.swaggerConfig,
      swaggerTitle: 'Test Application',
    });
    expect(configService.jwtConfig).toStrictEqual({
      ...def.jwtConfig,
      secret: 'NOTSECRET',
    });
    // const mail: any = { ...def.mailerConfig };
    // mail.mailOptions.host = 'notlocalhost';
    // expect(configService.mailerConfig).toStrictEqual(mail);

    process.env.isDev = undefined;
    process.env.host = undefined;
    process.env.port = undefined;
    process.env.clientUrl = undefined;
    process.env.globalPrefix = undefined;
    process.env.database = undefined;
    process.env.swaggerConfig = undefined;
    process.env.jwtConfig = undefined;
    // process.env.mailerConfig = undefined;
  });
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the output should be:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/images/test.png" alt="test">
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
