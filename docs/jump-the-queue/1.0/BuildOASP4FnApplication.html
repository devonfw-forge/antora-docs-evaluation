<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Devonfw.github.io Docs</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">Devonfw.github.io Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="jump-the-queue" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">Jump-the-queue</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../architecture-guidelines/1.0/index.html">Architecture-guidelines</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../architecture-guidelines/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../cicdgen/1.0/index.html">Cicdgen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../cicdgen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../cobigen/1.0/index.html">Cobigen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../cobigen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../dashboard/1.0/index.html">Dashboard</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../dashboard/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devon4j/1.0/index.html">Devon4j</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devon4j/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devon4net/1.0/index.html">Devon4net</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devon4net/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devon4ng/1.0/index.html">Devon4ng</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devon4ng/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devon4node/1.0/index.html">Devon4node</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devon4node/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devon4quarkus/1.0/index.html">Devon4quarkus</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devon4quarkus/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devon4ts/1.0/index.html">Devon4ts</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devon4ts/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../devonfw.github.io/1.0/index.html">devonfw.github.io</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../devonfw.github.io/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../getting-started/1.0/index.html">Getting-started</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../getting-started/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../github/1.0/index.html">Github</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../github/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../hangar/1.0/index.html">Hangar</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../hangar/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../ide/1.0/index.html">IDE</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../ide/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="index.html">Jump-the-queue</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../mrchecker/1.0/index.html">Mrchecker</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../mrchecker/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../my-thai-star/1.0/index.html">My-thai-star</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../my-thai-star/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../production-line/1.0/index.html">Production-line</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../production-line/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../shop-floor/1.0/index.html">Shop-floor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../shop-floor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../solicitor/1.0/index.html">Solicitor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../solicitor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../sonar-devon4j-plugin/1.0/index.html">Sonar-devon4j-plugin</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../sonar-devon4j-plugin/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../devonfw.github.io/1.0/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/MarvDan/jump-the-queue/edit/master/modules/ROOT/pages/BuildOASP4FnApplication.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#build-your-oasp4fn-application">Build your OASP4Fn Application</a></li>
<li><a href="#install-tools">Install Tools</a></li>
<li><a href="#visual-studio-code">Visual Studio Code</a></li>
<li><a href="#nodejs">NodeJS</a></li>
<li><a href="#typescript">Typescript</a></li>
<li><a href="#yarn">Yarn</a></li>
<li><a href="#serverless">Serverless</a></li>
<li><a href="#postman">Postman</a></li>
<li><a href="#starting-our-project-through-a-template">Starting our Project through a Template</a></li>
<li><a href="#local-database-setup">Local Database Setup</a></li>
<li><a href="#aws-credentials">AWS Credentials</a></li>
<li><a href="#adding-types">Adding Types</a></li>
<li><a href="#start-the-development">Start the Development</a></li>
<li><a href="#generating-the-configuration-files">Generating the Configuration Files</a></li>
<li><a href="#build-and-run-your-handlers-locally">Build and Run your Handlers Locally</a></li>
<li><a href="#">==</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="build-your-oasp4fn-application"><a class="anchor" href="#build-your-oasp4fn-application"></a>Build your OASP4Fn Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we are going to build a serverless back-end with OASP4Fn. The main objective of this tutorial is to take an initial contact with OASP4Fn and the necessary tools we are going to use in the development, so at the end of it, the user will be enough confident to start developing a new project with OASP4Fn without problems.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install-tools"><a class="anchor" href="#install-tools"></a>Install Tools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we’re going to introduce all the necessary tools we’re going to need to start programming and a initial configuration if necessary.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="visual-studio-code"><a class="anchor" href="#visual-studio-code"></a>Visual Studio Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Download the installer from the <a href="https://code.visualstudio.com/Download">official page</a> and install it.
Once installed, the first thing you should do is install the extensions that will help you during the development, to do that follow this steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install <a href="https://marketplace.visualstudio.com/items?itemName=Shan.code-settings-sync">Settings Sync</a> extension.</p>
</li>
<li>
<p>Open the command palette (CTRL+Shift+P) and introduce the command: <strong>Sync: Download Settings</strong>.</p>
</li>
<li>
<p>Provide GIST ID: <code><strong>3b1d9d60e842f499fc39334a1dd28564</strong></code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the case that you are unable to set up the extensions using the method mentioned, you can also use the scripts provided in <a href="https://github.com/oasp/oasp-vscode-ide">this</a> repository.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="nodejs"><a class="anchor" href="#nodejs"></a>NodeJS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Go to the <a href="https://nodejs.org/en/">node.js</a> official page and download the version you like the most, the LTS or the Current as you wish.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="typescript"><a class="anchor" href="#typescript"></a>Typescript</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s install what is going to be the main language during development: TypeScript. This is a ES6 super set that will help us to get a final clean and distributable JavaScript code. This is installed globally with <a href="https://www.npmjs.com/">npm</a>, the package manager used to install and create JavaScript modules in NodeJS, that is installed along with Node, so for install typescript you don’t have to install npm explicitly, only run this command:</p>
</div>
<div class="paragraph">
<p><code>npm install –g typescript</code></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="yarn"><a class="anchor" href="#yarn"></a>Yarn</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As npm, <a href="https://yarnpkg.com/en/">Yarn</a> is a package manager, the differences are that Yarn is quite more faster and usable, so we decided to use it to manage the dependencies of OASP4Fn projects.</p>
</div>
<div class="paragraph">
<p>To install it you only have to go to the official <a href="https://yarnpkg.com/en/docs/install">installation page</a> and follow the instructions.</p>
</div>
<div class="paragraph">
<p>Even though, if you feel more comfortable with npm, you can remain using npm, there is no problem regarding this point.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="serverless"><a class="anchor" href="#serverless"></a>Serverless</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lastly, we are going to install the serverless framework, that are going to help us deploying our handlers in our provider we have chosen.</p>
</div>
<div class="paragraph">
<p><code>npm install –g serverless</code></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="postman"><a class="anchor" href="#postman"></a>Postman</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.getpostman.com/">Postman</a> is an app that helps you build HTTP requests and send them to a server through any of the HTTP methods. This tool will be useful at the end of the tutorial when we are going to run our handlers locally and send POST HTTP requests to them.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="starting-our-project-through-a-template"><a class="anchor" href="#starting-our-project-through-a-template"></a>Starting our Project through a Template</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To start with the tutorial we are going to use the <a href="https://github.com/oasp/oasp4fn-application-template">oasp4fn application template</a>, so use the following command to clone it in your local machine:</p>
</div>
<div class="paragraph">
<p><code>git clone <a href="https://github.com/oasp/oasp4fn-application-template.git" class="bare">https://github.com/oasp/oasp4fn-application-template.git</a> jumpTheQueue</code></p>
</div>
<div class="paragraph">
<p>Before continue, remember to replace the remote repository, for one that you own:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>cd jumpTheQueue\
git remote remove origin
git remote add origin &lt;your-git-repository&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This template comes with the structure that has to have an OASP4Fn application and the skeleton of some handlers. These handlers are stored on event folders, which we can add or remove adjusting to our needs, so how we only are going to use HTTP events, we are going to access to the cloned folder and remove S3 folder inside the handlers and test folders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>rm handlers\S3\ -r
rm test\S3\ -r</code></pre>
</div>
</div>
<div class="paragraph">
<p>Only remains to install the base dependencies of our code using yarn, so we only have to run:</p>
</div>
<div class="paragraph">
<p><code>yarn</code></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="local-database-setup"><a class="anchor" href="#local-database-setup"></a>Local Database Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The database we are going to use during this tutorial is <a href="https://aws.amazon.com/dynamodb/">dynamodb</a>, the NoSQL database provided by AWS, which is supported by OASP4Fn.
First you have to download and start it following <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBLocal.html#DynamoDBLocal.DownloadingAndRunning">Amazon Official Documentation</a>, once you have downloaded DynamoDB on your computer, open the corresponding shell using the local endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>http://localhost:8000/shell/</code></pre>
</div>
</div>
<div class="paragraph">
<p>And an interactive shell will be opened in your default browser like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/oasp4fn/3.BuildYourOwn/dynamo_db_shell.png" alt="Dynamo DB Shell">
</div>
</div>
<div class="paragraph">
<p>Now we are going to create a table called Queue with the opened shell, to do that write <code>createTable</code> in the text pane sited at the left side of the screen and press CTRL + Space, this will generate a template object specifying the properties that has to be passed to the create function, so we have to modify that object, having at the end something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">var params = {
    TableName: 'Queue',
    KeySchema: [ // The type of of schema.  Must start with a HASH type, with an optional second RANGE.
        { // Required HASH type attribute
            AttributeName: 'code',
            KeyType: 'HASH',
        }
    ],
    AttributeDefinitions: [ // The names and types of all primary and index key attributes only
        {
            AttributeName: 'code',
            AttributeType: 'S', // (S | N | B) for string, number, binary
        },
        // ... more attributes ...
    ],
    ProvisionedThroughput: { // required provisioned throughput for the table
        ReadCapacityUnits: 1,
        WriteCapacityUnits: 1,
    }
};
dynamodb.createTable(params, function(err, data) {
    if (err) ppJson(err); // an error occurred
    else ppJson(data); // successful response

});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally press CTRL + Enter, and if we have specified the properties properly an output with table description will be displayed at the left side console:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/oasp4fn/3.BuildYourOwn/table_description.png" alt="Table Description">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="aws-credentials"><a class="anchor" href="#aws-credentials"></a>AWS Credentials</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Although we are going to use a local instance, aws-sdk is going to look for credentials required for the configuration and an error will raise if the credentials are missing, so for that reason we are going to add a credentials file in an <em>.aws</em> folder in our home directory. Said that, first of all create the folder with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>cd %HOME% #or only 'cd' if you are in a Unix based OS
mkdir .aws</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have created the folder, add a file inside called <em>credentials</em> and write the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>[default]
aws_access_key_id = your_key_id
aws_secret_access_key = your_secret_key</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is no need to put real credentials in the file as we are going to work locally in this tutorial, you can leave it as above, without replacing <em>your_key_id</em> or <em>your_secret_key</em>, so the sdk will inject the credentials and won&#8217;t throw any error, but if you already have credentials, feel free to replace them there, so you have well located for future developments.</p>
</div>
<div class="paragraph">
<p>Finally, it&#8217;s worth saying that there are more ways to pass the credentials to the sdk, but this is the best in our case, for more information about credentials take a look on to the
<a href="http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/setting-credentials-node.html">official documentation</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adding-types"><a class="anchor" href="#adding-types"></a>Adding Types</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The template we have cloned comes with a declaration types at the root of the handlers folder with types for AWS lambda service and events, but must add more types for the data we are going to manage, so we are going to export an interface Visitor and an interface Code in our declaration file, that will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">export interface Visitor {
    name: string;
    email: string;
    phone: string;
}

export interface Code {
    code: string;
    dateAndTime: number;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="start-the-development"><a class="anchor" href="#start-the-development"></a>Start the Development</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we already have finish the set up of our project, we are going to add our handlers based on our design:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One that will add the visitor to the queue</p>
</li>
<li>
<p>And other to get your position in the queue</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both of the handlers will be triggered by HTTP events with a post method, so we should delete the rest of the methods than don&#8217;t are going to use, both in the handlers and test folders. So once we have done that we are going to modify our initial handler in the template following the next steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Rename the template handler to <em>register-handler.ts</em></p>
</li>
<li>
<p>Install the <em>Lodash</em> package through <code><code>yarn add &lt;package_name&gt;</code></code> and import it.</p>
</li>
<li>
<p>Import the <em>fn-dynamo</em> adapter.</p>
</li>
<li>
<p>Add our <em>Visitor</em> interface we add to the <em>types.d.ts</em> file.</p>
</li>
<li>
<p>Set the dynamo adapter to oasp4fn as the database adapter.</p>
</li>
<li>
<p>Specify the configuration to this concrete handler, in this case only the path property is necessary.</p>
</li>
<li>
<p>Rename the handler.</p>
</li>
<li>
<p>Write the logic of our function with the the imported adapter.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>But before write the logic of our handler, we are going to add some utility function to the <em>utils.ts</em> file at the root of our <em>handlers</em> folder, and export them, so that functions can be exported in our handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">import * as _ from 'lodash';
import { Visitor } from './types';

const ALPHABET = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';

export let getRandomCode = (len: number) =&gt; {
    if (!Number.isFinite(len) || len &lt; 1) {
	throw new TypeError('Invalid code lenght');
    }

    let str = '';
    while(len &gt; 0) {
        str += ALPHABET[_.random(Number.MAX_SAFE_INTEGER) % ALPHABET.length];
        --len;
    }

	return str;
};

export let validateVisitor = (visitor: Visitor) =&gt; {
    let ok = true;

    _.some(visitor, (value, key) =&gt; {
        switch (key) {
            case 'phone':
                ok = /^(\d+\s?)+\d+$/.test(value);
                break;
            case 'email':
                ok = /^(([^&lt;&gt;()\[\]\\.,;:\s@"]+(\.[^&lt;&gt;()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(value);
                break;
        }
        return !ok;
    })

    return ok;
};

export let isVisitor = (object: any): object is Visitor =&gt; {
    return 'name' in object &amp;&amp; 'phone' in object &amp;&amp; 'email' in object;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So the handler that will register the user to the queue will be able to take the visitor information, generate a unique code with the above function package, insert it into our data base, along with the result of the handler, the generated code and the hour to the visit, so the resulting handler will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">import oasp4fn from '@oasp/oasp4fn';
import dynamo from '@oasp/oasp4fn/dist/adapters/fn-dynamo';
import { HttpEvent, Context, Visitor } from '../../types';
import * as _ from 'lodash';
import { getRandomCode, validateVisitor, isVisitor } from '../../utils';

oasp4fn.setDB(dynamo);

oasp4fn.config({path: 'register'});
export async function register (event: HttpEvent, context: Context, callback: Function) {
    try {
        let visitor = event.body;

        if(!isVisitor(visitor) || !validateVisitor(visitor))
            throw new Error();

        let date = new Date();
        date.setDate(date.getDate() + 1);

        let code: string | undefined;
        while(!code) {
            let aux = getRandomCode(3);
            let res = await oasp4fn.table('Queue', aux).promise();
            if(!res)
                code = aux;
        }

        let result = { code: code, dateAndTime: Date.parse(date.toDateString())};
        await oasp4fn.insert('Queue', _.assign(visitor, result)).promise();
        callback(null, result);
    }
    catch(err){
        callback(new Error('[500] Cannot register the visitor to the queue'));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second and last handler for the application will be that which return the full or part of the queue, by passing full or partial information of a visitor or, in case to the full queue, an empty object, so for achieve that we will have to create a new file in the same directory we have the last one, and name it <em>search-handler.ts</em>, next we are going to repeat the 3 to 8 steps, so we will have the next handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">import oasp4fn from '@oasp/oasp4fn';
import dynamo from '@oasp/oasp4fn/dist/adapters/fn-dynamo';
import { HttpEvent, Context } from '../../types';

oasp4fn.setDB(dynamo);

oasp4fn.config({path: 'search'});
export async function search (event: HttpEvent, context: Context, callback: Function) {
    try {
        let visitor = event.body;
        let res = await oasp4fn.table('Queue')
                        .filter(visitor)
                        .promise();
        callback(null, res);
    }
    catch(err){
        callback(new Error('[500] Cannot get the queue'));
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generating-the-configuration-files"><a class="anchor" href="#generating-the-configuration-files"></a>Generating the Configuration Files</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this part we are going to learn how to generate the configuration files that we are going to use to build and deploy our handlers. The first step, is to add the configuration in the <code>oasp4fn.config.js</code> file, but how isn&#8217;t necessary more configuration than the default one in this tutorial, we are going to remove that file:</p>
</div>
<div class="paragraph">
<p><code>rm oasp4fn.config.js</code></p>
</div>
<div class="paragraph">
<p>Finally we can execute the command:</p>
</div>
<div class="paragraph">
<p><code>yarn fun</code></p>
</div>
<div class="paragraph">
<p>And is all goes well, two files, <code>serverless.yml</code> and <code>webpack.config.json</code> will be generated and we will see this command line output:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/oasp4fn/3.BuildYourOwn/fun_output.png" alt="FUN Output">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="build-and-run-your-handlers-locally"><a class="anchor" href="#build-and-run-your-handlers-locally"></a>Build and Run your Handlers Locally</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To execute our handlers locally we will make use of the <a href="https://github.com/dherault/serverless-offline">serverless-offline</a> plugin, that emulates a local API-gateway that let you build your handlers through webpack and send HTTP requests to them, so run:</p>
</div>
<div class="paragraph">
<p><code>yarn offline</code></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id=""><a class="anchor" href="#"></a>==</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To run this command you must have the <em>serverless.yml</em> file generated, and the serverless-offline plugin specified in the plugin section (that is automatically added by the default configuration of OASP4Fn). To search for more information about the serverless plugins, you can dive into the <a href="https://serverless.com/framework/docs/providers/aws/guide/plugins/">serverless documentation</a>.
== ==</p>
</div>
<div class="paragraph">
<p>and you will see the following output:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/oasp4fn/3.BuildYourOwn/offline.png" alt="Offline">
</div>
</div>
<div class="paragraph">
<p>And when the webpack rebuild line appears you can start to send requests to the specified endpoints, so open the postman and create a visitor sending a POST request to the register endpoint:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/oasp4fn/3.BuildYourOwn/postman_register.png" alt="Postman Register">
</div>
</div>
<div class="paragraph">
<p>After this, test your other handler, sending a void object with the POST HTTP request, and see how our handler return the visitor inserted:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/oasp4fn/3.BuildYourOwn/postman_search.png" alt="Postman Search">
</div>
</div>
<hr>
<div class="paragraph">
<p><strong>Next Chapter</strong>: <a href="OASP4FnTesting">Test your OASP4Fn App</a></p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
