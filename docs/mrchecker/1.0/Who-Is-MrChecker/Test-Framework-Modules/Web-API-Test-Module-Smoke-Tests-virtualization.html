<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Devonfw.github.io Docs</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Devonfw.github.io Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="mrchecker" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">Mrchecker</span>
    <span class="version">1.0</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../architecture-guidelines/1.0/index.html">Architecture-guidelines</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../architecture-guidelines/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../cicdgen/1.0/index.html">Cicdgen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../cicdgen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../cobigen/1.0/index.html">Cobigen</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../cobigen/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../dashboard/1.0/index.html">Dashboard</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../dashboard/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../devon4j/1.0/index.html">Devon4j</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../devon4j/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../devon4net/1.0/index.html">Devon4net</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../devon4net/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../devon4ng/1.0/index.html">Devon4ng</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../devon4ng/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../devon4node/1.0/index.html">Devon4node</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../devon4node/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../devon4quarkus/1.0/index.html">Devon4quarkus</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../devon4quarkus/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../devon4ts/1.0/index.html">Devon4ts</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../devon4ts/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../devonfw.github.io/1.0/index.html">devonfw.github.io</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../devonfw.github.io/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../getting-started/1.0/index.html">Getting-started</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../getting-started/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../github/1.0/index.html">Github</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../github/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../hangar/1.0/index.html">Hangar</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../hangar/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../ide/1.0/index.html">IDE</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../ide/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../jump-the-queue/1.0/index.html">Jump-the-queue</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../jump-the-queue/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../index.html">Mrchecker</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../my-thai-star/1.0/index.html">My-thai-star</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../my-thai-star/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../production-line/1.0/index.html">Production-line</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../production-line/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../shop-floor/1.0/index.html">Shop-floor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../shop-floor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../solicitor/1.0/index.html">Solicitor</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../solicitor/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../sonar-devon4j-plugin/1.0/index.html">Sonar-devon4j-plugin</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../sonar-devon4j-plugin/1.0/index.html">1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../devonfw.github.io/1.0/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/MarvDan/mrchecker/edit/develop/modules/ROOT/pages/Who-Is-MrChecker/Test-Framework-Modules/Web-API-Test-Module-Smoke-Tests-virtualization.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="sect1">
<h2 id="_start_a_virtual_server"><a class="anchor" href="#_start_a_virtual_server"></a>Start a virtual server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following picture presents the process of executing Smoke Tests in a virtualized environment:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/images/image78.png" alt="image78">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_install_docker_service"><a class="anchor" href="#_install_docker_service"></a>Install docker service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If docker is not already installed on machine (this should be checked during C2C creation), install docker, docker-compose, apache2-utils, openssl (You can use <strong>script</strong> to install docker &amp; docker-compose OR refer to this <strong>post</strong> and add Alias for this machine &lt;C2C_Alias_Name&gt;):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>run the script</p>
</li>
<li>
<p>sudo apt-get install -y apache2-utils</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_a_docker_image"><a class="anchor" href="#_build_a_docker_image"></a>Build a docker image</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Dockerfile:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>FROM docker.xxx.com/ubuntu:16.04
MAINTAINER Maintainer Name "maintainer@email.address"
LABEL name=ubuntu_java \
           version=v1-8.0 \
           base="ubuntu:16.04" \
           build_date="03-22-2018" \
           java="1.8.0_162" \
           wiremock="2.14.0" \
           description="Docker to use with Ubuntu, JAVA and WIREMOCK "

##Update and install the applications needed
COPY 80proxy /etc/apt/apt.conf.d/80proxy
RUN apt-get update
RUN apt-get install -y \
            wget \
            libfontconfig \
            unzip \
            zip
            ksh \
            curl \
            git

COPY wgetrc /etc/wgetrc

#Env parameters

### JAVA PART ###
#TO UPDATE:please verify url link to JDK http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html
##Download and install JAVA JDK8
RUN mkdir /opt/jdk
RUN wget -qq --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u162-b12/0da788060d494f509bf8624735fa2f1/jdk-8u162-linux-x64.tar.gz &amp;&amp; tar -zxf jdk-8u162-linux-x64.tar.gz -C /opt/jdk &amp;&amp; rm jdk-8u162-linux-x64.tar.gz &amp;&amp; update-alternatives --install /usr/bin/javac javac /opt/jdk/jdk1.8.0_162/bin/javac 100 &amp;&amp; java -version &amp;&amp; chmod 755 -R /opt/jdk/jdk1.8.0_162/
RUN java -version

##Add user
RUN useradd -u 29001 -g 100 srvpwiredev

##Add app
RUN mkdir -p -m 777 /app
COPY wiremock-standalone-2.14.0.jar /app/wiremock-standalone-2.14.0.jar

##Expose port
EXPOSE 8080

##Set workdir
WORKDIR /App

##Run app
CDM java -jar /app/wiremock-standalone-2.14.0.jar</pre>
</div>
</div>
<div class="paragraph">
<p>Execute the following steps with a specified version to build a docker image and push it to the repository :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>## Build image
sudo docker build -t docker.xxx.com/app/build/wiremock:v2.14.0.

## Push image
sudo docker login docker.xxx.com
sudo docker push docker.xxx.com/app/build/wiremock:v2.14.0.</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_docker_image"><a class="anchor" href="#_run_docker_image"></a>Run docker image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To run a docker image, execute the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo docker run -td -p 8080:8080 -v /home/wiremock/repo/app/docker/QA/mappings:/app/mappings -v /home/wiremock/repo/app/docker/QA/__files:/app/__files --restart always docker.xxx.com/app/build/wiremock:v2.14.0.</pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="paragraph">
<p><strong>-p</strong> - publish a container’s port to the host</p>
</div>
<div class="paragraph">
<p><strong>-v</strong> - bind mount a volume. WireMock server creates two directories under the current one: mappings and __files. It is necessary to mount directories with already created mappings and responses to make it work.</p>
</div>
<div class="paragraph">
<p><strong>-restart always</strong> - restart policy to apply when a container exists</p>
</div>
<div class="paragraph">
<p>All of the parameters are described in: <a href="https://docs.docker.com/engine/reference/run/">official docker documentation</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_map_requests_with_virtual_assets"><a class="anchor" href="#_map_requests_with_virtual_assets"></a>Map requests with virtual assets</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>What is WireMock?</strong></p>
</div>
<div class="paragraph">
<p>WireMock is an HTTP mock server. At its core it is a web server that can be primed to serve canned responses to particular requests (stubing) and that captures incoming requests so that they can be checked later (verification). It also has an assortment of other useful features including record/playback of interactions with other APIs, injection of faults and delays, simulation of stateful behaviour.</p>
</div>
<div class="paragraph">
<p>Full documentation can be found under the following link: <a href="http://wiremock.org/docs">WireMock</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_record_create_virtual_assets_mappings"><a class="anchor" href="#_record_create_virtual_assets_mappings"></a>Record / create virtual assets mappings</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Record</strong></p>
</div>
<div class="paragraph">
<p>WireMock can create stub mappings from requests it has received. Combined with its proxying feature, this allows you to "record" stub mappings from interaction with existing APIs.</p>
</div>
<div class="paragraph">
<p>Record and playback (Legacy): <a href="http://wiremock.org/docs/record-playback-legacy/">documentation</a></p>
</div>
<div class="literalblock">
<div class="content">
<pre>java -jar wiremock-standalone-2.16.0.jar --proxy-all="http://search.twitter.com" --record-mappings --verbose</pre>
</div>
</div>
<div class="paragraph">
<p>Once it’s started and request is sent to it, it will be redirected to "http://search.twitter.com" and traffic (response) is saved to files in mappings and __files directories for further use.</p>
</div>
<div class="paragraph">
<p>Record and playback (New): <a href="http://wiremock.org/docs/record-playback/">documentation</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enable_mappings_in_a_virtual_server"><a class="anchor" href="#_enable_mappings_in_a_virtual_server"></a>Enable mappings in a virtual server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the WireMock server starts, it creates two directories under the current one: mappings and __files. To create a stub, it is necessary to drop a file with a .json extension under mappings.</p>
</div>
<div class="paragraph">
<p><strong>Run docker with mounted volumes</strong></p>
</div>
<div class="paragraph">
<p>Mappings are in a repository. It is necessary to mount directories with already created mappings and responses to make it work:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo docker run -td -p 8080:8080 -v /home/wiremock/repo/app/docker/QA/mappings:/app/mappings -v /home/wiremock/repo/app/docker/QA/__files:/app/__files --restart always docker.xxx.com/app/build/wiremock:v2.14.0.</pre>
</div>
</div>
<div class="paragraph">
<p>The description of how to build and run docker is available under: <a href="https://docs.docker.com/engine/reference/run/">Docker run command description</a></p>
</div>
<div class="paragraph">
<p><strong>Recorded mappings</strong></p>
</div>
<div class="paragraph">
<p>Recorded mappings are kept in the project repository.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_user_and_map_them_to_docker_user"><a class="anchor" href="#_create_a_user_and_map_them_to_docker_user"></a>Create a user and map them to docker user</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To enable the connection from Jenkins to Virtual Server (C2C), it is necessary to create a user and map them to docker group user. It can be done using the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>adduser -G docker -m wiremock</pre>
</div>
</div>
<div class="paragraph">
<p>To set the password for a wiremock user:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>passwd wiremock</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_ssh_private_and_public_keys_for_a_wiremock_user"><a class="anchor" href="#_create_ssh_private_and_public_keys_for_a_wiremock_user"></a>Create SSH private and public keys for a wiremock user</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SSH keys serve as a means of identifying yourself to an SSH server using <a href="https://en.wikipedia.org/wiki/Public-key_cryptography">public-key cryptography</a> and <a href="https://en.wikipedia.org/wiki/Challenge%E2%80%93response_authentication">challenge-response authentication</a>. One immediate advantage this method has over traditional password is that you can be authenticated by the server without ever having to send your password over the network.</p>
</div>
<div class="paragraph">
<p>To create an SSH key, log in as wiremock (previously created user).</p>
</div>
<div class="literalblock">
<div class="content">
<pre>su wiremock</pre>
</div>
</div>
<div class="paragraph">
<p>The .ssh directory is not by default created below user home directory. Therefore, it is necessary to create it:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mkdir ~/.ssh</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can proceed with creating an RSA key using ssh-keygen (a tool for creating new authentication key pairs for SSH):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ssh-keygen -t rsa</pre>
</div>
</div>
<div class="paragraph">
<p>A key should be created under /.ssh/id_rsa
Appending the public keys to authorized_keys:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wiremock@vc2crptXXXXXXXn:~/ssh$ cat id_rsa.pub &gt;&gt; authorized_keys</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_install_an_ssh_key_in_jenkins"><a class="anchor" href="#_install_an_ssh_key_in_jenkins"></a>Install an SSH key in Jenkins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To add an SSH key to Jenkins, go to credentials in your job location. Choose the folder within credentials, then 'global credentials', 'Add credentials'. Fill in the fields. Finally, the entry should be created.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_a_jenkins_groovy_script"><a class="anchor" href="#_build_a_jenkins_groovy_script"></a>Build a Jenkins Groovy script</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The description of how to use SSH Agent plugin in Jenkins pipeline can be found under: <a href="https://www.karthikeyan.tech/2017/09/ssh-agent-blue-ocean-via-jenkins.html" class="bare">https://www.karthikeyan.tech/2017/09/ssh-agent-blue-ocean-via-jenkins.html</a></p>
</div>
<div class="paragraph">
<p>Example of use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sshagent (credentials: [env.WIREMOCK_CREDENTIALS]) {
     sh """
         ssh -T -o StrictHostKeyChecking=no -l ${env.WIREMOCK_USERNAME} ${env.WIREMOCK_IP_ADDRESS} "docker container restart ${env.WIREMOCK_CONTAINER_NAME}"
     """
}</pre>
</div>
</div>
<div class="paragraph">
<p>Where: env.WIREMOCK_CREDENTIALS is a credential id of previously created wiremock credentials. Now that it is present, we can execute commands on a remote machine, where in ssh command:
env.WIREMOCK_USERNAME - user name of user connected with configured private key
env.WIREMOCK_IP_ADDRESS - ip address of the machine where this user with this private key exists</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pull_repository_with_virtual_assets"><a class="anchor" href="#_pull_repository_with_virtual_assets"></a>Pull repository with virtual assets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To pull the repository on a remote machine, it is necessary to use the previously described SSH Agent plugin. An example of use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sshagent (credentials: [env.WIREMOCK_CREDENTIALS]) {
withCredentials([usernamePassword(credentialsId: end.STASH_CREDENTIALS, passwordVariable: 'PASS', usernameVariable: 'USER')]) {
     sh """
         ssh -T -o StrictHostKeyChecking=no -l ${env.WIREMOCK_USERNAME} ${env.WIREMOCK_IP_ADDRESS} "cd ~/${env.APPLICATION_DIRECTORY_WIREMOCK}/${env.PROJET_HOME}; git fetch https://&amp;USER:$PASS@${env.GIT_WITHOUT_HTTPS} ${env.GIT_BRANCH}; git reset --hard FETCH_HEAD; git clean -df"
      """
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="paragraph">
<p><strong>withCredentials</strong> allows various kinds of credentials (secrets) to be used in idiosyncratic ways. Each binding will define an environment variable active within the scope of the step. Then the necessary commands are executed:</p>
</div>
<div class="paragraph">
<p><code>cd …​</code> - command will change from current directory to the specified directory with git repository</p>
</div>
<div class="paragraph">
<p><code>git fetch …​ ;git reset …​ ;git clean …​</code> - pull from GIT branch. Git pull or checkout are not used here to prevent the situation with wrong coding between Mac OSX/Linux etc.</p>
</div>
<div class="paragraph">
<p><strong>PLEASE remember that when using this script for the first time, the code from previous block should be changed to:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>stage("ssh-agent"){
        sshagent (credentials: [env.WIREMOCK_CREDENTIALS]) {
            withCredentials([usernamePassword(credentialsId: end.STASH_CREDENTIALS, passwordVariable: 'PASS', usernameVariable: 'USER')]) {
                sh """
                        ssh -T -o StrictHostKeyChecking=no -l ${env.WIREMOCK_USERNAME} ${env.WIREMOCK_IP_ADDRESS} "cd ~/${env.APPLICATION_DIRECTORY_WIREMOCK} ;git clone --depth=1 --branch=develop https://&amp;USER:$PASS@${env.GIT_WITHOUT_HTTPS}"';
                """
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_install_an_application_with_smoke_environment"><a class="anchor" href="#_install_an_application_with_smoke_environment"></a>Install an application with Smoke environment</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_update_properties_settings_file"><a class="anchor" href="#_update_properties_settings_file"></a>Update properties settings file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>New settings file is pushed to the repository. Example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>...
   &lt;key&gt;autocomplete&lt;/key&gt;
   &lt;string&gt;http://server:port&lt;/string&gt;
   &lt;key&gt;benefitsummary&lt;/key&gt;
   &lt;string&gt;http://server:port&lt;/string&gt;
   &lt;key&gt;checkscan&lt;/key&gt;
   &lt;string&gt;http://server:port&lt;/string&gt;
   &lt;key&gt;dpesb&lt;/key&gt;
   &lt;string&gt;http://server:port&lt;/string&gt;
...</pre>
</div>
</div>
<div class="paragraph">
<p>Address of service (backend) should be changed to wiremock address as it is shown on listing to change the default route.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_an_application_with_updated_properties_file"><a class="anchor" href="#_build_an_application_with_updated_properties_file"></a>Build an application with updated properties file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>New versions of application are prepared by Jenkins job.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_install_an_application_on_target_properties_file"><a class="anchor" href="#_install_an_application_on_target_properties_file"></a>Install an application on target properties file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Installation of an application is actually executed in a non-automated way using SeeTest environment.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ui_tests"><a class="anchor" href="#_ui_tests"></a>UI tests</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_run_jenkins_job"><a class="anchor" href="#_run_jenkins_job"></a>Run Jenkins job</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Jenkinsfile:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>// Jenkins parameters are overriding the properties below
def properties = [

          JENKINS_LABELS                                 : 'PWI_LINUX_DEV',
          APPLICATION_FOLDER                             : 'app_dir',
          PROJECT_HOME                                   : 'app_home_folder',

          //WIREMOCK
          WIREMOCK_CREDENTIALS                           : 'vc2crptXXXXXXn',
          WIREMOCK_USERNAME                              : 'wiremock',
          WIREMOCK_ADDRESS                               : 'http://vc2crptXXXXXXn.xxx.com:8080',
          WIREMOCK_IP_ADDRESS                            : '10.196.67.XXX',
          WIREMOCK_CONTAINER_NAME                        : 'wiremock',
          APPLICATION_DIRECTORY_WIREMOCK                 : 'repo',

          //GIT
          GIT_CREDENTIALS                                : 'e47742cc-bb66-4321-2341-a2342er24f2',
          GIT_BRANCH                                     : 'develop',
          GIT_SSH                                        : 'ssh://git@stash.xxx.com/app/app.git'
          GIT_HTTPS                                      : 'HTTPS://git@stash.xxx.com/app/app.git',

          STASH_CREDENTIALS                              : 'e47742cc-bb66-4321-2341-a2342er24f2',


          //DOCKER
          ARTIFACTORY_USER_CREDENTIALS                   : 'e47742cc-bb66-4321-2341-a2342er24f2',
          SEETEST_DOCKER_IMAGE                           : 'docker.xxx.com/project/images/app:v1-8.3',

          //SEETEST_DOCKER_IMAGE
          SEETEST_APPLICATION_FOLDER                     : 'seetest_dir',
          SEETEST_PROJECT_HOME                           : 'Automated Scripts',
          SEETEST_GIT_SSH                                : 'ssh://git@stash.xxx.com/pr/seetest_automation_cucumber.git'
          SEETEST_GIT_BRANCH                             : 'develop',
          SEETEST_GRID_USER_CREDENTIALS                  : 'e47742cc-bb66-4321-2341-a2342er24f2',
          SEETEST_CUCUMBER_TAG                           : '@Virtualization',
          SEETEST_CLOUD_NAME                             : 'Core Group',
          SEETEST_IOS_VERSION                            : '11',
          SEETEST_IOS_APP_URL                            : '',
          SEETEST_INSTALL_APP                            : 'No',
          SEETEST_APP_ENVIRONMENT                        : 'SmokeTests',
          SEETEST_DEVICE_QUERY                           : '',
]

node(properties.JENKINS_LABELS) {
    try {
        prepareEnv(properties)
        gitCheckout()
        stageStartVirtualServer()
        stageMapApiRequests()
        stageInstallApplication()
        stageUITests()
     } catch(Exception ex) {
        currentBuild.result = 'FAILURE'
        error = 'Error' + ex
     }
}

//== == == == == == == == == == == == == == == == == == END OF PIPELINE== == == == == == == == == == == == == == == == == == == == ==

private void prepareEnv(properties) {
    cleanWorkspace()
    overrideProperties(properties)
    setWorkspace()
}

private void gitCheckout() {
    dir(env.APPLICATION_FOLDER) {
        checkout([$class: 'GitSCM', branches: [[name: env.GIT_BRANCH]], doGenerateSubmoduleConfiguration: false, extensions: [[$class: 'CloneOption', depth: 0, noTags: false, reference: '', shallow: false, timeout: 50]], gitTool: 'Default', submoduleCfg: [], userRemoteConfigs: [[credentialsId: env.GIT_CREDENTIALS, url: env.GIT_SSH]])
     }
}

private void stageStartVirtualServer() {
    def module = load "${env.SUBMODULES_DIR}/stageStartVirtualServer.groovy"
    module()
}

private void stageMapApiRequests() {
    def module = load "${env.SUBMODULES_DIR}/stageMapApiRequests.groovy"
    module()
}

private void stageInstallApplication() {
    def module = load "${env.SUBMODULES_DIR}/stageInstallApplication.groovy"
    module()
}

private void stageUITests() {
    def module = load "${env.SUBMODULES_DIR}/stageUITests.groovy"
    module()
}

private void setWorkspace() {
    String workspace = pwd()
    env.APPLICATION_DIRECTORY = "/${env.APPLICATION_DIRECTORY}"
    env.WORKSPACE_LOCAL - workspace + env.APPLICATION_DIRECTORY
    env.SEETEST_PROJECT_HOME_ABSOLute_PATH = "${workspace}/${env.SEETEST_APPLICATION_FOLDER}/${env.SEETEST_PROJECT_HOME}"
    env.SUBMODULES_DIR = env.WORKSPACE_LOCAL + "/pipelines/SmokeTests.submodules"
    env.COMMONS_DIR    = env.WORKSPACE_LOCAL + "/pipelines/commons"
}

/*
    function ovverrides env vales based on provided properties
*/
private void overrideProperties(properties) {
    for (param in properties) {
        if (env.(param.key) ==  null) {
           echo "Adding parameter '${param.key}' with default value: '$param.value}'"
           env.(param.key) = param.value
        } else {
           echo "Parameter '${param.key}' has overriden value: '${env.(param.key)}'"
        }
     }

     echo sh(script: "env | sort", returnStdout: true)
}

private void cleanWorkspace() {
   sh 'rm-rf *'
}</pre>
</div>
</div>
<div class="paragraph">
<p>stageStartVirtualServer.groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>def call () {
    stage("Check virtual server") {
        def statusCode

        try {
            def response = httpRequest "${env.WIREMOCK_ADDRESS}/__admin/"
            statusCode = response.status
        } catch(Exception ex) {
            currentBuild.result = 'FAILURE'
            error 'WireMock server os unreachable.'
        }

        if(statusCode !=200) {
            currentBuild.result = 'FAILURE'
            error 'WireMock server is unreachable. Return code: ${statusCode}'
        }
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>stageMapApiRequests.groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>def call() {
    stage("Map API requests with virtual assets") {
        checkoutRepository()
        restartWiremock()
        checkWiremockStatus()
     }
}

private checkoutRepository() {
    extractHTTPSUrl()
    sshagent (credentials: [env.WIREMOCK_CREDENTIALS]) {
        withCredentials([usernamePassword(credentialsId: env.STASH_CREDENTIALS, passwordVariable: 'PASS', usernameVariable: 'USER')]) {
            sh """
                ssh -T -o StrictHostKeyChecking=no -l ${env.WIREMOCK_USERNAME} ${env.WIREMOCK_IP_ADDRESS} "cd~/${env.APPLICATION_DIRECTORY_WIREMOCK}/${env.PROJECT_HOME}; git fetch https://$USER:$PASS@${env.GIT_WITHOUT_HTTPS} ${env.GIT_BRANCH}; git reset --hard FETCH_HEAD; git clean -df"
             """
         }
     }
}

private restartWiremock() {
    sshagent (credentials: [env.WIREMOCK_CREDENTIALS]) {
            sh """
                ssh -T -o StrictHostKeyChecking=no -l ${env.WIREMOCK_USERNAME} ${env.WIREMOCK_IP_ADDRESS} "docker container restart ${env.WIREMOCK_CONTAINER_NAME}"
             """
     }
}

private checkWiremockStatus() {
    int wiremockStatusCheckCounter =6
    int sleepTimeInSeconds = 10
    def wiremockStatus

    for (i = 0; i &lt; wiremockStatusCheckCounter; i++) {
         try {
             wiremockStatus = getHttpRequestStatus()
             echo "WireMock server status code: ${wiremockStatus}"
         } catch(Exceprion ex) {
             echo "Exception when checking connection to WireMock"
         }
         if(wiremockStatus ==  200) break
         else sh "sleep $(sleepTimeInSeconds}"
      }

      if(wiremockStatus != 200) {
          currentBuild.result = 'FAILURE'
          error 'WireMock server is unreachable. Return code: ${wiremockStatus}'
      }
}

private def getHttpRequestStatus() {
    def response = httpRequest "${env.WIREMOCK_ADDRESS}/__admin"
    return response.status

private extractHTTPSUrl() {
    env.GIT_WITHOUT_HTTPS = env.GIT_HTTPS.replace("https://", "")
}

return this</pre>
</div>
</div>
<div class="paragraph">
<p>stageInstallApplication.groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>def call() {
    stage('Install application with smoke tests environment') {
        dir(env.SEETEST_APPLICATION_FOLDER) {
            checkout([$class: 'GitSCM', branches: [[name: env.SEETEST_GIT_BRANCH]], doGenerateSubmoduleConfigurations: false, extensions: [], gitTool: 'default', submoduleCfg: [], userRemoteConfigs: [[credentialsId: env.GIT_CREDENTIALS, url: env.SEETEST_GIT_SSH]])
        }
     }
}

return this</pre>
</div>
</div>
<div class="paragraph">
<p>stageUITests.groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>def call() {
    stage('UI tests') {
        def utils = load "${env.SUBMODULES_DIR}/utils.groovy"

        try {
            utils.generateUserIDVariable(); //Generate USER_ID and USER_GROUP
            docker.image(env.SEETEST_DOCKER_IMAGE).inside("-u ${env.USER_ID}:${env.USER_GROUP}") {
                withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: "${env.ARTIFACTORY_USER_CREDENTIALS}", passwordVariable: 'ARTIFACTORY_PASSWORD', usernameVariable: 'ARTIFACTORY_USERNAME]]) {
                    executeTests()
                    compressArtifacts()
                    publishJUnitTestResultReport()
                    archiveArtifacts()
                    publishHTMLReports()
                    publishCucumberReports()
                 }
             }
        } catch (Exception exc) {
            throw exc
        }
   }
}

private executeTests() {
    withCredentials([usernamePassword(credentialsId: env.SEETEST_GRID_USER_CREDENTIALS, passwordVariable: 'GRID_USER_PASSWORD', usernameVariable: 'GRID_USER_NAME')]) {
            sh """
                cd ${env.SEETEST_PROJECT_HOME_ABSOLUTE_PATH}
                mvn clean test -B -Ddriver="grid" -Dtags="${env.SEETEST_CUCUMBER_TAG}" -DcloudName="${env.SEETEST_CLOUD_NAME}" -DdeviceQuery="${env.SEETEST_DEVICE_QUERY} -DgridUser="${GRID_USER_NAME}" -DgridPassword="${GRID_USER_PASSWORD}" -Dinstall="${env.SEETEST_INSTALL_APP}" -DiosUrl="${env.SEETEST_IOS_APP_URL}" -DdeviceType="iPhone" -DiosVersion="$env.SEETEST_IOS_VERSION}" -DparallelMode="allonall" -Denv="${env.SEETEST_APP_ENVIRONMENT}" site
             """
     }
}

private compressartifacts() {
    echo "Compressing artifacts from /target/site"
    sh """
        zip -r allure_report.zip **/${env.SEETEST_PROJECT_homE}/target/site
    """

private publishJUnitTestResultReport() {
    echo "Publishing JUnit reports from ${env.SEETEST_APPLICATION_FOLDER}/${env.SEETEST_PROJECT_HOME}/target/surefire-reports/junitreporters/*.xml"

    try {
        junit "${env.SEETEST_APPLICATION_FOLDER}/${env.SEETEST_PROJECT_HOME}/target/surefire-reports/junitreporters/*.xml"
    } catch(e) {
        echo("No JUnit report found")
    }
}

private archiveArtifacts() {
    echo "Archiving artifacts"

    try {
        archiveArtifacts allowEmptyArchive: true, artifacts: "**/allure_report.zip"
    } catch(e) {
        echo("No artifacts found")
    }
}

private publishHTMLReports() {
    echo "Publishing HTML reports from ${env.SEETEST_APPLICATION_FOLDER}/${env.SEETEST_PROJECT_HOME}/target/site/allure-maven-plugin"

    try {
        publishHTML([allowMissing: false, alwaysLinkToLastBuild: true, keepAll: true, reportDir: "${env.SEETEST_APPLICATION_FOLDER/${env.SEETEST_PROJECT_HOME}/target/site/allure-maven-plugin", reportFiles: 'index.html', reportName: 'Allure report', reportTitles: 'Allure report'])
    } catch(e) {
        echo("No artifacts found")
    }
}

private publishCucumberREPORTS() {
    echo "Publishing Cucumber reports from ${env.SEETEST_APPLICATION_FOLDER}/${env.SEETEST_PROJECT_HOME}/target/cucumber-parallel/*.json"

    try {
        step([$class: 'CucumberReportPublisher', fileExcludePattern '', fileIncludePattern: "#{env.SEETEST_APPLICATION_FOLDER}/${env.SEETEST_PROJECT_HOME}/target/cucumber-parallel/*.json", ignoreFailedTests: false, jenkinsBasePath: '', jsonReportDirectory: '', missingFails: false, parallelTesting: false, pendingFails: false, skippedFails: false, undefinedFails: false])
    } catch(e) {
        echo("No Cucumber report found")
    }
}

return this</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Configuration</strong></p>
</div>
<div class="paragraph">
<p>It is possible to configure Jenkins job in two ways. First one is to edit the Jenkinsfile. All of the properties are in properties collection as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>def properties = [

          JENKINS_LABELS                                : 'PWI_LINUX_DEV'

          ...

          //Docker
          ARTIFACTORY_USER_CREDENTIALS                  : 'ba2e4f46-56f1-4467-ae97-17b356d6s643',
          SEETEST_DOCKER_IMAGE                          : 'docker.XXX.com/app/base-images/seetest:v1-8.3',

          //SeeTest
          SEETEST_APPLICATION_FOLDER                    : 'seetest_dit',
          SEETEST_PROJECT_HOME                          : 'Automated_Scripts',
          SEETEST_GIT_SSH                               : 'ssh://stash.xxx.com/app/seetest_automation_cucumber.git',
          SEETEST_GIT_BRANCH                            : 'develop',

          ...
]</pre>
</div>
</div>
<div class="paragraph">
<p>Second way is to add properties in 'Configure job'. All of the properties there are overriding properties from Jenkinsfile (the have the highest priority). They can then be set durring 'Build with Paremeters' process.</p>
</div>
<div class="paragraph">
<p><strong>Reports</strong></p>
</div>
<div class="paragraph">
<p>After a job execution 'Allure report' and 'Cucumber-JVM' reports should be visible. If any tests fail, You can check on which screen (printscreen from failures is attached, why and etc.)</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
